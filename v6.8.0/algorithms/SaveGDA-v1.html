<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>SaveGDA v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SaveGEMMAUDParamFile v1" href="SaveGEMMAUDParamFile-v1.html" />
    <link rel="prev" title="SaveFullprofResolution v1" href="SaveFullprofResolution-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.8</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">SaveGDA v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="savegda-v1">
<span id="algm-savegda"></span><span id="algm-savegda-v1"></span><h1>SaveGDA v1<a class="headerlink" href="#savegda-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/ImageNotFound.png"><img alt="../_images/ImageNotFound.png" class="screenshot" src="../_images/ImageNotFound.png" style="width: 200px;" /></a>
<figcaption>
<p><span class="caption-text">Enable screenshots using DOCS_SCREENSHOTS in CMake</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id3">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id4">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id5">Description</a></p></li>
<li><p><a class="reference internal" href="#gda-format" id="id6">GDA Format</a></p></li>
<li><p><a class="reference internal" href="#d-to-tof-conversion" id="id7">D to TOF Conversion</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id8">Usage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id9">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Save a group of focused banks to the MAUD three-column GDA format</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="SaveBankScatteringAngles-v1.html#algm-savebankscatteringangles"><span class="std std-ref">SaveBankScatteringAngles</span></a>, <a class="reference internal" href="AlignDetectors-v1.html#algm-aligndetectors"><span class="std std-ref">AlignDetectors</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>InputWorkspace</p></td>
<td><p>Input</p></td>
<td><p>WorkspaceGroup</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>A GroupWorkspace where every sub-workspace is a single-spectra focused run corresponding to a particular bank</p></td>
</tr>
<tr class="row-odd"><td><p>OutputFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The name of the file to save to. Allowed extensions: [‘.gda’]</p></td>
</tr>
<tr class="row-even"><td><p>GSASParamFile</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>GSAS calibration file containing conversion factors from D to TOF. Allowed extensions: [‘.ipf’, ‘.prm’, ‘.parm’, ‘.iprm’]</p></td>
</tr>
<tr class="row-odd"><td><p>GroupingScheme</p></td>
<td><p>Input</p></td>
<td><p>int list</p></td>
<td></td>
<td><p>An array of bank IDs, where the value at element i is the ID of the bank in GSASParamFile to associate spectrum i with</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>Takes a WorkspaceGroup whose children are single-spectra workspaces
corresponding to focused banks, and saves them to the MAUD-readable
<code class="docutils literal notranslate"><span class="pre">.gda</span></code> format.</p>
</section>
<section id="gda-format">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">GDA Format</a><a class="headerlink" href="#gda-format" title="Permalink to this heading">¶</a></h2>
<p>GDA is a text-based format. The file is divided into sections for each
bank. Each section begins with a header, which has the following
format::</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">BANK</span> <span class="o">&lt;</span><span class="n">bank</span> <span class="n">number</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">points</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">lines</span><span class="o">&gt;</span> <span class="n">RALF</span> <span class="o">&lt;</span><span class="nb">min</span> <span class="n">TOF</span><span class="o">&gt;</span> <span class="mi">96</span> <span class="o">&lt;</span><span class="nb">min</span> <span class="n">TOF</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">resolution</span><span class="o">&gt;</span> <span class="n">ALT</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">bank</span> <span class="pre">number</span></code> is simply and index for the bank</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">of</span> <span class="pre">points</span></code> is the number of sets of data-points which will
be saved from this bank</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">of</span> <span class="pre">lines</span></code> is the number of lines the points will take
up. Since there are 4 points per line, this will be <code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">of</span>
<span class="pre">points</span> <span class="pre">/</span> <span class="pre">4</span></code>, rounded up</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">min</span> <span class="pre">TOF</span></code> is the minimum time-of-flight value in this bank</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resolution</span></code> is the mean difference between adjacent TOF-values
(normalised by TOF) in the bank</p></li>
</ul>
<p>The data then follows. We have 4 points per line, where each point
consists of three values, <code class="docutils literal notranslate"><span class="pre">TOF</span> <span class="pre">*</span> <span class="pre">32</span></code> (time-of-flight is scaled by 32
for legacy reasons in MAUD - see <a class="reference internal" href="#save-gda-tof"><span class="std std-ref">D to TOF Conversion</span></a> for a detailed
explanation of where the TOF values come from), <code class="docutils literal notranslate"><span class="pre">intensity</span> <span class="pre">*</span> <span class="pre">1000</span></code>
and <code class="docutils literal notranslate"><span class="pre">error</span> <span class="pre">*</span> <span class="pre">1000</span></code>. <code class="docutils literal notranslate"><span class="pre">TOF</span></code>, <code class="docutils literal notranslate"><span class="pre">intensity</span></code> and <code class="docutils literal notranslate"><span class="pre">error</span></code> correspond
to the <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">e</span></code> columns of a Mantid workspaces
respectively.</p>
<p>All numbers apart from resolution are saved as integers. In addition,
every line, including the header, must be exactly 80 characters long,
so any short lines are right-padded with spaces.</p>
</section>
<section id="d-to-tof-conversion">
<span id="save-gda-tof"></span><h2><a class="toc-backref" href="#id7" role="doc-backlink">D to TOF Conversion</a><a class="headerlink" href="#d-to-tof-conversion" title="Permalink to this heading">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>TOF values in the output file will only match the actual recorded
TOF values if the GSAS calibration file contains the correct
conversion factors for each bank.</p>
</div>
<p>SaveGDA takes input in D-spacing, and applies the GSAS conversion
(explained at <a class="reference internal" href="AlignDetectors-v1.html#algm-aligndetectors"><span class="std std-ref">AlignDetectors</span></a>), using
parameters from the calibration file, to convert back to
time-of-flight. The caveat here is that, if the calibration file
contains the wrong conversion factors, then the TOF values will not
match the ones that were actually recorded.</p>
<p>This is not necessarily a problem, as once the file is loaded into
MAUD, as long as the same conversion factors are used (ie the MAUD
calibration file should be created from the same GSAS calibration file
as was used to run SaveGDA), the data will still be aligned in
MAUD. When doing texture focusing with <a class="reference internal" href="../techniques/ISISPowder-GEM-v1.html#isis-powder-diffraction-gem-ref"><span class="std std-ref">ISIS_Powder for GEM</span></a>, matching up all the calibration
files should be taken care of automatically.</p>
<p>This approach is taken because it was impractical to create a MAUD
calibration file containing the correct conversion factors for a
workspace with a large number of banks - we just don’t have enough
data to do it. Instead we fake the time-of-flight recordings in order
to get good alignment in MAUD.</p>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Banks 1 to 4 of a previous texture focus in isis_powder</span>
<span class="c1"># We don&#39;t use the full 160 banks as the test becomes too slow</span>
<span class="n">input_group</span> <span class="o">=</span> <span class="n">Load</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="s2">&quot;GEM61785_D_texture_banks_1_to_4.nxs&quot;</span><span class="p">,</span>
                   <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s2">&quot;SaveGDAtest_GEM61785&quot;</span><span class="p">)</span>

<span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;defaultsave.directory&quot;</span><span class="p">],</span> <span class="s2">&quot;GEM61785.gda&quot;</span><span class="p">)</span>
<span class="n">SaveGDA</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">input_group</span><span class="p">,</span>
        <span class="n">OutputFilename</span><span class="o">=</span><span class="n">output_file</span><span class="p">,</span>
        <span class="n">GSASParamFile</span><span class="o">=</span><span class="s2">&quot;GEM_PF1_PROFILE.IPF&quot;</span><span class="p">,</span>
        <span class="c1"># Assign spectra 1, 2 and 3 to bank 2 in calib file, and spectrum 4 to bank 3</span>
        <span class="n">GroupingScheme</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">file_contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Print the header and the 4 lines from the middle of the file</span>
<span class="c1"># rstrip the header just to make the doctest script happy</span>
<span class="nb">print</span><span class="p">(</span><span class="n">file_contents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">104</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">file_contents</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>BANK 1 4246  1062 RALF  27388  96  27388 0.001 ALT
   40348    380   60   40388    285   52   40427    338   56   40467    218   47
   40507    232   49   40546    181   44   40586    171   43   40626    206   47
   40666    246   50   40706    161   40   40746    126   37   40786    124   37
   40826    131   40   40866    221   48   40906    157   40   40946    169   41
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/DataHandling/Text.html">DataHandling\Text</a> | <a class="reference external" href="categories/Diffraction/DataHandling.html">Diffraction\DataHandling</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/b75cfaae9218e7d59662138c22a81da96e2235c1/Framework/DataHandling/inc/MantidDataHandling/SaveGDA.h">SaveGDA.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/b75cfaae9218e7d59662138c22a81da96e2235c1/Framework/DataHandling/src/SaveGDA.cpp">SaveGDA.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="SaveFullprofResolution-v1.html" title="Previous Chapter: SaveFullprofResolution v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; SaveFullprofR...</span>
    </a>
  </li>
  <li>
    <a href="SaveGEMMAUDParamFile-v1.html" title="Next Chapter: SaveGEMMAUDParamFile v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">SaveGEMMAUDPa... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>