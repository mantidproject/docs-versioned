<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>PyChop</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Manage User Directories" href="../framework/ManageUserDirectories.html" />
    <link rel="prev" title="MSlice" href="MSlice.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.8</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Interfaces</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">PyChop</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="pychop">
<span id="id1"></span><h1>PyChop<a class="headerlink" href="#pychop" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id6">Overview</a></p></li>
<li><p><a class="reference internal" href="#options" id="id7">Options</a></p></li>
<li><p><a class="reference internal" href="#command-line-interface" id="id8">Command line interface</a></p></li>
<li><p><a class="reference internal" href="#theory" id="id9">Theory</a></p></li>
<li><p><a class="reference internal" href="#sample-contribution" id="id10">Sample contribution</a></p></li>
<li><p><a class="reference internal" href="#references" id="id11">References</a></p></li>
</ul>
</nav>
<figure class="align-right">
<a class="reference internal image-reference" href="../../_images/PyChopGui.png"><img alt="PyChopGui.png" src="../../_images/PyChopGui.png" style="width: 455px;" /></a>
</figure>
<section id="overview">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h2>
<p>PyChop is a tool to allow direct inelastic neutron scattering users to estimate
the inelastic resolution and incident flux for a given spectrometer setting.
Currently, the four direct geometry spectrometers at ISIS (LET, MAPS, MARI, and
MERLIN) and the four direct geometry spectrometers at SNS (ARCS, CNCS, HYSPEC,
SEQUOIA) are supported.</p>
<p>For MERLIN and LET, in addition, PyChop will also calculate the allowed Ei’s in
multi-rep mode, and plot the time-distance diagrams for the desired setting.</p>
</section>
<section id="options">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Options</a><a class="headerlink" href="#options" title="Permalink to this heading">¶</a></h2>
<p>First, the instrument, chopper slit packages (or instrument configurations for
LET) and chopper frequency(ies) have to be selected from the pull-down menus
(combo boxes). Then the user should enter the desired incident energy (or the Ei
to focus on for multi-rep operation) in the line edit box.</p>
<p>Clicking the <em>Calculate</em> button will cause PyChop to run the resolution and flux
calculations, which will take 1-2s and update the plots in the tabs on the right
hand side of the GUI. Alternatively, in the options menu, the user can select
the option of having the calculations run when enter (return) is pressed when
the focus is on the Ei line edit box.</p>
<p>If the <em>Hold current plot</em> check box is enabled (selected) then the resolution
vs energy plots will overplot the current axes.</p>
<p>If the <em>Show multi-reps</em> check box is enabled (selected) then the resolution vs
energy for all allowed Ei’s will be plotted on the current axes. This only
applies to LET or MERLIN with the G (gadolinium) chopper slit package.</p>
<p>In the <em>Flux-Ei</em> plot tab, there is a slider at the bottom and a line edit box
to allow the user to select the maximum x-range (incident energy range) to plot.
The plot updates when the slider or edit box is changed. To save computation
time, the flux / elastic resolution is only calculated at twenty incident energy
points from 0.1 meV to the maximum selected.</p>
<p>The flux and elastic resolution as a function of chopper frequency for the
specified Ei is shown in the <em>Flux-Freq</em> plot tab. If <em>Hold current plot</em> is
selected then several settings can be overplotted. The program will not overplot
if it detects that only the frequency has changed.</p>
<p>If the instrument is LET (or MERLIN with the G chopper), the time-distance plot
is enabled, and an additional option to change the phase of chopper 2 is
available. This chopper has a wide opening and can be used to suppress low
energy reps. The time delay which is specified in the chopper 2 phase edit box
is the time-of-flight in microseconds relative to the moderator pulse when the
chopper first opens.</p>
<p>If the <em>Instrument scientist mode</em> option is selected, a similar option is
enabled for MERLIN if the G chopper is used. In this case, the phase (time
delay) of the thick disk chopper can be adjusted. The time delay is the time-of-
flight at which the chopper slit first opens (sweeps across the beam profile).</p>
<p>The Matplotlib axes showing the calculated data have the standard toolbars.</p>
</section>
<section id="command-line-interface">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Command line interface</a><a class="headerlink" href="#command-line-interface" title="Permalink to this heading">¶</a></h2>
<p>In addition to the GUI, there is also a python commandline interface to PyChop.
This is encapsulated in the <code class="docutils literal notranslate"><span class="pre">Instrument</span></code> class within the <code class="docutils literal notranslate"><span class="pre">pychop.Instruments</span></code> module. Within
Mantid, to do a single point calculation of the flux and resolution</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pychop.Instruments</span> <span class="kn">import</span> <span class="n">Instrument</span>
<span class="n">resolution</span><span class="p">,</span> <span class="n">flux</span> <span class="o">=</span> <span class="n">Instrument</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">inst</span><span class="o">=</span><span class="s1">&#39;maps&#39;</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">frequency</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ei</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">etrans</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">550</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
</pre></div>
</div>
<p>The parameters are in order, so <code class="docutils literal notranslate"><span class="pre">Instrument.calculate('maps','a',500,600,range(0,550,50))</span></code>
also works.</p>
<p>To further simplify the use of <code class="docutils literal notranslate"><span class="pre">Instrument</span></code> for data modeling, the <cite>calculate</cite> function (only) allows for
<cite>etrans=’polynomial’</cite> parameter. If that is used, the energy transfer from <cite>-Ei</cite> to <cite>Ei</cite> with a step
of <cite>0.01Ei</cite> is used, then fitted to a cubic polynomial. The resolutoion resturned by the function is an array
with four elements, so the desired value can be recovered using</p>
<div class="math notranslate nohighlight">
\[res = resolution[0] + resolution[1]\Delta E + resolution[2]\Delta E^2 + resolution[3]\Delta E^3\]</div>
<p>In addition, an object orient interface is provided:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mapsres</span> <span class="o">=</span> <span class="n">Instrument</span><span class="p">(</span><span class="s1">&#39;maps&#39;</span><span class="p">)</span>
<span class="n">mapsres</span><span class="o">.</span><span class="n">setChopper</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">mapsres</span><span class="o">.</span><span class="n">setFrequency</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="n">mapsres</span><span class="o">.</span><span class="n">setEi</span><span class="p">(</span><span class="mi">600</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">mapsres</span><span class="o">.</span><span class="n">getResolution</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">550</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
</pre></div>
</div>
<p>In particular, the method <code class="docutils literal notranslate"><span class="pre">getResolution</span></code>, which takes the energy transfers to
calculate the resolution for as an input, can be directly passed to third party
programs for resolution convolution purposes.</p>
<p>For further help, use <code class="docutils literal notranslate"><span class="pre">help(Instrument)</span></code> after importing the class.</p>
</section>
<section id="theory">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Theory</a><a class="headerlink" href="#theory" title="Permalink to this heading">¶</a></h2>
<p>The energy resolution calculated by <code class="docutils literal notranslate"><span class="pre">PyChop</span></code> has contributions from the time
width of the moderator pulse <span class="math notranslate nohighlight">\(\tau_{\mathrm{mod}}\)</span>, the opening times of the
choppers, <span class="math notranslate nohighlight">\(\tau_{\mathrm{chop}}\)</span>, the response time of the detector,
<span class="math notranslate nohighlight">\(\tau_{\mathrm{det}}\)</span>, and the effect of the sample, <span class="math notranslate nohighlight">\(\tau_{\mathrm{sam}}\)</span>.
The first two contributions dominate so we will only concentrate on those.</p>
<p>The moderator time width is determined from fitting data above 100 meV to a
<span class="math notranslate nohighlight">\(\chi^2\)</span> distribution <a class="reference internal" href="#id2">[1]</a> which has a variance <span class="math notranslate nohighlight">\(\tau_{\mathrm{mod}}^2
=3/(\Sigma v)^2\)</span> where <span class="math notranslate nohighlight">\(\Sigma\)</span> is the macroscopic scattering cross-section
of the moderator and <span class="math notranslate nohighlight">\(v\)</span> is the neutron velocity. However, experimentally
it was found that this underestimates the widths at high energy <a class="reference internal" href="#id3">[2]</a>, so that a
modified form for the variance</p>
<div class="math notranslate nohighlight">
\[\tau_{\mathrm{mod}}^2 = \tau_0 + \frac{3}{(\Sigma v)^2}\]</div>
<p>is used in PyChop. In future versions, the moderator lineshape will be reparameterised
to use an Ikeda-Carpenter lineshape, which more accurately describes the ToF spectrum
at lower neutron energies.</p>
<p>The chopper time width is determined from the geometry of chopper and is given by
<a class="reference internal" href="#id3">[2]</a>, <a class="reference internal" href="#id4">[3]</a></p>
<div class="math notranslate nohighlight">
\[\begin{split}\tau_{\mathrm{chop}}^2 \left\{ \begin{array}{ll} \frac{(\Delta T)^2}{6}
\left[\frac{1-\gamma^4/10}{1-\gamma^2/6}\right] &amp; 0 \leq \gamma &lt; 1 \\
\frac{(\Delta T)^2}{6} \left[\frac{3}{5}
\frac{\gamma(\sqrt{\gamma}-2)^2(\sqrt{\gamma}+8)}{\sqrt{\gamma}+4}\right]
&amp; 1 \leq \gamma &lt; 4 \\
\mathrm{undefined} &amp; \gamma \geq 4 \end{array} \right.\end{split}\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rcl} \Delta T &amp;=&amp; \frac{p}{2R\omega} \\
\gamma &amp;=&amp; \frac{2R}{\Delta T} \left| \frac{1}{s} - \frac{1}{v} \right| \\
s &amp;=&amp; 2\omega\rho \end{array}\end{split}\]</div>
<p>and <span class="math notranslate nohighlight">\(p\)</span> is the width of the slits of the Fermi chopper, <span class="math notranslate nohighlight">\(R\)</span> is the radius
of the chopper package (assumed cylindrical), <span class="math notranslate nohighlight">\(\omega\)</span> is its rotation speed,
<span class="math notranslate nohighlight">\(v\)</span> is the neutron velocity and <span class="math notranslate nohighlight">\(\rho\)</span> is the curvature of Fermi chopper
slits.</p>
<p>The time variances above are defined at the moderator and chopper positions respectively.
As the neutron bunches travel towards the sample and detector they also spread out,
and the final time (energy) widths are determined by the geometry (distances) of the
instrument. Specifically, the relative energy width is given by the sum in quadrature
of each of the contributing time widths, which we will restrict here to the two major
terms, <span class="math notranslate nohighlight">\(\tau_{\mathrm{mod}}\)</span> and <span class="math notranslate nohighlight">\(\tau_{\mathrm{chop}}\)</span> <a class="reference internal" href="#id5">[4]</a>:</p>
<div class="math notranslate nohighlight">
\[\left( \frac{\Delta E}{E_i}\right )^2 =
\left[ 2\frac{\tau_{\mathrm{chop}}}{t_{\mathrm{chop}}} \left(1+\frac{l_0+l_1}{l_2}
\left(\frac{E_f}{E_i}\right)^{\frac{3}{2}} \right) \right]^2
+ \left[ 2\frac{\tau_{\mathrm{mod}}}{t_{\mathrm{chop}}} \left(1+\frac{l_1}{l_2}
\left(\frac{E_f}{E_i}\right)^{\frac{3}{2}} \right) \right]^2\]</div>
<p>where <span class="math notranslate nohighlight">\(t_{\mathrm{chop}}\)</span> is the time of arrival of the neutron bunch at the
Fermi (or final resolution disk) chopper, <span class="math notranslate nohighlight">\(l_0\)</span> is the moderator-chopper,
<span class="math notranslate nohighlight">\(l_1\)</span> the chopper-sample and <span class="math notranslate nohighlight">\(l_2\)</span> the sample-detector distance. <span class="math notranslate nohighlight">\(E_i\)</span>
and <span class="math notranslate nohighlight">\(E_f\)</span> are the incident and scattered neutron energies.</p>
<p>The flux is obtained from lookup tables of measured (white-beam) flux on each instrument.</p>
</section>
<section id="sample-contribution">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Sample contribution</a><a class="headerlink" href="#sample-contribution" title="Permalink to this heading">¶</a></h2>
<p>Although the contribution of a sample to the resolution of direct-geometry chopper spectrometers
is usually negligible,
it is currently included by calculating of the variance of the time-of-flight due to the size
of the sample.
So far only two shapes are supported: plate and thin annulus.
The broadening caused by a plate sample is calculated as proportional
to <span class="math notranslate nohighlight">\(\frac{1}{12} w^2\)</span>, where <span class="math notranslate nohighlight">\(w\)</span> is the width of the plate.
The factor <span class="math notranslate nohighlight">\(\frac{1}{12}\)</span> comes from the variance of a uniform distribution</p>
<div class="math notranslate nohighlight">
\[\int^{\frac{1}{2}}_{-\frac{1}{2}} x^2 dx = \frac{1}{12}\]</div>
<figure class="align-right">
<a class="reference internal image-reference" href="../../_images/Pychop-annulus-shape.png"><img alt="sample-annulus-variation.png" src="../../_images/Pychop-annulus-shape.png" style="width: 300px;" /></a>
</figure>
<p>For a thin annulus, the variation is proportional to its diameter.
The fractional factor is calculated as the following variance</p>
<div class="math notranslate nohighlight">
\[\frac{ \int^{\frac{1}{2}}_{-\frac{1}{2}} x^2 \rho(x) dx } {\int \rho(x) dx}\]</div>
<p>Here <span class="math notranslate nohighlight">\(x= r \cos\theta = \frac{1}{2} \cos\theta\)</span>.
<span class="math notranslate nohighlight">\(\rho(x)\)</span> is the (unnormalized) distribution function,
which is proportional <span class="math notranslate nohighlight">\(\frac{1}{\sin\theta}\)</span>.
So the integration evaluates to</p>
<div class="math notranslate nohighlight">
\[\frac{ \int_{0}^{\pi} x^2 d\theta } {\int d\theta} = \frac{1}{8}\]</div>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h2>
<p id="id2">[1] <a class="reference external" href="http://www.neutronresearch.com/parch/1993/01/199301013280.pdf">RAL-94-025: The resolution function of the chopper spectrometer HET at ISIS,
T G Perring, Proceedings of ICANS XII (1993)</a></p>
<p id="id3">[2] RALT-028-94: High energy magnetic excitations in hexagonal cobalt,
T G Perring, Ph.D. Thesis, University of Cambridge (1991)</p>
<p id="id4">[3] <a class="reference external" href="http://dx.doi.org/10.1016/0029-554X(59)90066-7">M. Marseguerra and G. Pauli, Neutron transmission probability through a
curved revolving slit, Nucl. Inst. Meth. 4 (1959) 140</a></p>
<p id="id5">[4] RAL-85-052: MARS - A Multi-Angle Rotor Spectrometer for the SNS,
C J Carlile, A D Taylor and W G Williams (1985)</p>
<p><strong>Category</strong>: <a class="reference external" href="../ILL/categories/Interfaces.html">Interfaces</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="MSlice.html" title="Previous Chapter: MSlice"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; MSlice</span>
    </a>
  </li>
  <li>
    <a href="../framework/ManageUserDirectories.html" title="Next Chapter: Manage User Directories"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Manage User D... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>