<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>SANSTubeCalibration v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css?v=fadd4351" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=77160d70" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script src="../_static/documentation_options.js?v=770b529d"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SANSTubeMerge v1" href="SANSTubeMerge-v1.html" />
    <link rel="prev" title="SANSSubtract v1" href="SANSSubtract-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.10</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">SANSTubeCalibration v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="sanstubecalibration-v1">
<span id="algm-sanstubecalibration"></span><span id="algm-sanstubecalibration-v1"></span><h1>SANSTubeCalibration v1<a class="headerlink" href="#sanstubecalibration-v1" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<span id="index-0"></span><p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id1">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id2">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id3">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id4">Description</a></p></li>
<li><p><a class="reference internal" href="#loading-and-merging-the-input-data" id="id5">Loading and Merging the Input Data</a></p></li>
<li><p><a class="reference internal" href="#finding-the-correct-pixel-locations" id="id6">Finding the Correct Pixel Locations</a></p></li>
<li><p><a class="reference internal" href="#correcting-the-detector-pixel-locations" id="id7">Correcting the Detector Pixel Locations</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id8">Usage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id9">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>Calibrates the tubes on the ISIS Sans2d Detector.</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id2" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="SANSTubeMerge-v1.html#algm-sanstubemerge"><span class="std std-ref">SANSTubeMerge</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Link to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>StripPositions</p></td>
<td><p>Input</p></td>
<td><p>int list</p></td>
<td><p>1040,920,755,590,425,260,95,5</p></td>
<td><p>Which strip positions were used.</p></td>
</tr>
<tr class="row-odd"><td><p>DataFiles</p></td>
<td><p>Input</p></td>
<td><p>str list</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The run files corresponding to the strip positions that were used.</p></td>
</tr>
<tr class="row-even"><td><p>StripWidth</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>38</p></td>
<td><p>The width of the strip being used for calibration, in mm.</p></td>
</tr>
<tr class="row-odd"><td><p>StripToTubeCentre</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>21</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>EncoderAtBeamCentre</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>270</p></td>
<td><p>The position of the encoder at beam centre.</p></td>
</tr>
<tr class="row-odd"><td><p>EncoderAtBeamCentreForRear260Strip</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>470</p></td>
<td><p>Encoder at beam centre position for the 260 strip on the rear detector.This is used for rear detector calibration only.</p></td>
</tr>
<tr class="row-even"><td><p>RearDetector</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Whether to use the front or rear detector.</p></td>
</tr>
<tr class="row-odd"><td><p>Threshold</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>600</p></td>
<td><p>The count value that we assume distinguishes between a strip and non-strip region in the data. This is used for finding the locations of the strip edges. Counts above the threshold are assumed to be non-strip regions, and vice versa.</p></td>
</tr>
<tr class="row-even"><td><p>SkipTubesOnError</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Whether to skip calibration of tubes that we could not find the correct number ofedges for, or where another error has occurred during calibration. If set to False thenthe algorithm will terminate when it encounters a tube that cannot be calibrated.</p></td>
</tr>
<tr class="row-odd"><td><p>Margin</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>25</p></td>
<td><p>Region around the peak (in pixels) that is used for the peak fitting step</p></td>
</tr>
<tr class="row-even"><td><p>StartingPixel</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>20</p></td>
<td><p>Lower bound of detector’s active region</p></td>
</tr>
<tr class="row-odd"><td><p>EndingPixel</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>495</p></td>
<td><p>Upper bound of detector’s active region</p></td>
</tr>
<tr class="row-even"><td><p>FitEdges</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Fits the full edge of a shadow, instead of just the top and bottom.</p></td>
</tr>
<tr class="row-odd"><td><p>Timebins</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>5000,93000,98000</p></td>
<td><p>Time of flight bins to use</p></td>
</tr>
<tr class="row-even"><td><p>Background</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>2500</p></td>
<td><p>The baseline below the mesa for FlatTopPeak fitting</p></td>
</tr>
<tr class="row-odd"><td><p>VerticalOffset</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>-0.005</p></td>
<td><p>Estimate of how many metres off-vertical the strip is at the bottom of the detector. Negative if strips are more to the left at the bottom than the top of cylindrical Y plot.</p></td>
</tr>
<tr class="row-even"><td><p>CValueThreshold</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>6</p></td>
<td><p>A notification will be logged for any tubes with a cvalue (average resolution) above this threshold when the calibration has completed.</p></td>
</tr>
<tr class="row-odd"><td><p>CValueOutputFile</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td></td>
<td><p>The location for saving a .txt file with the details of tubes that have a cvalue above the threshold. If no filepath is provided, or if all tubes are within the threshold, then no file is created. Allowed values: [‘txt’]</p></td>
</tr>
<tr class="row-even"><td><p>OutputFile</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td></td>
<td><p>The location to save the calibration result out to as a Nexus file. Allowed values: [‘nxs’]</p></td>
</tr>
<tr class="row-odd"><td><p>SaveIntegratedWorkspaces</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td></td>
<td><p>If specified, the input workspaces will be saved to this directory after loading and integrating.This location will also be searched, along with your Mantid user directories, to find previously saved input workspace when loading.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Link to this heading">¶</a></h2>
<p>This algorithm calibrates the individual pixels for either the front or rear detector of the Sans2d instrument at ISIS.
The <code class="docutils literal notranslate"><span class="pre">DataFiles</span></code> property takes a list of file names, each one containing scattering data from H2O, which is a constant intensity 2D image, but masked by a vertical strip beamstop held at a different location in front of the detector.
Since the strip is a straight vertical line, the image of the strip onto the detector should be a straight vertical line, after calibration of the pixels of the detector.
The list of strip positions that each data file corresponds to is passed to the <code class="docutils literal notranslate"><span class="pre">StripPositions</span></code> property.
The algorithm uses this information to find the correct detector pixel positions and outputs a workspace with the detector pixels in these calibrated positions.
Once separate front and rear detector calibration files have been saved from this algorithm, <a class="reference internal" href="SANSTubeMerge-v1.html#algm-sanstubemerge"><span class="std std-ref">SANSTubeMerge v1</span></a> can be used to merge these into a single calibration file.</p>
</section>
<section id="loading-and-merging-the-input-data">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Loading and Merging the Input Data</a><a class="headerlink" href="#loading-and-merging-the-input-data" title="Link to this heading">¶</a></h2>
<p>The algorithm attempts to load all the data files by checking a number of locations to ensure that loading is as fast as possible. If a matching workspace can be found in the ADS, then this will be used.
If not, the algorithm checks the locations in your Mantid user directories to find and load any input files that were previously saved by the algorithm.
Finally, if nothing has been found, then the data is loaded from the archive and rebinned to convert it to histogram data. The value of the <code class="docutils literal notranslate"><span class="pre">Timebins</span></code> property provides the rebinning parameters for this step.</p>
<p>If property <code class="docutils literal notranslate"><span class="pre">SaveIntegratedWorkspaces</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, then any data that needed to be loaded and rebinned will be saved to the user’s default save location (with prefix <code class="docutils literal notranslate"><span class="pre">tubeCalibSaved_</span></code>) to allow for faster loading in future.</p>
<p>As part of loading, each dataset is cropped to extract only the data for the Sans2d detector that we are calibrating.
Each dataset is then scaled relative to the first dataset in the list, using the relative <code class="docutils literal notranslate"><span class="pre">proton_charge_by_period</span></code> log values as the scale factor.</p>
<p>The algorithm merges each individual dataset into a single workspace containing all of the vertical strips. The workspace containing the merged data will appear in the ADS with name <code class="docutils literal notranslate"><span class="pre">original</span></code>.</p>
</section>
<section id="finding-the-correct-pixel-locations">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Finding the Correct Pixel Locations</a><a class="headerlink" href="#finding-the-correct-pixel-locations" title="Link to this heading">¶</a></h2>
<p>Each detector tube is calibrated in turn using the merged dataset. The first step is to find the approximate pixel locations of the strip edges in the data for the given tube.
The counts in the data should be very low where the strips are located, so should change from high to low at the left edge of each strip and from low to high at the right edge.
The <code class="docutils literal notranslate"><span class="pre">Threshold</span></code> property is used to find the estimated pixel locations. It defines the count value above which we assume we are in a non-strip region in the data, and below which we assume we are in a strip region.
A threshold should be chosen that results in the same number of estimated edges as known strip edges, however it won’t always be possible to find a value that works for all tubes.
Once the best possible value is chosen, the property <code class="docutils literal notranslate"><span class="pre">SkipTubesOnError</span></code> can be selected to force the algorithm to calibrate all tubes that it can and skip any that it cannot.</p>
<p>Next, a fitting function is used to fit the peak positions in each tube, using the estimated strip edge pixel locations as the peak centres.
By default, the algorithm uses the <code class="docutils literal notranslate"><span class="pre">FlatTopPeak</span></code> fitting function for peak finding, however if the <code class="docutils literal notranslate"><span class="pre">FitEdges</span></code> property is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> then function <a class="reference internal" href="../fitting/fitfunctions/EndErfc.html#func-enderfc"><span class="std std-ref">EndErfc</span></a> is used instead.
A quadratic fitting function is then used to compare the known positions with the fitted positions from the data and give the position error for each detector pixel in the tube.
This position error is then used to calculate the corrected position for each detector pixel.</p>
</section>
<section id="correcting-the-detector-pixel-locations">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Correcting the Detector Pixel Locations</a><a class="headerlink" href="#correcting-the-detector-pixel-locations" title="Link to this heading">¶</a></h2>
<p>Once the corrected pixel positions have been calculated for all tubes, <a class="reference internal" href="ApplyCalibration-v1.html#algm-applycalibration"><span class="std std-ref">ApplyCalibration</span></a> is called to move all the detector pixels in the workspace to their correct positions.
On completion of the calibration, there will be a workspace in the ADS called <code class="docutils literal notranslate"><span class="pre">result</span></code> that contains these corrected detector positions.
If a value has been provided for the <code class="docutils literal notranslate"><span class="pre">OutputFile</span></code> property, then this workspace is automatically saved out as a Nexus file to the specified location.</p>
<p>A workspace called <code class="docutils literal notranslate"><span class="pre">cvalues</span></code> gives the average resolution of the fit parameter for each tube, giving an indication of the quality of the calibration.
When the algorithm completes, a notice will be printed in the messages pane for any tube with an average resolution greater than the value specified in the <code class="docutils literal notranslate"><span class="pre">CValueThreshold</span></code> property. These tubes are considered to have a poor quality calibration.
This list can be written out to a text file by passing a filepath to the <code class="docutils literal notranslate"><span class="pre">CValueOutputFile</span></code> property.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">SkipTubesOnError</span></code> was set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, then warnings will be printed when the algorithm completes detailing any tubes that were not calibrated and stating the reasons why.</p>
<p>A number of other diagnostic workspaces are output to the ADS during the calibration. These allow closer inspection of the results from the fitting and other calibration steps for each tube.
They provide the following information:</p>
<ul class="simple">
<li><p>Fit – the data from the peak fitting</p></li>
<li><p>Tube – the count data for the tube</p></li>
<li><p>Data – the fitted positions for the tube</p></li>
<li><p>Shift – how much the detector pixels have been shifted for the tube</p></li>
</ul>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>Calibrate the Sans2d rear detector:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># import mantid algorithms</span>
<span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">SANSTubeCalibration</span><span class="p">(</span>
    <span class="n">StripPositions</span><span class="o">=</span><span class="p">[</span><span class="mi">920</span><span class="p">,</span> <span class="mi">755</span><span class="p">,</span> <span class="mi">590</span><span class="p">,</span> <span class="mi">425</span><span class="p">,</span> <span class="mi">260</span><span class="p">],</span>
    <span class="n">DataFiles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;SANS2D00069117.nxs&quot;</span><span class="p">,</span> <span class="s2">&quot;SANS2D00069118.nxs&quot;</span><span class="p">,</span> <span class="s2">&quot;SANS2D00069119.nxs&quot;</span><span class="p">,</span> <span class="s2">&quot;SANS2D00069120.nxs&quot;</span><span class="p">,</span> <span class="s2">&quot;SANS2D00069116.nxs&quot;</span><span class="p">],</span>
    <span class="n">EncoderAtBeamCentre</span><span class="o">=</span><span class="mf">270.0</span><span class="p">,</span>
    <span class="n">EncoderAtBeamCentreForRear260Strip</span><span class="o">=</span><span class="mf">470.0</span><span class="p">,</span>
    <span class="n">RearDetector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">Threshold</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre></div>
</div>
<p>The original instrument view:</p>
<a class="reference internal image-reference" href="../_images/SANSTubeCalibration_original.png"><img alt="original layout of Sans2d instrument" class="align-center" src="../_images/SANSTubeCalibration_original.png" style="width: 635px;" /></a>
<p>The instrument view after running the calibration:</p>
<a class="reference internal image-reference" href="../_images/SANSTubeCalibration_calibrated.png"><img alt="calibrated layout of Sans2d instrument" class="align-center" src="../_images/SANSTubeCalibration_calibrated.png" style="width: 635px;" /></a>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/SANS/Calibration.html">SANS\Calibration</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Link to this heading">¶</a></h2>
<p>Python: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/1b00e0b0644260219c488cf4142569b296f21ab0/Framework/PythonInterface/plugins/algorithms/WorkflowAlgorithms/SANS/SANSTubeCalibration.py">SANSTubeCalibration.py</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="SANSSubtract-v1.html" title="Previous Chapter: SANSSubtract v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; SANSSubtract v1</span>
    </a>
  </li>
  <li>
    <a href="SANSTubeMerge-v1.html" title="Next Chapter: SANSTubeMerge v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">SANSTubeMerge v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>