<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IntegratePeaksSkew v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css?v=fadd4351" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=77160d70" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script src="../_static/documentation_options.js?v=770b529d"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="IntegratePeaksUsingClusters v1" href="IntegratePeaksUsingClusters-v1.html" />
    <link rel="prev" title="IntegratePeaksShoeboxTOF v1" href="IntegratePeaksShoeboxTOF-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.10</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">IntegratePeaksSkew v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="integratepeaksskew-v1">
<span id="algm-integratepeaksskew"></span><span id="algm-integratepeaksskew-v1"></span><h1>IntegratePeaksSkew v1<a class="headerlink" href="#integratepeaksskew-v1" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<span id="index-0"></span><p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id8">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id9">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id10">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id11">Description</a></p></li>
<li><p><a class="reference internal" href="#assumptions-about-the-instrument" id="id12">Assumptions about the instrument</a></p></li>
<li><p><a class="reference internal" href="#peak-mask-validation" id="id13">Peak mask validation</a></p>
<ul>
<li><p><a class="reference internal" href="#integration-of-peaks-on-the-edge-of-a-detector" id="id14">Integration of peaks on the edge of a detector</a></p></li>
<li><p><a class="reference internal" href="#vacancies" id="id15">Vacancies</a></p></li>
<li><p><a class="reference internal" href="#peak-size-and-shape" id="id16">Peak size and shape</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#finding-nearby-peaks" id="id17">Finding nearby peaks</a></p></li>
<li><p><a class="reference internal" href="#plotting" id="id18">Plotting</a></p></li>
<li><p><a class="reference internal" href="#useage" id="id19">Useage</a></p></li>
<li><p><a class="reference internal" href="#references" id="id20">References</a></p></li>
<li><p><a class="reference internal" href="#source" id="id21">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>Integrates single-crystal peaks in a MatrixWorkspace by identifying the peak pixels in a window on the detector by minimising the skew of the points in the background. The TOF extent of the peak is determined by maximising I/<span class="math notranslate nohighlight">\(\sigma\)</span> for the peak pixels identified using the skew method.</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="IntegratePeaksMD-v2.html#algm-integratepeaksmd"><span class="std std-ref">IntegratePeaksMD</span></a>, <a class="reference internal" href="IntegrateEllipsoids-v3.html#algm-integrateellipsoids"><span class="std std-ref">IntegrateEllipsoids</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Link to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>InputWorkspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>A MatrixWorkspace to integrate (x-axis must be TOF or d-Spacing).</p></td>
</tr>
<tr class="row-odd"><td><p>PeaksWorkspace</p></td>
<td><p>Input</p></td>
<td><p>IPeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>A PeaksWorkspace containing the peaks to integrate.</p></td>
</tr>
<tr class="row-even"><td><p>NRows</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>17</p></td>
<td><p>Number of row components in the window around a peak on the detector. For WISH row components correspond to pixels along a single tube.</p></td>
</tr>
<tr class="row-odd"><td><p>NCols</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>17</p></td>
<td><p>Number of column components in the window around a peak on the detector. For WISH column components correspond to tubes.</p></td>
</tr>
<tr class="row-even"><td><p>BackscatteringTOFResolution</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.04</p></td>
<td><p>dTOF/TOF of window for peaks at back-scattering (resolution dominated by moderator contribution, dT0/T0, and uncertainty in path length dL/L which is assumed constant for all pixels).</p></td>
</tr>
<tr class="row-odd"><td><p>ThetaWidth</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.1</p></td>
<td><p>dTheta resolution in degrees (estimated from width at forward scattering minus contribution from moderator, dT0/T0, and path length dL/L). To use a constant fractional TOF width for all peaks set ThetaWidth = 0.</p></td>
</tr>
<tr class="row-even"><td><p>ScaleThetaWidthByWavelength</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>If true the ThetaWidth will be multiplied by the wavelength of a peak. If the ThetaWidth is dominated by the beam divergence, which is proportional to wavelength, set this to true.</p></td>
</tr>
<tr class="row-odd"><td><p>GetTOFWindowFromBackToBackParams</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>If true the TOF window will be taken to be NFWHM x FWHM of the BackToBackExponential peak at that position (evaluated using coefficients defined in the instrument Parameters.xml file.</p></td>
</tr>
<tr class="row-even"><td><p>NFWHM</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>4</p></td>
<td><p>Initial TOF window is NFWHM x FWHM of the BackToBackExponential peak at that position</p></td>
</tr>
<tr class="row-odd"><td><p>OptimiseXWindowSize</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>If True the size of the xWindow will be optimised to maximise I/Sigma. If False the xwindow will be translated to maximise I/sigma in region +/- 2(initial_xwindow)</p></td>
</tr>
<tr class="row-even"><td><p>ThresholdIoverSigma</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0</p></td>
<td><p>Threshold I/sigma before optimising x window size.</p></td>
</tr>
<tr class="row-odd"><td><p>OptimiseMask</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Redo peak mask using optimal TOF window discovered (the original mask is found from the integrated intensity over a TOF window determined from the resolution parameters). A new optimal TOF window is then found using the new peak mask.Note this can be helpful if resolution parameters or peak centres are not very accurate.</p></td>
</tr>
<tr class="row-even"><td><p>IntegrateIfOnEdge</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Integrate peaks that contain pixels on edge of the detector.</p></td>
</tr>
<tr class="row-odd"><td><p>NRowsEdge</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>Masks including pixels on rows NRowsEdge from the detector edge are defined as on the edge.</p></td>
</tr>
<tr class="row-even"><td><p>NColsEdge</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>Masks including pixels on cols NColsEdge from the detector edge are defined as on the edge.</p></td>
</tr>
<tr class="row-odd"><td><p>NPixMin</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>3</p></td>
<td><p>Minimum number of pixels contributing to a peak</p></td>
</tr>
<tr class="row-even"><td><p>DensityPixMin</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.35</p></td>
<td><p>Minimum density of peak pixels in bounding box</p></td>
</tr>
<tr class="row-odd"><td><p>NRowMax</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>15</p></td>
<td><p>Maximum number of rows in peak mask (note on WISH rows are equivalent to pixels).</p></td>
</tr>
<tr class="row-even"><td><p>NColMax</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>15</p></td>
<td><p>Maximum number of columns in peak mask (note on WISH cols are equivalent to tubes).</p></td>
</tr>
<tr class="row-odd"><td><p>NVacanciesMax</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0</p></td>
<td><p>Maximum number of vacancies (contiguous regions of non-peak pixels entirely contained within the peak mask) for a valid peak.</p></td>
</tr>
<tr class="row-even"><td><p>NPixPerVacancyMin</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>Minimum number of pixels in a vacancy</p></td>
</tr>
<tr class="row-odd"><td><p>NTOFBinsMin</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>4</p></td>
<td><p>Minimum number of TOF bins in a peak</p></td>
</tr>
<tr class="row-even"><td><p>UseNearestPeak</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Find nearest peak pixel if peak position is in a background pixel.</p></td>
</tr>
<tr class="row-odd"><td><p>UpdatePeakPosition</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>If True then the peak position will be updated to be the detid with the largest integrated counts over the optimised TOF window, and the peak TOF will be taken as the maximum of the focused data in the TOF window.</p></td>
</tr>
<tr class="row-even"><td><p>OutputFile</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td></td>
<td><p>Optional file path in which to write diagnostic plots (note this will slow the execution of algorithm). Allowed extensions: [‘.pdf’]</p></td>
</tr>
<tr class="row-odd"><td><p>LorentzCorrection</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Correct the integrated intensity by multiplying by the Lorentz factor sin(theta)^2 / lambda^4 - do not do this if the data have already been corrected.</p></td>
</tr>
<tr class="row-even"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p>IPeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The output PeaksWorkspace will be a copy of the input PeaksWorkspace with the integrated intensities.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Link to this heading">¶</a></h2>
<p>IntegratePeaksSkew is an algorithm that integrates single-crystal Bragg peaks in a <a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a>
by identifying the detectors and bins that contribute to a peak by minimising the skew (third moment) of the points in
the background.</p>
<p>The algorithm is inspired by seed-skew integration methods for peaks on image plates used in monochromatic x-ray
instruments <a class="footnote-reference brackets" href="#id5" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. The seed-skew method <a class="footnote-reference brackets" href="#id5" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> has previously been directly applied to 3D Bragg peaks from TOF neutron Laue
data <a class="footnote-reference brackets" href="#id6" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>, however it has been noted that skew methods typically underestimate the intensity of weak reflections
(due to premature termination of the seed growth) - a systematic effect that is expected to be worse for 3D Bragg peaks.</p>
<p>In order to improve the performance and more accurately integrate weak reflections a different approach is used here:
data are integrated over an initial TOF (or d-spacing) window in order to maximise the signal-to-noise and then a 2D
peak mask is determined to find the detectors contributing to the peak; data in these detectors are then focused (and a
background subtracted) before applying the same method to identify the bins that contribute to the peak in the focused
spectrum. The full TOF (or d-spacing) extent of the peak is determined by maximising <span class="math notranslate nohighlight">\(I/\sigma\)</span> (similar to
integration methods for step-scans with monochromatic x-rays <a class="footnote-reference brackets" href="#id7" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>) starting from a seed of bins identified using the
skew method. The user can then optionally use the optimal TOF  (or d-spacing)  extent to repeat the procedure to find
the detectors contributing to the peak.</p>
<p>Technically this algorithm does not use the seed-skew algorithm to grow an initial seed, rather non-background points
are found by minimising the skew of the background, subsequently nearest-neighbour connected regions are found in the
non-background points and a single region is assigned to the peak (by proximity to the expected peak position).</p>
<p>Note this algorithm can apply the Lorentz correction to the integrated intensity if <code class="docutils literal notranslate"><span class="pre">LorentzCorrection=True</span></code>.</p>
<p>For each peak the algorithm proceeds as follows:</p>
<ol class="arabic">
<li><p>Calculates an initial TOF (or d-spacing) window evaluating a resolution function for the fractional width
(which is the same for TOF and d-spacing) of the form</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[\frac{dTOF}{TOF} = \sqrt{(\cot(\theta)d\theta)^2 + \left(\frac{dt_0}{t_0}\right)^2 + \left(\frac{dL}{L}\right)^2}\]</div>
</div></blockquote>
<p>where <span class="math notranslate nohighlight">\(dTOF\)</span> refers to the integration window size rather than the FWHM of a peak, the parameter
<code class="docutils literal notranslate"><span class="pre">BackscatteringTOFResolution</span></code> is the fractional window size (<span class="math notranslate nohighlight">\(dTOF/TOF\)</span>) of a peak at backscattering
(equivalent to <span class="math notranslate nohighlight">\(\sqrt{(\frac{dt_0}{t_0})^2 + (\frac{dL}{L})^2}\)</span>) and <code class="docutils literal notranslate"><span class="pre">ThetaWidth</span></code> <span class="math notranslate nohighlight">\(= d\theta\)</span>
(which is adjusted to reproduce the window size required for peaks at larger scattering angles). Note that for
that for instances when the angular resolution is dominated by the beam divergence, it is possible to scale
<span class="math notranslate nohighlight">\(= d\theta\)</span> by the wavelength by setting <code class="docutils literal notranslate"><span class="pre">ScaleThetaWidthByWavelength</span> <span class="pre">=</span> <span class="pre">True</span></code> (to account for the wavelength
dependence of the divergence). After execution the algorithm will print to the log estimates for these parameters
given the scattering angle dependence of the final TOF window found for the peaks successfully integrated.</p>
</li>
<li><p>Integrate the data over the range <span class="math notranslate nohighlight">\(TOF_{peak} \pm 0.5*dTOF\)</span></p></li>
<li><p>Find the detectors contributing to the background by minimising the skew of the integrated intensity of detectors in
a rectangular window of dimensions <code class="docutils literal notranslate"><span class="pre">NRow</span> <span class="pre">x</span> <span class="pre">NCol</span></code>.</p></li>
<li><p>Take the peak mask (detectors which contribute to the peak) to be the contiguous region of nearest-neighbour
connected detectors not contributing to the background that contains the peak detector ID
(or if <code class="docutils literal notranslate"><span class="pre">UseNearest=True</span></code> then it will be the nearest region).</p></li>
<li><p>Focuses the data (in TOF) for detectors assigned to the peak subtracting the spectra from a shell of
adjacent background pixels. This has the added benefit of roughly subtracting powder lines (if the detectors are
close enough for powder lines to roughly line up in TOF when averaged over the mask/shell).</p></li>
<li><p>Find the bins in the focused spectrum contributing to the peak by minimising the skew in the TOF window.</p></li>
<li><p>Increase the TOF window until the ratio of <span class="math notranslate nohighlight">\(I/\sigma\)</span> reaches a maximum.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">OptimiseMask=True</span></code> then steps 3-7 will be repeated using the optimal TOF window to find the detectors
contributing to the peak.</p></li>
<li><p>The bins contributing to the peak in the focused spectrum are summed (with the errors added in quadrature).</p></li>
</ol>
</section>
<section id="assumptions-about-the-instrument">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Assumptions about the instrument</a><a class="headerlink" href="#assumptions-about-the-instrument" title="Link to this heading">¶</a></h2>
<p>This algorithm supports instruments with detector banks of two types: <a class="reference internal" href="../concepts/RectangularDetector.html#rectangulardetector"><span class="std std-ref">RectangularDetector</span></a>
(e.g. SXD, TOPAZ) and a more generic type <code class="docutils literal notranslate"><span class="pre">CompAssembly</span></code> (e.g WISH) - for which the behaviour of the algorithm is
slightly different.</p>
<p>For <a class="reference internal" href="../concepts/RectangularDetector.html#rectangulardetector"><span class="std std-ref">RectangularDetector</span></a> the window around the peak on the detector is truncated at the
window edge - it is assumed that banks are not adjacent and that a peak can only reside in a single bank.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">CompAssembly</span></code> banks, if the window on the detector exceed the boundaries of a bank, the algorithm will look for
pixels in nearby banks for which the column components are adjacent. For example on WISH the column components are tubes,
if a tube on one bank is adjacent to a tube from another bank the detector window will include pixels from both banks
(it will not be truncated). The algorithm does not look for pixels in tubes above/below the top/bottom of a tube.</p>
<p>In addition the instrument definition for <code class="docutils literal notranslate"><span class="pre">CompAssembly</span></code> banks must obey the following rules (which hold for the
WISH instrument):</p>
<ol class="arabic simple">
<li><p>Row and column components must have names that end with an integer index (e.g. <code class="docutils literal notranslate"><span class="pre">pixel066</span></code> and <code class="docutils literal notranslate"><span class="pre">tube152</span></code>).</p></li>
<li><p>The index must start from 1 (i.e. the first tube in a bank would be <code class="docutils literal notranslate"><span class="pre">tube001</span></code> not <code class="docutils literal notranslate"><span class="pre">tube000</span></code>)</p></li>
<li><p>Any n-1 detector-spectrum mapping groups only row components (i.e. pixels in the same tube) - in this case
<code class="docutils literal notranslate"><span class="pre">NRow</span></code> will correspond to the number of spectra along a tube.</p></li>
</ol>
</section>
<section id="peak-mask-validation">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Peak mask validation</a><a class="headerlink" href="#peak-mask-validation" title="Link to this heading">¶</a></h2>
<p>The algorithm includes several parameters that allow the peak mask (detectors contributing to the peak) to be
validated before advancing to step 5.</p>
<section id="integration-of-peaks-on-the-edge-of-a-detector">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Integration of peaks on the edge of a detector</a><a class="headerlink" href="#integration-of-peaks-on-the-edge-of-a-detector" title="Link to this heading">¶</a></h3>
<p>To integrate peaks for which the peak mask includes pixels on the edge of the detector bank set <code class="docutils literal notranslate"><span class="pre">IntegrateIfOnEdge=True</span></code>.</p>
</section>
<section id="vacancies">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Vacancies</a><a class="headerlink" href="#vacancies" title="Link to this heading">¶</a></h3>
<p>Defined as regions of background pixels entirely enclosed within the peak mask - examples of vacancies are shown below.
If more than <code class="docutils literal notranslate"><span class="pre">NVacanciesMax</span></code> vacancies are found with a number of pixels greater than or equal to
<code class="docutils literal notranslate"><span class="pre">NPixPerVacancyMin</span></code> then the peak is not integrated.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/PeakMaskValidation.png"><img alt="Peak mask (white crosses) for a window on the detector showing vacancies (red boxes) of 1 and 2 pixels.# ``NRow`` and ``NCol`` are the lengths of the bounding box (dashed white line)." src="../_images/PeakMaskValidation.png" style="width: 50%;" /></a>
</figure>
</section>
<section id="peak-size-and-shape">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Peak size and shape</a><a class="headerlink" href="#peak-size-and-shape" title="Link to this heading">¶</a></h3>
<p>The minimum number of pixels allowed for a peak is set using the parameter <code class="docutils literal notranslate"><span class="pre">NPixMin</span></code>.</p>
<p>Limits on the peak size can be set with parameters <code class="docutils literal notranslate"><span class="pre">NColMax</span></code> and <code class="docutils literal notranslate"><span class="pre">NRowMax</span></code> which are upper limits on <code class="docutils literal notranslate"><span class="pre">NCol</span></code> and
<code class="docutils literal notranslate"><span class="pre">NRow</span></code>, the number of columns and rows in the bounding box of the peak mask (as labelled in the image above).</p>
<p>There can also be a limit on the minimum density, <code class="docutils literal notranslate"><span class="pre">DensityPixMin</span></code>, of the peak mask (the total number of detectors in
the mask divided by the area of the bounding box.</p>
</section>
</section>
<section id="finding-nearby-peaks">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">Finding nearby peaks</a><a class="headerlink" href="#finding-nearby-peaks" title="Link to this heading">¶</a></h2>
<p>If the parameter <code class="docutils literal notranslate"><span class="pre">UseNearest=True</span></code> then the peak will be integrated using a mask that contains the nearest
contiguous region of nearest-neighbour connected detectors not contributing to the background), even if the detector ID
of the peak corresponds to a background detector (as identified in step 3).</p>
<p>If <code class="docutils literal notranslate"><span class="pre">UpdatePeakPosition=True</span></code> then the peak detector ID will be replaced with the detector ID corresponding to the
maxiumum integrated intensity over the TOF window which maximises <span class="math notranslate nohighlight">\(I/\sigma\)</span>. The peak TOF will be replaced
with the TOF of the maximum in the focused spectrum.</p>
</section>
<section id="plotting">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">Plotting</a><a class="headerlink" href="#plotting" title="Link to this heading">¶</a></h2>
<p>Optionally the user can ask for a pdf to be saved to <code class="docutils literal notranslate"><span class="pre">OutputFile</span></code>. For each peak the file contains a 2D colorfill plot
showing the peak mask and the data integrated over the TOF window that maximises <span class="math notranslate nohighlight">\(I/\sigma\)</span>, and the
focused, background subtracted spectra with vertical lines to mark the initial and optimal TOF window and the peak
centre.</p>
<p>In addition a graph of the found <span class="math notranslate nohighlight">\(dTOF/TOF\)</span> vs <span class="math notranslate nohighlight">\(\theta\)</span> will be saved as shown below.</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/EstimatedResolutionParametersSkewIntegration.png"><img alt="(Left) Found fractional TOF window and estimated curves at 4 different wavelengths from linear fit shown on (Right)" src="../_images/EstimatedResolutionParametersSkewIntegration.png" style="width: 50%;" /></a>
</figure>
</section>
<section id="useage">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">Useage</a><a class="headerlink" href="#useage" title="Link to this heading">¶</a></h2>
<p><strong>Example:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">Load</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;SXD23767.raw&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">)</span>
<span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">InstrumentWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">NumberOfPeaks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">3271</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">32615</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">3806</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">30017</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">5009</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">42513</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">2486</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">39170</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">2613</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">40740</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">2328</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">40905</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">1703</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">28764</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">2449</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">41068</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">2303</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">40121</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">2038</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">36910</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">3787</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">42749</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">886</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">14284</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mi">1817</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">36104</span><span class="p">)</span>

<span class="n">IntegratePeaksSkew</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD23767&#39;</span><span class="p">,</span> <span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s1">&#39;SingleCrystalPeakTable&#39;</span><span class="p">,</span>
    <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">OutputFile</span><span class="o">=</span><span class="s2">&quot;out.pdf&quot;</span><span class="p">,</span>
    <span class="n">UseNearestPeak</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">IntegrateIfOnEdge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NVacanciesMax</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">NPixPerVacancyMin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">BackScatteringTOFResolution</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">ThetaWidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">UpdatePeakPosition</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>)</span>
<p>Bolotovsky, R., White, M. A., Darovsky, A. &amp; Coppens, P. (1995). J. Appl. Cryst. 28, 86–95.</p>
</aside>
<aside class="footnote brackets" id="id6" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>Peters, J. (2003) J. Appl. Cryst. 36.6, 1475-1479.</p>
</aside>
<aside class="footnote brackets" id="id7" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">3</a><span class="fn-bracket">]</span></span>
<p>Lehmann, M. T., &amp; Larsen, F. K. (1974). Acta Crystallogr. A. 30(4), 580-584.</p>
</aside>
</aside>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Diffraction/Reduction.html">Diffraction\Reduction</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id21" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Link to this heading">¶</a></h2>
<p>Python: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/1b00e0b0644260219c488cf4142569b296f21ab0/Framework/PythonInterface/plugins/algorithms/IntegratePeaksSkew.py">IntegratePeaksSkew.py</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="IntegratePeaksShoeboxTOF-v1.html" title="Previous Chapter: IntegratePeaksShoeboxTOF v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; IntegratePeak...</span>
    </a>
  </li>
  <li>
    <a href="IntegratePeaksUsingClusters-v1.html" title="Next Chapter: IntegratePeaksUsingClusters v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">IntegratePeak... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>