<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>RemoveBackground v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="RemoveBins v1" href="RemoveBins-v1.html" />
    <link rel="prev" title="Regroup v1" href="Regroup-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="http://www.mantidproject.org">Home</a></li>
                <li><a href="http://download.mantidproject.org">Download</a></li>
                <li><a href="http://docs.mantidproject.org/nightly/">Documentation</a></li>
                <li><a href="http://www.mantidproject.org/Contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">RemoveBackground v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="removebackground-v1">
<span id="algm-removebackground"></span><span id="algm-removebackground-v1"></span><h1>RemoveBackground v1<a class="headerlink" href="#removebackground-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/RemoveBackground-v1_dlg.png"><img alt="../_images/RemoveBackground-v1_dlg.png" class="screenshot" src="../_images/RemoveBackground-v1_dlg.png" style="width: 382px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>RemoveBackground</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p></li>
<li><p><a class="reference internal" href="#properties" id="id3">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id4">Description</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id5">Usage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id6">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Removes background (constant for now) calculated in TOF units from a matrix workspace, expressed in units, different from TOF</p>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>InputWorkspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Workspace containing the input data</p></td>
</tr>
<tr class="row-odd"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The name to give the output workspace</p></td>
</tr>
<tr class="row-even"><td><p>BkgWorkspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>An optional histogram workspace in the units of TOF defining background for removal during rebinning.The workspace has to have single value or contain the same number of spectra as the “InputWorkspace” and single Y value per each spectra,representing flat background in the background time region. If such workspace is present, the value of the flat background provided by this workspace is removed from each spectra of the rebinned workspace. This works for histogram and event workspace when events are not retained but actually useful mainly for removing background while rebinning an event workspace in the units different from TOF.</p></td>
</tr>
<tr class="row-odd"><td><p>EMode</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Direct</p></td>
<td><p>The energy conversion mode used to define the conversion from the units of the InputWorkspace to TOF. Allowed values: [‘Elastic’, ‘Direct’, ‘Indirect’]</p></td>
</tr>
<tr class="row-even"><td><p>NullifyNegativeValues</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>When background is subtracted, signals in some time channels may become negative. If this option is true, signal in such bins is nullified and the module of the removed signalis added to the error. If false, the negative signal and correspondent errors remain unchanged</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>Algorithm removes flat background, defined by the a single bin
histogram workspace with X-axis in the units of TOF from a histogram workspace in any
units with known conversion to TOF.</p>
<p>These options are especially useful during reduction
of event workspaces in multirep mode, where different event regions are associated with
different incident energies and rebinned into appropriate energy range.</p>
<p>The algorithm used during background removal is equivalent to the proof-of concept one,
presented below, except intermediate workspaces are not created.</p>
<p>Errors of the background workspace are currently ignored and their value
is calculated as the square root of correspondent background signal.</p>
<p><strong>NOTE:</strong> If background is a single value workspace with zero signal and error, and property
<em>NullifyNegativeValues</em> is set to True, the algorithm can be used to remove negative signal values
and estimate errors during removal.</p>
<p>Proof of concept background removal algorithm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mantid</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="n">maps_dir</span> <span class="o">=</span> <span class="s1">&#39;/home/user/InstrumentFileFinder/let/&#39;</span>
<span class="n">data_dir</span> <span class="o">=</span><span class="s1">&#39;/home/user/results&#39;</span>
<span class="n">ref_data_dir</span> <span class="o">=</span> <span class="s1">&#39;/home/user/SystemTests/AnalysisTests/ReferenceResults&#39;</span>
<span class="n">config</span><span class="o">.</span><span class="n">setDataSearchDirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">;</span><span class="si">{1}</span><span class="s1">;</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="n">maps_dir</span><span class="p">,</span><span class="n">ref_data_dir</span><span class="p">))</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;defaultsave.directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="c1"># folder to save resulting spe/nxspe files. Defaults are in</span>

<span class="c1"># the name of a workspace containing background</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;LET0007438&#39;</span>
<span class="n">groupedFilename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s1">&#39;rings&#39;</span><span class="p">;</span>
<span class="c1">#</span>
<span class="n">Ei</span><span class="o">=</span> <span class="mi">25</span>
<span class="n">e_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span>
<span class="n">e_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">dE</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">bgRange</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15000</span><span class="p">,</span><span class="mi">18000</span><span class="p">]</span>

<span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s2">&quot;Tgrid&quot;</span> <span class="ow">in</span> <span class="n">mtd</span><span class="p">):</span>

  <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">groupedFilename</span> <span class="ow">in</span> <span class="n">mtd</span><span class="p">):</span>
      <span class="n">Load</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.nxs&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">LoadMonitors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">GroupDetectors</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="n">groupedFilename</span> <span class="p">,</span> <span class="n">MapFile</span><span class="o">=</span><span class="s1">&#39;LET_one2one_123.map&#39;</span><span class="p">,</span> <span class="n">Behaviour</span><span class="o">=</span><span class="s1">&#39;Average&#39;</span><span class="p">)</span>

  <span class="n">wsParent</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="n">groupedFilename</span><span class="p">];</span>

  <span class="n">nHist</span> <span class="o">=</span> <span class="n">wsParent</span><span class="o">.</span><span class="n">getNumberHistograms</span><span class="p">();</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parent workspace contains </span><span class="si">{0:10}</span><span class="s2"> histograms&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nHist</span><span class="p">))</span>
  <span class="c1"># Get the energy binning correspondent to the binning produced by rebin function (not to re-implement the same function)</span>
  <span class="n">ws1s</span> <span class="o">=</span> <span class="n">ExtractSingleSpectrum</span><span class="p">(</span><span class="n">wsParent</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">ws1s</span> <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">ws1s</span><span class="p">,</span><span class="s1">&#39;DeltaE&#39;</span><span class="p">,</span><span class="s1">&#39;Direct&#39;</span><span class="p">,</span><span class="n">Ei</span><span class="p">);</span>
  <span class="n">ws1s</span> <span class="o">=</span> <span class="n">Rebin</span><span class="p">(</span><span class="n">ws1s</span><span class="p">,</span><span class="n">Params</span><span class="o">=</span><span class="p">[</span><span class="n">e_min</span><span class="p">,</span><span class="n">dE</span><span class="p">,</span><span class="n">e_max</span><span class="p">]);</span>
  <span class="n">e_bins</span> <span class="o">=</span> <span class="n">ws1s</span><span class="o">.</span><span class="n">dataX</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">nBins</span> <span class="o">=</span> <span class="n">e_bins</span><span class="o">.</span><span class="n">size</span><span class="p">;</span>

  <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">e_bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nBins</span><span class="p">)]</span>
  <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">nHist</span>
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">nHist</span>
  <span class="n">DeleteWorkspace</span><span class="p">(</span><span class="n">ws1s</span><span class="p">);</span>

  <span class="n">eGrid</span> <span class="o">=</span> <span class="n">CreateWorkspace</span><span class="p">(</span><span class="n">DataX</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">DataY</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">UnitX</span><span class="o">=</span><span class="s1">&#39;DeltaE&#39;</span><span class="p">,</span><span class="n">NSpec</span><span class="o">=</span><span class="n">nHist</span><span class="p">,</span><span class="n">VerticalAxisUnit</span><span class="o">=</span><span class="s1">&#39;SpectraNumber&#39;</span><span class="p">,</span><span class="n">ParentWorkspace</span><span class="o">=</span><span class="n">wsParent</span><span class="p">)</span>

  <span class="n">Tgrid</span><span class="o">=</span><span class="n">ConvertUnits</span><span class="p">(</span><span class="n">eGrid</span><span class="p">,</span><span class="s1">&#39;TOF&#39;</span><span class="p">,</span><span class="n">Emode</span><span class="o">=</span><span class="s1">&#39;Direct&#39;</span><span class="p">,</span><span class="n">EFixed</span><span class="o">=</span><span class="n">Ei</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
  <span class="n">Tgrid</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;Tgrid&#39;</span><span class="p">];</span>
  <span class="n">eGrid</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;eGrid&#39;</span><span class="p">];</span>
  <span class="n">nHist</span> <span class="o">=</span> <span class="n">Tgrid</span><span class="o">.</span><span class="n">getNumberHistograms</span><span class="p">();</span>
  <span class="n">nBins</span> <span class="o">=</span> <span class="n">Tgrid</span><span class="o">.</span><span class="n">dataX</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">;</span>

<span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;Bg&#39;</span> <span class="ow">in</span> <span class="n">mtd</span><span class="p">):</span>
  <span class="n">Bg</span><span class="o">=</span><span class="n">Rebin</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">groupedFilename</span><span class="p">,</span>  <span class="n">Params</span><span class="o">=</span><span class="p">[</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">PreserveEvents</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1">#Bg=CalculateFlatBackground(InputWorkspace=groupedFilename, StartX=bgRange[0], EndX=bgRange[1], Mode=&#39;Mean&#39;, OutputMode=&#39;Return Background&#39;, SkipMonitors=True)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">Bg</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;Bg&#39;</span><span class="p">]</span>

<span class="c1"># Assign constant background to the Time grid workspace, minding different time bin width</span>
<span class="k">for</span> <span class="n">nspec</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nHist</span><span class="p">):</span>
  <span class="n">bg</span>            <span class="o">=</span> <span class="n">Bg</span><span class="o">.</span><span class="n">dataY</span><span class="p">(</span><span class="n">nspec</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
     <span class="n">bgT</span>           <span class="o">=</span> <span class="n">Bg</span><span class="o">.</span><span class="n">dataX</span><span class="p">(</span><span class="n">nspec</span><span class="p">)</span>
     <span class="n">TimeScale</span>     <span class="o">=</span> <span class="n">Tgrid</span><span class="o">.</span><span class="n">dataX</span><span class="p">(</span><span class="n">nspec</span><span class="p">);</span>
     <span class="c1"># Jacobian for the unit conversion</span>
     <span class="n">Jac</span>           <span class="o">=</span> <span class="p">(</span><span class="n">TimeScale</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nBins</span><span class="p">]</span><span class="o">-</span><span class="n">TimeScale</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nBins</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">bg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">bgT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bgT</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
     <span class="n">error</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Jac</span><span class="p">);</span>
     <span class="n">eGrid</span><span class="o">.</span><span class="n">setY</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">Jac</span><span class="p">)</span>
     <span class="n">eGrid</span><span class="o">.</span><span class="n">setE</span><span class="p">(</span><span class="n">nspec</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>  <span class="c1"># signal and error for background is 0 anyway.</span>
      <span class="k">pass</span>
  <span class="c1">#print(&quot; bg at spectra {0} equal to : {1}&quot;.format(nspec,bg[0]))</span>


<span class="n">background</span> <span class="o">=</span> <span class="n">eGrid</span><span class="p">;</span>
<span class="n">resultEt</span>   <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">groupedFilename</span><span class="p">,</span><span class="s1">&#39;DeltaE&#39;</span><span class="p">,</span><span class="n">Emode</span><span class="o">=</span><span class="s1">&#39;Direct&#39;</span><span class="p">,</span><span class="n">EFixed</span><span class="o">=</span><span class="n">Ei</span><span class="p">)</span>
<span class="n">result</span>     <span class="o">=</span> <span class="n">Rebin</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">resultEt</span><span class="p">,</span> <span class="n">Params</span><span class="o">=</span><span class="p">[</span><span class="n">e_min</span><span class="p">,</span><span class="n">dE</span><span class="p">,</span><span class="n">e_max</span><span class="p">],</span><span class="n">PreserveEvents</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fr</span>         <span class="o">=</span> <span class="n">result</span><span class="o">-</span><span class="n">background</span><span class="p">;</span>
<span class="c1">#</span>
<span class="n">sourceSum</span>  <span class="o">=</span> <span class="n">SumSpectra</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nHist</span><span class="p">);</span>
<span class="n">bckgrdSum</span>  <span class="o">=</span> <span class="n">SumSpectra</span><span class="p">(</span><span class="n">background</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nHist</span><span class="p">);</span>
<span class="n">removedBkgSum</span> <span class="o">=</span> <span class="n">SumSpectra</span><span class="p">(</span><span class="n">fr</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nHist</span><span class="p">);</span>
</pre></div>
</div>
<p>The results of executing this script on workspace contained measured background and the results of the background removal are
presented on the following picture:</p>
<img alt="../_images/BgRemoval.png" src="../_images/BgRemoval.png" />
<p>Blue line on this image represents the results, obtained using Rebin and Background removal after that. The results produced using
the script below and shifted by one to show that there is another result plotted on the image, as both results
are identical:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mantid</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="n">maps_dir</span> <span class="o">=</span> <span class="s1">&#39;/home/user/InstrumentFileFinder/let/&#39;</span>
<span class="n">data_dir</span> <span class="o">=</span><span class="s1">&#39;/home/user/results&#39;</span>
<span class="n">ref_data_dir</span> <span class="o">=</span> <span class="s1">&#39;/home/user/SystemTests/AnalysisTests/ReferenceResults&#39;</span>
<span class="n">config</span><span class="o">.</span><span class="n">setDataSearchDirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">;</span><span class="si">{1}</span><span class="s1">;</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span><span class="n">maps_dir</span><span class="p">,</span><span class="n">ref_data_dir</span><span class="p">))</span>
<span class="n">config</span><span class="p">[</span><span class="s1">&#39;defaultsave.directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="c1"># folder to save resulting spe/nxspe files. Defaults are in</span>

<span class="c1"># the name of a workspace containing background</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;LET0007438&#39;</span>
<span class="n">groupedFilename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s1">&#39;rings&#39;</span><span class="p">;</span>
<span class="c1">#</span>
<span class="n">Ei</span><span class="o">=</span> <span class="mi">25</span>
<span class="n">e_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span>
<span class="n">e_max</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">dE</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">bgRange</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15000</span><span class="p">,</span><span class="mi">18000</span><span class="p">]</span>


<span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">groupedFilename</span> <span class="ow">in</span> <span class="n">mtd</span><span class="p">):</span>
  <span class="n">Load</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;.nxs&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">LoadMonitors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">GroupDetectors</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="n">groupedFilename</span> <span class="p">,</span> <span class="n">MapFile</span><span class="o">=</span><span class="s1">&#39;LET_one2one_123.map&#39;</span><span class="p">,</span> <span class="n">Behaviour</span><span class="o">=</span><span class="s1">&#39;Average&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="s1">&#39;Bg&#39;</span> <span class="ow">in</span> <span class="n">mtd</span><span class="p">):</span>
  <span class="n">Bg</span><span class="o">=</span><span class="n">Rebin</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">groupedFilename</span><span class="p">,</span>  <span class="n">Params</span><span class="o">=</span><span class="p">[</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bgRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">PreserveEvents</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">Bg</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;Bg&#39;</span><span class="p">]</span>

<span class="k">if</span>  <span class="s1">&#39;resultEtransf&#39;</span> <span class="ow">in</span> <span class="n">mtd</span><span class="p">:</span>
  <span class="n">resultEtransf</span>   <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;resultEtransf&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">resultEtransf</span>   <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">groupedFilename</span><span class="p">,</span><span class="s1">&#39;DeltaE&#39;</span><span class="p">,</span><span class="n">Emode</span><span class="o">=</span><span class="s1">&#39;Direct&#39;</span><span class="p">,</span><span class="n">EFixed</span><span class="o">=</span><span class="n">Ei</span><span class="p">)</span>

<span class="n">noBgWorkspace</span> <span class="o">=</span> <span class="n">Rebin</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">resultEtransf</span><span class="p">,</span> <span class="n">Params</span><span class="o">=</span><span class="p">[</span><span class="n">e_min</span><span class="p">,</span><span class="n">dE</span><span class="p">,</span><span class="n">e_max</span><span class="p">],</span><span class="n">PreserveEvents</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">noBgWorkspace</span><span class="o">=</span> <span class="n">Rebin</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">noBgWorkspace</span><span class="p">,</span><span class="n">BkgWorkspace</span><span class="o">=</span><span class="s1">&#39;Bg&#39;</span><span class="p">,</span><span class="n">EMode</span><span class="o">=</span><span class="s1">&#39;Direct&#39;</span><span class="p">)</span>
<span class="n">nHist</span> <span class="o">=</span> <span class="n">Bg</span><span class="o">.</span><span class="n">getNumberHistograms</span><span class="p">()</span>
<span class="n">removedBkgSum</span> <span class="o">=</span> <span class="n">SumSpectra</span><span class="p">(</span><span class="n">noBgWorkspace</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nHist</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p><strong>Example - Background removal from a workspace in energy transfer units</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create sample workspace with events</span>
<span class="n">Test</span><span class="o">=</span><span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">WorkspaceType</span><span class="o">=</span><span class="s1">&#39;Event&#39;</span><span class="p">,</span> <span class="n">Function</span><span class="o">=</span><span class="s1">&#39;Flat background&#39;</span><span class="p">)</span>
<span class="c1"># Add sample log necessary for unit conversion</span>
<span class="n">AddSampleLog</span><span class="p">(</span><span class="n">Test</span><span class="p">,</span><span class="s1">&#39;Ei&#39;</span><span class="p">,</span><span class="n">LogText</span><span class="o">=</span><span class="s1">&#39;25.&#39;</span><span class="p">,</span><span class="n">LogType</span><span class="o">=</span><span class="s1">&#39;Number&#39;</span><span class="p">);</span>

<span class="c1"># Calculate background</span>
<span class="n">Bg</span> <span class="o">=</span> <span class="n">Rebin</span><span class="p">(</span><span class="n">Test</span><span class="p">,</span><span class="n">Params</span><span class="o">=</span><span class="s1">&#39;15000,5000,20000&#39;</span><span class="p">,</span><span class="n">PreserveEvents</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>


<span class="c1"># Convert event&#39;s units</span>
<span class="n">Test_BgDE</span><span class="o">=</span><span class="n">ConvertUnits</span><span class="p">(</span><span class="n">Test</span><span class="p">,</span><span class="n">Target</span><span class="o">=</span><span class="s1">&#39;DeltaE&#39;</span><span class="p">,</span><span class="n">EMode</span><span class="o">=</span><span class="s1">&#39;Direct&#39;</span><span class="p">);</span>

<span class="c1"># Calculate histograms for event workspace in energy binning</span>
<span class="n">Sample</span> <span class="o">=</span> <span class="n">Rebin</span><span class="p">(</span><span class="n">Test_BgDE</span><span class="p">,</span><span class="n">Params</span><span class="o">=</span><span class="s1">&#39;-20,2,20&#39;</span><span class="p">,</span><span class="n">PreserveEvents</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
<span class="c1"># Calculate histograms for event workspace in energy binning</span>
<span class="n">Result</span>   <span class="o">=</span> <span class="n">Rebin</span><span class="p">(</span><span class="n">Test_BgDE</span><span class="p">,</span><span class="n">Params</span><span class="o">=</span><span class="s1">&#39;-20,2,20&#39;</span><span class="p">,</span><span class="n">PreserveEvents</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
<span class="c1"># Remove flat background in-place</span>
<span class="n">Result</span>   <span class="o">=</span> <span class="n">RemoveBackground</span><span class="p">(</span><span class="n">Result</span><span class="p">,</span><span class="n">BkgWorkspace</span><span class="o">=</span><span class="s1">&#39;Bg&#39;</span><span class="p">,</span><span class="n">EMode</span><span class="o">=</span><span class="s1">&#39;Direct&#39;</span><span class="p">);</span>

<span class="c1"># Get access to the results</span>
<span class="n">XS</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">dataX</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">XR</span> <span class="o">=</span> <span class="n">Result</span> <span class="o">.</span><span class="n">dataX</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="n">YS</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">dataY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">YR</span> <span class="o">=</span> <span class="n">Result</span> <span class="o">.</span><span class="n">dataY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="n">ES</span> <span class="o">=</span> <span class="n">Sample</span><span class="o">.</span><span class="n">dataE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">ER</span> <span class="o">=</span> <span class="n">Result</span> <span class="o">.</span><span class="n">dataE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1"># print first spectra, Note invalid error calculations</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;| x sampl  | x result | S sample | S no bg  | Err samp | Err no_bg|&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">):</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;|</span><span class="si">{0:10}</span><span class="s2">|</span><span class="si">{1:10}</span><span class="s2">|</span><span class="si">{2:10.4f}</span><span class="s2">|</span><span class="si">{3:10.3f}</span><span class="s2">|</span><span class="si">{4:10.3f}</span><span class="s2">|</span><span class="si">{5:10.3f}</span><span class="s2">|&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">XS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">XR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">YS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">YR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ES</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ER</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>| x sampl  | x result | S sample | S no bg  | Err samp | Err no_bg|
|     -20.0|     -20.0|    1.0000|    -0.959|     1.000|     1.008|
|     -18.0|     -18.0|    2.0000|    -0.101|     1.414|     1.420|
|     -16.0|     -16.0|    4.0000|     1.740|     2.000|     2.005|
|     -14.0|     -14.0|    1.0000|    -1.441|     1.000|     1.012|
|     -12.0|     -12.0|    3.0000|     0.353|     1.732|     1.740|
|     -10.0|     -10.0|    3.0000|     0.115|     1.732|     1.742|
|      -8.0|      -8.0|    5.0000|     1.841|     2.236|     2.245|
|      -6.0|      -6.0|    4.0000|     0.519|     2.000|     2.012|
|      -4.0|      -4.0|    4.0000|     0.139|     2.000|     2.015|
|      -2.0|      -2.0|    3.0000|    -1.315|     1.732|     1.753|
|       0.0|       0.0|    4.0000|    -0.867|     2.000|     2.024|
|       2.0|       2.0|    7.0000|     1.454|     2.646|     2.669|
|       4.0|       4.0|    6.0000|    -0.400|     2.449|     2.483|
|       6.0|       6.0|    8.0000|     0.501|     2.828|     2.868|
|       8.0|       8.0|    8.0000|    -0.953|     2.828|     2.885|
|      10.0|      10.0|   11.0000|     0.054|     3.317|     3.388|
|      12.0|      12.0|   13.0000|    -0.810|     3.606|     3.710|
|      14.0|      14.0|   20.0000|     1.812|     4.472|     4.618|
|      16.0|      16.0|   25.0000|    -0.510|     5.000|     5.254|
|      18.0|      18.0|   37.0000|    -2.581|     6.083|     6.578|
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/CorrectionFunctions/BackgroundCorrections.html">CorrectionFunctions\BackgroundCorrections</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/c02ae4cb378648e7336cc15b6678a80eb5d20757/Framework/Algorithms/inc/MantidAlgorithms/RemoveBackground.h">RemoveBackground.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/c02ae4cb378648e7336cc15b6678a80eb5d20757/Framework/Algorithms/src/RemoveBackground.cpp">RemoveBackground.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="Regroup-v1.html" title="Previous Chapter: Regroup v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Regroup v1</span>
    </a>
  </li>
  <li>
    <a href="RemoveBins-v1.html" title="Next Chapter: RemoveBins v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">RemoveBins v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>