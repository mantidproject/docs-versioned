<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>SCDCalibratePanels v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SCDCalibratePanels v2" href="SCDCalibratePanels-v2.html" />
    <link rel="prev" title="SANSWideAngleCorrection v1" href="SANSWideAngleCorrection-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">SCDCalibratePanels v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="scdcalibratepanels-v1">
<span id="algm-scdcalibratepanels-v1"></span><h1>SCDCalibratePanels v1<a class="headerlink" href="#scdcalibratepanels-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/SCDCalibratePanels-v1_dlg.png"><img alt="../_images/SCDCalibratePanels-v1_dlg.png" class="screenshot" src="../_images/SCDCalibratePanels-v1_dlg.png" style="width: 349px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>SCDCalibratePanels</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id3">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id4">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id5">Description</a></p>
<ul>
<li><p><a class="reference internal" href="#output-workspaces-and-files" id="id6">OUTPUT workspaces and files:</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#after-calibration" id="id7">After Calibration</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id8">Usage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id9">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Panel parameters and L0 are optimized to minimize errors between theoretical and actual q values for the peaks</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PeakWorkspace</p></td>
<td><p>InOut</p></td>
<td><p>PeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Workspace of Indexed Peaks</p></td>
</tr>
<tr class="row-odd"><td><p>a</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter a (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-even"><td><p>b</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter b (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-odd"><td><p>c</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter c (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-even"><td><p>alpha</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter alpha in degrees (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-odd"><td><p>beta</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter beta in degrees (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-even"><td><p>gamma</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter gamma in degrees (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-odd"><td><p>ChangeL1</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Change the L1(source to sample) distance</p></td>
</tr>
<tr class="row-even"><td><p>ChangeT0</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Change the T0 (initial TOF)</p></td>
</tr>
<tr class="row-odd"><td><p>ChangePanelSize</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Change the height and width of the detectors.  Implemented only for RectangularDetectors.</p></td>
</tr>
<tr class="row-even"><td><p>EdgePixels</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0</p></td>
<td><p>Remove peaks that are at pixels this close to edge.</p></td>
</tr>
<tr class="row-odd"><td><p>CalibrateBanks</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Calibrate the panels of the banks.</p></td>
</tr>
<tr class="row-even"><td><p>CalibrateSNAPPanels</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Calibrate the 3 X 3 panels of the sides of SNAP.</p></td>
</tr>
<tr class="row-odd"><td><p>DetCalFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>SCDCalibrate.DetCal</p></td>
<td><p>Path to an ISAW-style .detcal file to save. Allowed extensions: [‘.detcal’, ‘.det_cal’]</p></td>
</tr>
<tr class="row-even"><td><p>XmlFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td></td>
<td><p>Path to an Mantid .xml description(for LoadParameterFile) file to save. Allowed extensions: [‘.xml’]</p></td>
</tr>
<tr class="row-odd"><td><p>ColFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>ColCalcvsTheor.nxs</p></td>
<td><p>Path to a NeXus file comparing calculated and theoretical column of each peak. Allowed extensions: [‘.nxs’]</p></td>
</tr>
<tr class="row-even"><td><p>RowFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>RowCalcvsTheor.nxs</p></td>
<td><p>Path to a NeXus file comparing calculated and theoretical row of each peak. Allowed extensions: [‘.nxs’]</p></td>
</tr>
<tr class="row-odd"><td><p>TofFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>TofCalcvsTheor.nxs</p></td>
<td><p>Path to a NeXus file comparing calculated and theoretical TOF of each peak. Allowed extensions: [‘.nxs’]</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>This algorithm calibrates panels of Rectangular Detectors
or packs of tubes in an instrument.  The initial path,
panel centers and orientations are adjusted so the error in Q
positions from the theoretical Q positions is minimized.
Given a set of peaks indexed by <span class="math notranslate nohighlight">\((h_i, k_i, l_i)\)</span>, we
modify the instrument parameters, p, and then find  Q in the sample frame,
<span class="math notranslate nohighlight">\(\rm Q_{sample}\)</span> that mininizes the following:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\left\vert 2\pi \rm U \rm B \left(
                            \begin{array}{c}
                              NINT(h_i) \\
                              NINT(k_i) \\
                              NINT(l_i) \\
                            \end{array}
                          \right) - \rm Q_{sample,i}(p) \right\vert ^2\end{split}\]</div>
<p>NINT is the nearest integer function.
B is fixed from the input lattice parameters, but U is modified by <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix</span></a>
for all peaks before and after optimization.
When the peaks are indexed, sample offsets are adjusted to better index the peaks.
The initial time-of-flight, T0, is optimized for all peaks before any parameters are optimized.
The initial path, L1, is optimized for all peaks before and after all panels or packs’ parameters are optimized.
The panels and packs’ parameters are optimized in parallel.
An option is available to adjust the panel widths and heights for Rectangular Detectors in a second iteration with all the other parameters fixed.</p>
<section id="output-workspaces-and-files">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">OUTPUT workspaces and files:</a><a class="headerlink" href="#output-workspaces-and-files" title="Permalink to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>The results are saved to an ISAW-like DetCal file and optionally in an xml
file that can be used with the <a class="reference internal" href="LoadParameterFile-v1.html#algm-loadparameterfile"><span class="std std-ref">LoadParameterFile</span></a> algorithm.</p></li>
<li><p>There are two output workspace groups that are output when this algorithm calls the <a class="reference internal" href="Fit-v1.html#algm-fit"><span class="std std-ref">Fit</span></a> algorithm.</p>
<ol class="loweralpha simple">
<li><p>Fit_Parameters: workspaces beginning with ‘params’ contains the results from fitting for each bank and for L1.</p>
<ul class="simple">
<li><p>XShift, YShift,and ZShift are in meters.</p></li>
<li><p>XRotate, YRotate, and ZRotate are in degrees.</p></li>
</ul>
</li>
<li><p>Fit_Residuals: workspaces beginning with ‘fit’ contain the differences in the calculated and theoretical Q vectors for each peak.</p></li>
</ol>
</li>
<li><p>There are three output files that show the goodness of the calibration.</p>
<ol class="loweralpha simple">
<li><p>ColFilename contains the calculated and theoretical column for each peak. Each spectra is labeled by the bank. To plot use python script, scripts/SCD_Reduction/SCDCalibratePanelsResults.py</p></li>
<li><p>RowFilename contains the calculated and theoretical row for each peak. Each spectra is labeled by the bank. To plot use python script, scripts/SCD_Reduction/SCDCalibratePanelsResults.py</p></li>
<li><p>TofFilename contains the calculated and theoretical TOF for each peak.  Each spectra is labeled by the bank.</p></li>
</ol>
</li>
</ol>
</section>
</section>
<section id="after-calibration">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">After Calibration</a><a class="headerlink" href="#after-calibration" title="Permalink to this heading">¶</a></h2>
<p>After calibration, you can save the workspace to Nexus (or Nexus
processed) and get it back by loading in a later Mantid session. You can
copy the calibration to another workspace using the same instrument by
means of the <a class="reference internal" href="CopyInstrumentParameters-v1.html#algm-copyinstrumentparameters"><span class="std std-ref">CopyInstrumentParameters v1</span></a>
algorithm. To do so select the workspace, which you have calibrated as
the InputWorkspace and the workspace you want to copy the calibration
to, the OutputWorkspace.</p>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#Calibrate peaks file and load to workspace</span>
<span class="n">LoadIsawPeaks</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;MANDI_801.peaks&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;peaks&#39;</span><span class="p">)</span>
<span class="c1">#TimeOffset is not stored in xml file, so use DetCal output if you need TimeOffset</span>
<span class="n">SCDCalibratePanels</span><span class="p">(</span><span class="n">PeakWorkspace</span><span class="o">=</span><span class="s1">&#39;peaks&#39;</span><span class="p">,</span><span class="n">DetCalFilename</span><span class="o">=</span><span class="s1">&#39;mandi_801.DetCal&#39;</span><span class="p">,</span><span class="n">XmlFilename</span><span class="o">=</span><span class="s1">&#39;mandi_801.xml&#39;</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">74</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">74.5</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mf">99.9</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">beta</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span><span class="n">gamma</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">LoadEmptyInstrument</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">getInstrumentDirectory</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;MANDI_Definition_2013_08_01.xml&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">)</span>
<span class="n">CloneWorkspace</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_xml&#39;</span><span class="p">)</span>
<span class="n">LoadParameterFile</span><span class="p">(</span><span class="n">Workspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_xml&#39;</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;mandi_801.xml&#39;</span><span class="p">)</span>
<span class="n">LoadIsawDetCal</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;mandi_801.DetCal&#39;</span><span class="p">)</span>
<span class="n">det1</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getInstrument</span><span class="p">()</span><span class="o">.</span><span class="n">getDetector</span><span class="p">(</span><span class="mi">327680</span><span class="p">)</span>
<span class="n">det2</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;MANDI_801_event_xml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">getInstrument</span><span class="p">()</span><span class="o">.</span><span class="n">getDetector</span><span class="p">(</span><span class="mi">327680</span><span class="p">)</span>
<span class="k">if</span> <span class="n">det1</span><span class="o">.</span><span class="n">getPos</span><span class="p">()</span> <span class="o">==</span> <span class="n">det2</span><span class="o">.</span><span class="n">getPos</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;matches&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DeleteWorkspace</span><span class="p">(</span><span class="s1">&#39;peaks&#39;</span><span class="p">)</span>
<span class="n">DeleteWorkspace</span><span class="p">(</span><span class="s1">&#39;MANDI_801_event_xml&#39;</span><span class="p">)</span>
<span class="n">DeleteWorkspace</span><span class="p">(</span><span class="s1">&#39;MANDI_801_event_DetCal&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">mantid</span>
<span class="n">filename</span><span class="o">=</span><span class="n">mantid</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s2">&quot;defaultsave.directory&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;mandi_801.xml&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="n">mantid</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s2">&quot;defaultsave.directory&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;mandi_801.DetCal&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">matches</span>
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Crystal/Corrections.html">Crystal\Corrections</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Crystal/inc/MantidCrystal/SCDCalibratePanels.h">SCDCalibratePanels.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Crystal/src/SCDCalibratePanels.cpp">SCDCalibratePanels.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="SANSWideAngleCorrection-v1.html" title="Previous Chapter: SANSWideAngleCorrection v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; SANSWideAngle...</span>
    </a>
  </li>
  <li>
    <a href="SCDCalibratePanels-v2.html" title="Next Chapter: SCDCalibratePanels v2"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">SCDCalibratePanels v2 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>