<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>OptimizeCrystalPlacement v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="OptimizeCrystalPlacementByRun v1" href="OptimizeCrystalPlacementByRun-v1.html" />
    <link rel="prev" title="OneMinusExponentialCor v1" href="OneMinusExponentialCor-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">OptimizeCrystalPlacement v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="optimizecrystalplacement-v1">
<span id="algm-optimizecrystalplacement"></span><span id="algm-optimizecrystalplacement-v1"></span><h1>OptimizeCrystalPlacement v1<a class="headerlink" href="#optimizecrystalplacement-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/OptimizeCrystalPlacement-v1_dlg.png"><img alt="../_images/OptimizeCrystalPlacement-v1_dlg.png" class="screenshot" src="../_images/OptimizeCrystalPlacement-v1_dlg.png" style="width: 349px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>OptimizeCrystalPlacement</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p></li>
<li><p><a class="reference internal" href="#properties" id="id3">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id4">Description</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id5">Usage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id6">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>This algorithm  optimizes goniometer settings  and sample orientation to better index the peaks.</p>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PeaksWorkspace</p></td>
<td><p>Input</p></td>
<td><p>PeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Workspace of Peaks with UB loaded</p></td>
</tr>
<tr class="row-odd"><td><p>KeepGoniometerFixedfor</p></td>
<td><p>Input</p></td>
<td><p>int list</p></td>
<td></td>
<td><p>List of run Numbers for which the goniometer settings will NOT be changed</p></td>
</tr>
<tr class="row-even"><td><p>ModifiedPeaksWorkspace</p></td>
<td><p>Output</p></td>
<td><p>PeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Output Workspace of Peaks with optimized sample Orientations</p></td>
</tr>
<tr class="row-odd"><td><p>FitInfoTable</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></p></td>
<td><p>FitInfoTable</p></td>
<td><p>Workspace of Results</p></td>
</tr>
<tr class="row-even"><td><p>AdjustSampleOffsets</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>If true sample offsets will be adjusted to give better fits, otherwise they will be fixed as zero(def=true)</p></td>
</tr>
<tr class="row-odd"><td><p>OptimizeGoniometerTilt</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Set true if main error is due to a tilted Goniometer(def=false)</p></td>
</tr>
<tr class="row-even"><td><p>Chi2overDoF</p></td>
<td><p>Output</p></td>
<td><p>number</p></td>
<td></td>
<td><p>chi squared over dof</p></td>
</tr>
<tr class="row-odd"><td><p>nPeaks</p></td>
<td><p>Output</p></td>
<td><p>number</p></td>
<td></td>
<td><p>Number of Peaks Used</p></td>
</tr>
<tr class="row-even"><td><p>nParams</p></td>
<td><p>Output</p></td>
<td><p>number</p></td>
<td></td>
<td><p>Number of Parameters fit</p></td>
</tr>
<tr class="row-odd"><td><p>nIndexed</p></td>
<td><p>Output</p></td>
<td><p>number</p></td>
<td></td>
<td><p>Number of new Peaks that WOULD be indexed at ‘MaxIndexingError’</p></td>
</tr>
<tr class="row-even"><td><p>MaxAngularChange</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>5</p></td>
<td><p>Max offset in degrees from current settings(def=5)</p></td>
</tr>
<tr class="row-odd"><td><p>MaxIndexingError</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.15</p></td>
<td><p>Use only peaks whose fractional hkl values are below this tolerance(def=0.15)</p></td>
</tr>
<tr class="row-even"><td><p>MaxHKLPeaks2Use</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>-1</p></td>
<td><p>If less than 0 all peaks are used, otherwise only peaks whose h,k, and l values are below the level are used(def=-1)</p></td>
</tr>
<tr class="row-odd"><td><p>MaxSamplePositionChangeMeters</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.0005</p></td>
<td><p>Maximum Change in Sample position in meters(def=.0005)</p></td>
</tr>
<tr class="row-even"><td><p>OutputNormalisedCovarianceMatrixOptX</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></p></td>
<td><p>CovarianceInfo</p></td>
<td><p>The name of the TableWorkspace in which to store the final covariance matrix</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>This algorithm basically optimizes h,k, and l offsets from an integer by
varying the parameters sample positions, sample orientations ( chi,phi,
and omega), and/or the tilt of the goniometer for an experiment.</p>
<p>If the <a class="reference internal" href="../concepts/Lattice.html#lattice"><span class="std std-ref">crystal orientation matrix, UB</span></a>, was created from
one run, that run may not need to have its goniometer settings optimized.
There is a property to list the run numbers to NOT have their goniometer
settings changed. This entry is IGNORED if the tilt or sample positions are
included in the optimization. In this case NONE of the goniometer
angles, relative to any tilt, will be changed.</p>
<p>The goniometer angles displayed are relative to the tilt,i,e, phi is
the rotation around the axis perpendicular to the tilted plane. The
resultant PeaksWorkspace has the goniometer angles relative to the Y and
Z axes at that time.</p>
<p>The crystal orientation matrix, <a class="reference internal" href="../concepts/Lattice.html#lattice"><span class="std std-ref">UB matrix</span></a>, from the
PeaksWorkspace should index all the runs “very well”. Otherwise iterations
that slowly build a <a class="reference internal" href="../concepts/Lattice.html#lattice"><span class="std std-ref">UB matrix</span></a> with corrected sample
orientations may be needed.</p>
<p>The parameters for the tilt are GRotx, GRoty, and GRotz in
degrees. The usage for this information is as follows:</p>
<p><span class="math notranslate nohighlight">\(rotate(x,GRotx)*rotate(y,GRoty)*rotate(z,GRotz)* SampleOrientation\)</span>
<span class="math notranslate nohighlight">\(( i.e. omegaRot*chiRot*phiRot)).\)</span></p>
<p>Note: To optimize by the tilt in the goniometer and then by the angles
or by the sample position, it is possible to run with one optimization,
then using the resultant PeaksWorkspace for input, run another
optimization.</p>
<p>Rerunning the same optimization with the result is also a good idea. If
the first guess is very close, the optimize algorithm does try cases far
away and may not get back to the best value. Check the chisquared
values. If they increase, that optimization should probably not be used.</p>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p><strong>Example:</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">ws</span><span class="o">=</span><span class="n">LoadIsawPeaks</span><span class="p">(</span><span class="s2">&quot;TOPAZ_3007.peaks&quot;</span><span class="p">)</span>
<span class="n">LoadIsawUB</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="s2">&quot;TOPAZ_3007.mat&quot;</span><span class="p">)</span>
<span class="n">wsd</span> <span class="o">=</span> <span class="n">OptimizeCrystalPlacement</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<span class="p">(</span><span class="n">wsPeakOut</span><span class="p">,</span><span class="n">fitInfoTable</span><span class="p">,</span><span class="n">chi2overDoF</span><span class="p">,</span><span class="n">nPeaks</span><span class="p">,</span><span class="n">nParams</span><span class="p">,</span><span class="n">nIndexed</span><span class="p">,</span><span class="n">covrianceInfoTable</span><span class="p">)</span> <span class="o">=</span> <span class="n">OptimizeCrystalPlacement</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="n">AdjustSampleOffsets</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Chi2: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chi2overDoF</span><span class="p">))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Chi2: 0.0003
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Crystal/Corrections.html">Crystal\Corrections</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Crystal/inc/MantidCrystal/OptimizeCrystalPlacement.h">OptimizeCrystalPlacement.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Crystal/src/OptimizeCrystalPlacement.cpp">OptimizeCrystalPlacement.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="OneMinusExponentialCor-v1.html" title="Previous Chapter: OneMinusExponentialCor v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; OneMinusExpon...</span>
    </a>
  </li>
  <li>
    <a href="OptimizeCrystalPlacementByRun-v1.html" title="Next Chapter: OptimizeCrystalPlacementByRun v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">OptimizeCryst... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>