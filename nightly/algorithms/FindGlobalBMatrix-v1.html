<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>FindGlobalBMatrix v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="FindGoniometerFromUB v1" href="FindGoniometerFromUB-v1.html" />
    <link rel="prev" title="FindEPP v2" href="FindEPP-v2.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">FindGlobalBMatrix v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="findglobalbmatrix-v1">
<span id="algm-findglobalbmatrix"></span><span id="algm-findglobalbmatrix-v1"></span><h1>FindGlobalBMatrix v1<a class="headerlink" href="#findglobalbmatrix-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/FindGlobalBMatrix-v1_dlg.png"><img alt="../_images/FindGlobalBMatrix-v1_dlg.png" class="screenshot" src="../_images/FindGlobalBMatrix-v1_dlg.png" style="width: 300px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>FindGlobalBMatrix</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id3">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id4">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id5">Description</a></p></li>
<li><p><a class="reference internal" href="#useage" id="id6">Useage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id7">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Takes multiple peak tables from different runs and refines common lattice parameters and angles.</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="FindUBUsingLatticeParameters-v1.html#algm-findubusinglatticeparameters"><span class="std std-ref">FindUBUsingLatticeParameters</span></a>, <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PeakWorkspaces</p></td>
<td><p>Input</p></td>
<td><p>str list</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>List of peak workspaces to use (must be more than two peaks workspaces and each must contain at least 6 peaks.</p></td>
</tr>
<tr class="row-odd"><td><p>a</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Lattice parameter a</p></td>
</tr>
<tr class="row-even"><td><p>b</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Lattice parameter b</p></td>
</tr>
<tr class="row-odd"><td><p>c</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Lattice parameter c</p></td>
</tr>
<tr class="row-even"><td><p>alpha</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Lattice angle alpha</p></td>
</tr>
<tr class="row-odd"><td><p>beta</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Lattice angle beta</p></td>
</tr>
<tr class="row-even"><td><p>gamma</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Lattice angle gamma</p></td>
</tr>
<tr class="row-odd"><td><p>Tolerance</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.15</p></td>
<td><p>Tolerance to index peaks in in H,K and L</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>FindGlobalBMatrix refines the lattice parameters (encoded in the B matrix) across PeaksWorkspaces from multiple runs
with a separate U matrix (which encodes the orientation for an identity goniometer matrix) per run. This is useful for
when the goniometer matrix is inaccurate/not well known.</p>
<p>The quantity minimised is the average of the square of the difference in QSample between the observed peak and the peak
at integer HKL (see <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix v1</span></a> for details). The average rather than the sum of the squared residuals
is used so as not to penalise the indexing of more peaks as the UB matrix becomes more accurate.</p>
<p>FindGlobalBMatrix adds a different UB to each peak workspace that can be indexed - note the algorithm ensures consistent
indexing across all runs (i.e. axes are not swapped or inverted). All peaks workspaces must have more then 6 peaks in
(a requirement of some child algorithms used).</p>
<p>The algorithm proceeds in this way:</p>
<ul class="simple">
<li><p>Finds an initial UB</p>
<ul>
<li><p>If a UB exists on any workspace the initial is the UB that indexes the most peaks.</p></li>
<li><p>Otherwise <a class="reference internal" href="FindUBUsingLatticeParameters-v1.html#algm-findubusinglatticeparameters"><span class="std std-ref">FindUBUsingLatticeParameters</span></a> is run on the workspaces with the input lattice parameters until a UB is found.</p></li>
</ul>
</li>
<li><p>Peaks in all workspaces are indexed consistently with the initial UB</p>
<ul>
<li><p>If a workspace has a valid UB it is transformed to preserve consistent indexing.</p></li>
<li><p>Otherwise we try to index the peaks using the initial UB and the goniometer matrix on the workspace</p></li>
<li><p>If the above doesn’t work because e.g. the goniometer matrix is inaccurate, we find a UB using <a class="reference internal" href="FindUBUsingLatticeParameters-v1.html#algm-findubusinglatticeparameters"><span class="std std-ref">FindUBUsingLatticeParameters</span></a> and transform to preserve consistent indexing.</p></li>
</ul>
</li>
<li><p>Once peaks are indexed the optimal lattice parameters are found that minimise the average of the squared residuals in QSample across all runs.</p>
<ul>
<li><p>The U matrix of each run is found for a given set of lattice parameters using <a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix v1</span></a>.</p></li>
</ul>
</li>
</ul>
</section>
<section id="useage">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Useage</a><a class="headerlink" href="#useage" title="Permalink to this heading">¶</a></h2>
<p><strong>Example:</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># load empty instrument so can create a peak table</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">LoadEmptyInstrument</span><span class="p">(</span><span class="n">InstrumentName</span><span class="o">=</span><span class="s1">&#39;SXD&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;empty_SXD&#39;</span><span class="p">)</span>
<span class="n">axis</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">getAxis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">axis</span><span class="o">.</span><span class="n">setUnit</span><span class="p">(</span><span class="s2">&quot;TOF&quot;</span><span class="p">)</span>

<span class="c1"># create two peak tables with UB corresponding to different lattice constants, a</span>
<span class="n">peaks1</span> <span class="o">=</span> <span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">InstrumentWorkspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">NumberOfPeaks</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">UB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.8</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>  <span class="c1"># alatt = [3.8, 4, 10]</span>
<span class="n">SetUB</span><span class="p">(</span><span class="n">peaks1</span><span class="p">,</span> <span class="n">UB</span><span class="o">=</span><span class="n">UB</span><span class="p">)</span>
<span class="n">peaks2</span> <span class="o">=</span> <span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">InstrumentWorkspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">NumberOfPeaks</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">UB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">4.2</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>  <span class="c1"># alatt = [4.2, 4, 10]</span>
<span class="n">SetUB</span><span class="p">(</span><span class="n">peaks2</span><span class="p">,</span> <span class="n">UB</span><span class="o">=</span><span class="n">UB</span><span class="p">)</span>
<span class="c1"># Add some peaks</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">peaks</span> <span class="ow">in</span> <span class="p">[</span><span class="n">peaks1</span><span class="p">,</span> <span class="n">peaks2</span><span class="p">]:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">peaks</span><span class="o">.</span><span class="n">createPeakHKL</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">addPeak</span><span class="p">(</span><span class="n">pk</span><span class="p">)</span>

<span class="n">FindGlobalBMatrix</span><span class="p">(</span><span class="n">PeakWorkspaces</span><span class="o">=</span><span class="p">[</span><span class="n">peaks1</span><span class="p">,</span> <span class="n">peaks2</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="mf">4.1</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">4.2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">88</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">88</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">89</span><span class="p">,</span>
                  <span class="n">Tolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="c1"># show that both workspaces have the average of the two a lattice constants (a=4 Ang)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">peaks1</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">getOrientedLattice</span><span class="p">())</span>
<span class="c1"># lattice parameters: a = 4.00025 b = 3.98794 c = 9.99608 alpha = 89.9698 beta = 90.0829 gamma = 89.9336</span>

<span class="nb">print</span><span class="p">(</span><span class="n">peaks2</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">getOrientedLattice</span><span class="p">())</span>
<span class="c1"># lattice parameters: a = 4.00025 b = 3.98794 c = 9.99608 alpha = 89.9698 beta = 90.0829 gamma = 89.9336</span>
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Diffraction/Reduction.html">Diffraction\Reduction</a> | <a class="reference external" href="categories/Crystal/UBMatrix.html">Crystal\UBMatrix</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>Python: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/PythonInterface/plugins/algorithms/FindGlobalBMatrix.py">FindGlobalBMatrix.py</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="FindEPP-v2.html" title="Previous Chapter: FindEPP v2"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; FindEPP v2</span>
    </a>
  </li>
  <li>
    <a href="FindGoniometerFromUB-v1.html" title="Next Chapter: FindGoniometerFromUB v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">FindGoniomete... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>