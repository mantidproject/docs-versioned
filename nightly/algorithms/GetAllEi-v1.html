<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>GetAllEi v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GetDetectorOffsets v1" href="GetDetectorOffsets-v1.html" />
    <link rel="prev" title="GeneratePythonScript v1" href="GeneratePythonScript-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">GetAllEi v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="getallei-v1">
<span id="algm-getallei"></span><span id="algm-getallei-v1"></span><h1>GetAllEi v1<a class="headerlink" href="#getallei-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/GetAllEi-v1_dlg.png"><img alt="../_images/GetAllEi-v1_dlg.png" class="screenshot" src="../_images/GetAllEi-v1_dlg.png" style="width: 349px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>GetAllEi</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id3">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id4">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id5">Description</a></p></li>
<li><p><a class="reference internal" href="#used-subalgorithms" id="id6">Used Subalgorithms</a></p></li>
<li><p><a class="reference internal" href="#source" id="id7">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Analyze the chopper logs and the signal registered by the monitors to identify energies used as incident energies in an inelastic experiment.</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="GetEi-v2.html#algm-getei"><span class="std std-ref">GetEi</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Workspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The input workspace containing the monitor’s spectra measured after the last chopper</p></td>
</tr>
<tr class="row-odd"><td><p>Monitor1SpecID</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>The workspace index (ID) of the spectra, containing first monitor’s signal to analyze.</p></td>
</tr>
<tr class="row-even"><td><p>Monitor2SpecID</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>The workspace index (ID) of the spectra, containing second monitor’s signal to analyze.</p></td>
</tr>
<tr class="row-odd"><td><p>ChopperSpeedLog</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Defined in IDF</p></td>
<td><p>Name of the instrument log, containing chopper angular velocity. If ‘Defined in IDF’ option is specified, the log name is obtained from the IDF</p></td>
</tr>
<tr class="row-even"><td><p>ChopperDelayLog</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Defined in IDF</p></td>
<td><p>Name of the instrument log, containing chopper delay time or chopper phase v.r.t. the pulse time. If ‘Defined in IDF’  option is specified, the log name is obtained from IDF</p></td>
</tr>
<tr class="row-odd"><td><p>FilterBaseLog</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Defined in IDF</p></td>
<td><p>Name of the instrument log, with positive values indicating that instrument is running  and 0 or negative that it is not. The log is used to identify time interval to evaluate chopper speed and chopper delay which matter. If such log is not present, average log values are calculated within experiment start&amp;end time range.</p></td>
</tr>
<tr class="row-even"><td><p>FilterWithDerivative</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Use derivative of ‘FilterBaseLog’ rather then log values itself to filter invalid time intervals. Invalid values are then the values where the derivative of the log turns zero. E.g. the ‘proton_chage’ log grows for each frame when instrument is counting and is constant otherwise.</p></td>
</tr>
<tr class="row-odd"><td><p>MaxInstrResolution</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.0005</p></td>
<td><p>The maximal energy resolution possible for an instrument at working energies (full width at half maximum).  Peaks, sharper then this width are rejected. Accepted limits are: 1e^(-6)-0.1</p></td>
</tr>
<tr class="row-even"><td><p>MinInstrResolution</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.08</p></td>
<td><p>The minimal energy resolution possible for an instrument at working energies (full width at half maximum). Peaks broader then this width are rejected. Accepted limits are: 0.001-0.5</p></td>
</tr>
<tr class="row-odd"><td><p>PeaksRatioToReject</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.1</p></td>
<td><p>Ratio of a peak energy to the maximal energy among all peaks. If the ratio is lower then the value specified here, peak is treated as insignificant and rejected. Accepted limits are:0.0 (All accepted) to 1 – only one peak  (or peaks with max and equal intensity) are accepted.</p></td>
</tr>
<tr class="row-even"><td><p>IgnoreSecondMonitor</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Usually peaks are analyzed and accepted only if identified on both monitors. If this property is set to true, only first monitor peaks are analyzed. This is debugging option as getEi has to use both monitors.</p></td>
</tr>
<tr class="row-odd"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/Workspace.html#workspace"><span class="std std-ref">Workspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Name of the output matrix workspace, containing single spectra with monitor peaks energies together with total intensity within each peak.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>Algorithm finds the estimate for all incident energies allowed by chopper system of an inelastic instrument and returns a workspace,
with the estimates for positions, heights and width of incident energies provided by the choppers and registered on monitors.
These estimates can be used as guess value for  <a class="reference internal" href="GetEi-v2.html#algm-getei"><span class="std std-ref">GetEi v2</span></a> algorithm or as inputs for a peak fitting procedure.</p>
<p>Algorithm performs number of steps to identify the values requested:</p>
<ol class="arabic simple">
<li><p>It takes appropriate log names from instrument definition file (IDF), namely chopper-position component and calculates last chopper speed and delay as average
of the filtered log values. Guess chopper opening times are calculated from chopper speed and delay time. The “chopper-position” component with appropriate properties
has to be present in IDF for this algorithm to work. See ISIS MARI or MAPS instrument definition files for example of “chopper-position” component.</p></li>
<li><p>Algorithm uses estimate for the minimal energy resolution of an instrument and searches for real peaks around guess values obtained
earlier within 4 sigma of this resolution interval.</p></li>
<li><p>If peaks are found, the algorithm performs running averages over signal in the appropriate time interval until first derivative
of the signal has only one zero. The position of this zero is returned as the guess energy and the distance between closest to
the guess energy zeros of the second derivative are returned as the guess values for the peak width. The peak amplitude
is estimated from the total intensity of the signal within the search interval, assuming that the peak shape is Gaussian.</p></li>
<li><p>Similar procedure is performed for second monitor. The peak is accepted only if the peak width lies between the minimal and maximal instrument resolution values
and the distance between peaks positions on two monitors (on energy scale) is smaller then two sigma.</p></li>
</ol>
<p>Algorithm returns matrix workspace containing single spectrum, with x-values representing peak positions, y-values: peak heights and the error: peak width. X-values are
sorted according to energy in peaks (peaks with maximal energy are returned first).</p>
</section>
<section id="used-subalgorithms">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Used Subalgorithms</a><a class="headerlink" href="#used-subalgorithms" title="Permalink to this heading">¶</a></h2>
<p>The algorithm uses <a class="reference internal" href="../concepts/UnitFactory.html#unit-factory"><span class="std std-ref">Unit Factory</span></a> and <a class="reference internal" href="ConvertUnits-v1.html#algm-convertunits"><span class="std std-ref">ConvertUnits v1</span></a> algorithm
to convert units from TOF to energy.</p>
<p><strong>Example: Find all incident energies for test workspace</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># BUILD SAMPLE WORKSPACE</span>
<span class="c1"># Build sample workspace with chopper and in energy units to</span>
<span class="c1"># have defined peaks in defined energy positions</span>
<span class="n">wsEn</span><span class="o">=</span><span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">Function</span><span class="o">=</span><span class="s1">&#39;Multiple Peaks&#39;</span><span class="p">,</span> <span class="n">NumBanks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">BankPixelWidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">NumEvents</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">XUnit</span><span class="o">=</span><span class="s1">&#39;Energy&#39;</span><span class="p">,</span> <span class="n">XMin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">XMax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">BinWidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="c1"># convert units to TOF to simulate real workspace obtained from experiment</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">wsEn</span><span class="p">,</span> <span class="n">Target</span><span class="o">=</span><span class="s1">&#39;TOF&#39;</span><span class="p">)</span>
<span class="c1"># find chopper log values would be present in real workspace</span>
<span class="n">l_chop</span> <span class="o">=</span> <span class="mf">7.5</span>  <span class="c1"># chopper position build into test workspace</span>
<span class="n">l_mon1</span> <span class="o">=</span> <span class="mf">15.</span> <span class="c1"># monitor 1 position (detector 1), build into test workspace</span>
<span class="n">t_mon1</span> <span class="o">=</span> <span class="mf">3100.</span> <span class="c1"># the time of flight defined by incident energy of the peak generated by CreateSampelpWorkspace algorithm.</span>
<span class="n">t_chop</span> <span class="o">=</span> <span class="p">(</span><span class="n">l_chop</span><span class="o">/</span><span class="n">l_mon1</span><span class="p">)</span><span class="o">*</span><span class="n">t_mon1</span>
<span class="c1"># Add these log values to simulated workspace to represent real sample logs</span>
<span class="n">AddTimeSeriesLog</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s2">&quot;fermi_delay&quot;</span><span class="p">,</span> <span class="n">Time</span><span class="o">=</span><span class="s2">&quot;2010-01-01T00:00:00&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="o">=</span><span class="n">t_chop</span> <span class="p">,</span><span class="n">DeleteExisting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">AddTimeSeriesLog</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s2">&quot;fermi_delay&quot;</span><span class="p">,</span> <span class="n">Time</span><span class="o">=</span><span class="s2">&quot;2010-01-01T00:30:00&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="o">=</span><span class="n">t_chop</span> <span class="p">)</span>
<span class="n">AddTimeSeriesLog</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s2">&quot;fermi_speed&quot;</span><span class="p">,</span> <span class="n">Time</span><span class="o">=</span><span class="s2">&quot;2010-01-01T00:00:00&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="o">=</span><span class="mi">900</span> <span class="p">,</span><span class="n">DeleteExisting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">AddTimeSeriesLog</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s2">&quot;fermi_speed&quot;</span><span class="p">,</span> <span class="n">Time</span><span class="o">=</span><span class="s2">&quot;2010-01-01T00:30:00&quot;</span><span class="p">,</span> <span class="n">Value</span><span class="o">=</span><span class="mi">900</span><span class="p">)</span>
<span class="c1">#-------------------------------------------------------------</span>

<span class="c1"># FIND GUESS PEAKS</span>
<span class="n">allEiWs</span><span class="o">=</span><span class="n">GetAllEi</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="n">Monitor1SpecID</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Monitor2SpecID</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># Analyze results</span>
<span class="n">allEi</span> <span class="o">=</span> <span class="n">allEiWs</span><span class="o">.</span><span class="n">readX</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">peakHeight</span> <span class="o">=</span> <span class="n">allEiWs</span><span class="o">.</span><span class="n">readY</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">peakWidth</span>  <span class="o">=</span> <span class="n">allEiWs</span><span class="o">.</span><span class="n">readE</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="c1"># Check if peaks positions are indeed correct:</span>
<span class="c1">#-------------------------------------------------------------</span>
<span class="n">resEi</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">ei_guess</span> <span class="ow">in</span> <span class="n">allEi</span><span class="p">:</span>
   <span class="n">nop</span><span class="p">,</span><span class="n">t_peak</span><span class="p">,</span><span class="n">monIndex</span><span class="p">,</span><span class="n">tZero</span><span class="o">=</span><span class="n">GetEi</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">Monitor1Spec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Monitor2Spec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">EnergyEstimate</span><span class="o">=</span><span class="n">ei_guess</span><span class="p">)</span>
   <span class="n">resEi</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nop</span><span class="p">,</span><span class="n">t_peak</span><span class="p">));</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;! Guess Ei ! peak TOF ! peak height ! peak width !&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resEi</span><span class="p">):</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!  </span><span class="si">{0: &gt;6.1f}</span><span class="s2">  !  </span><span class="si">{1: &gt;6.2f}</span><span class="s2"> !   </span><span class="si">{2: &gt;6.2f}</span><span class="s2">    ! </span><span class="si">{3: &gt;6.2f}</span><span class="s2">     !&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">allEi</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">peakHeight</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">peakWidth</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
<span class="c1">#</span>
<span class="c1"># NOTE: incident energy of GetEi is calculated from distance between monitor 1 and 2, and this distance is not correct in</span>
<span class="c1"># the test workspace. The tested point is that getEi can find energies from guess values and TOF for peaks is correct.</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>! Guess Ei ! peak TOF ! peak height ! peak width !
!    67.0  !  4188.03 !    34.68    !   2.35     !
!   124.1  !  3079.09 !    14.01    !   4.35     !
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Inelastic/Ei.html">Inelastic\Ei</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Algorithms/inc/MantidAlgorithms/GetAllEi.h">GetAllEi.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Algorithms/src/GetAllEi.cpp">GetAllEi.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="GeneratePythonScript-v1.html" title="Previous Chapter: GeneratePythonScript v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; GeneratePytho...</span>
    </a>
  </li>
  <li>
    <a href="GetDetectorOffsets-v1.html" title="Next Chapter: GetDetectorOffsets v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">GetDetectorOffsets v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>