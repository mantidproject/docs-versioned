<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>SCDCalibratePanels v2</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SNAPReduce v1" href="SNAPReduce-v1.html" />
    <link rel="prev" title="SCDCalibratePanels v1" href="SCDCalibratePanels-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">SCDCalibratePanels v2</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="scdcalibratepanels-v2">
<span id="algm-scdcalibratepanels"></span><span id="algm-scdcalibratepanels-v2"></span><h1>SCDCalibratePanels v2<a class="headerlink" href="#scdcalibratepanels-v2" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/SCDCalibratePanels-v2_dlg.png"><img alt="../_images/SCDCalibratePanels-v2_dlg.png" class="screenshot" src="../_images/SCDCalibratePanels-v2_dlg.png" style="width: 349px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>SCDCalibratePanels</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id3">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id4">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id5">Description</a></p></li>
<li><p><a class="reference internal" href="#calibrating-instrument" id="id6">Calibrating Instrument</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id7">Usage</a></p></li>
<li><p><a class="reference internal" href="#future-development" id="id8">Future Development</a></p></li>
<li><p><a class="reference internal" href="#source" id="id9">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Panel parameters and L1 are optimized to minimize errors between theoretical and actual q values for the peaks</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="CalculateUMatrix-v1.html#algm-calculateumatrix"><span class="std std-ref">CalculateUMatrix</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>PeakWorkspace</p></td>
<td><p>Input</p></td>
<td><p>IPeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Workspace of Indexed Peaks</p></td>
</tr>
<tr class="row-odd"><td><p>RecalculateUB</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Recalculate UB matrix using given lattice constants</p></td>
</tr>
<tr class="row-even"><td><p>a</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter a (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-odd"><td><p>b</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter b (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-even"><td><p>c</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter c (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-odd"><td><p>alpha</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter alpha in degrees (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-even"><td><p>beta</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter beta in degrees (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-odd"><td><p>gamma</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>Lattice Parameter gamma in degrees (Leave empty to use lattice constants in peaks workspace)</p></td>
</tr>
<tr class="row-even"><td><p>Tolerance</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.15</p></td>
<td><p>Peak indexing tolerance</p></td>
</tr>
<tr class="row-odd"><td><p>CalibrateL1</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Change the L1(source to sample) distance</p></td>
</tr>
<tr class="row-even"><td><p>SearchRadiusL1</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.1</p></td>
<td><p>Search radius of delta L1 in meters, which is used to constrain optimization search spacewhen calibrating L1</p></td>
</tr>
<tr class="row-odd"><td><p>CalibrateBanks</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Calibrate position and orientation of each bank.</p></td>
</tr>
<tr class="row-even"><td><p>SearchRadiusTransBank</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.05</p></td>
<td><p>This is the search radius (in meter) when calibrating component translations, used to constrain optimizationsearch space when calibration translation of banks</p></td>
</tr>
<tr class="row-odd"><td><p>SearchradiusRotXBank</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>This is the search radius (in deg) when calibrating component reorientation, used to constrain optimization search space</p></td>
</tr>
<tr class="row-even"><td><p>SearchradiusRotYBank</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>This is the search radius (in deg) when calibrating component reorientation, used to constrain optimization search space</p></td>
</tr>
<tr class="row-odd"><td><p>SearchradiusRotZBank</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>This is the search radius (in deg) when calibrating component reorientation, used to constrain optimization search space</p></td>
</tr>
<tr class="row-even"><td><p>CalibrateSize</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Calibrate detector size for each bank.</p></td>
</tr>
<tr class="row-odd"><td><p>SearchRadiusSize</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0</p></td>
<td><p>This is the search radius (unit less) of scale factor around at value 1.0 when calibrating component size if it is a rectangualr detector.</p></td>
</tr>
<tr class="row-even"><td><p>FixAspectRatio</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>If true, the scaling factor for detector along X- and Y-axis must be the same.  Otherwise, the 2 scaling factors are free.</p></td>
</tr>
<tr class="row-odd"><td><p>BankName</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td></td>
<td><p>If given, only the specified bank/component will be calibrated.Otherwise, all banks will be calibrated.</p></td>
</tr>
<tr class="row-even"><td><p>CalibrateT0</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Calibrate the T0 (initial TOF)</p></td>
</tr>
<tr class="row-odd"><td><p>SearchRadiusT0</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>10</p></td>
<td><p>Search radius of T0 (in ms), used to constrain optimization search space</p></td>
</tr>
<tr class="row-even"><td><p>TuneSamplePosition</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Fine tunning sample position</p></td>
</tr>
<tr class="row-odd"><td><p>SearchRadiusSamplePos</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0.1</p></td>
<td><p>Search radius of sample position change (in meters), used to constrain optimization search space</p></td>
</tr>
<tr class="row-even"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The workspace containing the calibration table.</p></td>
</tr>
<tr class="row-odd"><td><p>T0</p></td>
<td><p>Output</p></td>
<td><p>number</p></td>
<td></td>
<td><p>Returns the TOF offset from optimization</p></td>
</tr>
<tr class="row-even"><td><p>DetCalFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>SCDCalibrate2.DetCal</p></td>
<td><p>Path to an ISAW-style .detcal file to save. Allowed extensions: [‘.detcal’, ‘.det_cal’]</p></td>
</tr>
<tr class="row-odd"><td><p>XmlFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>SCDCalibrate2.xml</p></td>
<td><p>Path to an Mantid .xml description(for LoadParameterFile) file to save. Allowed extensions: [‘.xml’]</p></td>
</tr>
<tr class="row-even"><td><p>CSVFilename</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>SCDCalibrate2.csv</p></td>
<td><p>Path to an .csv file which contains the Calibration Table. Allowed extensions: [‘.csv’]</p></td>
</tr>
<tr class="row-odd"><td><p>VerboseOutput</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Toggle of child algorithm console output.</p></td>
</tr>
<tr class="row-even"><td><p>ProfileL1</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Perform profiling of objective function with given input for L1</p></td>
</tr>
<tr class="row-odd"><td><p>ProfileBanks</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Perform profiling of objective function with given input for Banks</p></td>
</tr>
<tr class="row-even"><td><p>ProfileT0</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Perform profiling of objective function with given input for T0</p></td>
</tr>
<tr class="row-odd"><td><p>ProfileL1T0</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Perform profiling of objective function along L1 and T0</p></td>
</tr>
<tr class="row-even"><td><p>MaxFitIterations</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>500</p></td>
<td><p>Stop after this number of iterations if a good fit is not found</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>This calibration algorithm is developed for TOPAZ type instrument (flat panels).
The calibration targets includes:</p>
<ol class="arabic simple">
<li><p><cite>L_1</cite>, also known as the source to sample distance in meters</p></li>
<li><p>Panel position (in meters) and orientation (as angle-axis pairs, in degrees)</p></li>
<li><p><cite>T0</cite>, also known as initial TOF offset (in micro seconds).</p></li>
<li><p>sample position, also known as the inital sample position offest, which are
three offests (in meters) of the sample stage along x, y, z in lab reference frame.</p></li>
</ol>
<p>The underlining mechanism of this calibration is to match the measured Q vectors
(<cite>Q_{sample}</cite>) with the those generated from tweaked instrument position and orientation,
i.e.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\left\vert 2\pi \rm U \rm B \left(
                            \begin{array}{c}
                              NINT(h_i) \\
                              NINT(k_i) \\
                              NINT(l_i) \\
                            \end{array}
                          \right) - \rm Q_{sample,i}(p) \right\vert ^2\end{split}\]</div>
<p>where NINT is the nearest integer function.
To improve the speed of calibration of the whole instrument, openMP was used for calibration
of banks (panels).
Users are recommended to use the mantid.usersettings to restrict number of threads if the
calibration is run on a system with limited computing resources.</p>
</section>
<section id="calibrating-instrument">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Calibrating Instrument</a><a class="headerlink" href="#calibrating-instrument" title="Permalink to this heading">¶</a></h2>
<p>The calibration of an instrument can vary greatly from one instrument to another.
However, here are some key points to keep in mind while using this calibration algorithm to calibrate an
instrument:</p>
<ol class="arabic simple">
<li><p>Always double-check the attached UB matrix or make sure correct lattice constant is provided to the calibration
algoirthm with <cite>RecalculateUB</cite> enabled.
This calibration algorithm is not smart enough to recognize incorrect UB matrix or lattice constant on-the-fly.</p></li>
<li><p>Try to calibrate <cite>L1</cite>, <cite>T0</cite> and <cite>sample position</cite> within the same calibration process by checking all of them
as the optimizer will have a better chance to find the global minimum.
Otherwise, a manual or semi-manual iterative call of this calibration algorithm is needed to locate the acutal
minimum, which can be time consuming and error prone.</p></li>
<li><p>Please provide reasonable search radius for the calibration target as a too-narrow search radius will force the
optmizer to settle at the boundary while a too-wide search radius might yield some physically unrealistic
results (e.g. it is highly unlikely that a detector is off by a few meters from its engineering position).</p></li>
<li><p>This calibration algoritm does <strong>NOT</strong> modify the instruemnt attached to the input workspace.
But the UB matrix attached to the input workspace will be modified if the <cite>RecalculateUB</cite> is elected as part of
the calibration process.</p></li>
<li><p>This calibration algorithm can generate ISAW detector calibration file (.detcal file), mantid instrument parameter
file (.xml) as well as an ASCII table format of CORELLI calibration table (.csv).
The XML file contains all calibration results whereas the detcal file will miss the information on sample position.
The CORELLI calibration does not support neither T0 or sample position, therefore the users might need to use the other
two formats to supplement it if this ASCII table is the primary calibration media.</p></li>
<li><p>The advanced option section provides several profiling options, which are mostly intended for experienced beamline scientists
and Mantid developers.
Regular users are recommended to stay away from this section as running parameter space profiling is very time consuming, and
the results are often irrelavent to the data reduction.</p></li>
</ol>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># necessary import</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">mantid.simpleapi</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">mantid.geometry</span> <span class="kn">import</span> <span class="n">CrystalStructure</span>

<span class="c1"># generate synthetic testing data</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">dictionary</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;GenericDict&#39;</span><span class="p">,</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">())(</span><span class="o">**</span><span class="n">dictionary</span><span class="p">)</span>

<span class="c1"># lattice constant for Si</span>
<span class="c1"># data from Mantid web documentation</span>
<span class="n">lc_silicon</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mf">5.431</span><span class="p">,</span>  <span class="c1"># A</span>
    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mf">5.431</span><span class="p">,</span>  <span class="c1"># A</span>
    <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mf">5.431</span><span class="p">,</span>  <span class="c1"># A</span>
    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>  <span class="c1"># deg</span>
    <span class="s2">&quot;beta&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>  <span class="c1"># deg</span>
    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>  <span class="c1"># deg</span>
<span class="p">}</span>
<span class="n">silicon</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">lc_silicon</span><span class="p">)</span>
<span class="n">cs_silicon</span> <span class="o">=</span> <span class="n">CrystalStructure</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">silicon</span><span class="o">.</span><span class="n">a</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">silicon</span><span class="o">.</span><span class="n">b</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">silicon</span><span class="o">.</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="s2">&quot;F d -3 m&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Si 0 0 0 1.0 0.05&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Generate simulated workspace for TOPAZ</span>
<span class="n">CreateSimulationWorkspace</span><span class="p">(</span>
    <span class="n">Instrument</span><span class="o">=</span><span class="s1">&#39;TOPAZ&#39;</span><span class="p">,</span>
    <span class="n">BinParams</span><span class="o">=</span><span class="s1">&#39;1,100,10000&#39;</span><span class="p">,</span>
    <span class="n">UnitX</span><span class="o">=</span><span class="s1">&#39;TOF&#39;</span><span class="p">,</span>
    <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;cws&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cws</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;cws&#39;</span><span class="p">]</span>

<span class="c1"># Set the UB matrix for the sample</span>
<span class="c1"># u, v is the critical part, we can start with the</span>
<span class="c1"># ideal position</span>
<span class="n">SetUB</span><span class="p">(</span>
    <span class="n">Workspace</span><span class="o">=</span><span class="s2">&quot;cws&quot;</span><span class="p">,</span>
    <span class="n">u</span><span class="o">=</span><span class="s1">&#39;1,0,0&#39;</span><span class="p">,</span>  <span class="c1"># vector along k_i, when goniometer is at 0</span>
    <span class="n">v</span><span class="o">=</span><span class="s1">&#39;0,1,0&#39;</span><span class="p">,</span>  <span class="c1"># in-plane vector normal to k_i, when goniometer is at 0</span>
    <span class="o">**</span><span class="n">lc_silicon</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># set the crystal structure for virtual workspace</span>
<span class="n">cws</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">setCrystalStructure</span><span class="p">(</span><span class="n">cs_silicon</span><span class="p">)</span>

<span class="c1"># tweak L1</span>
<span class="n">dL1</span> <span class="o">=</span> <span class="mf">1.414e-2</span>  <span class="c1"># 1.414cm</span>
<span class="n">MoveInstrumentComponent</span><span class="p">(</span>
    <span class="n">Workspace</span><span class="o">=</span><span class="s1">&#39;cws&#39;</span><span class="p">,</span>
    <span class="n">ComponentName</span><span class="o">=</span><span class="s1">&#39;moderator&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X&#39;</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="o">=</span><span class="n">dL1</span><span class="p">,</span>
    <span class="n">RelativePosition</span><span class="o">=</span><span class="n">true</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Generate predicted peak workspace</span>
<span class="n">dspacings</span> <span class="o">=</span> <span class="n">convert</span><span class="p">({</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">})</span>
<span class="n">wavelengths</span> <span class="o">=</span> <span class="n">convert</span><span class="p">({</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mf">2.9</span><span class="p">})</span>

<span class="c1"># Collect peaks over a range of omegas</span>
<span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;pws&#39;</span><span class="p">)</span>
<span class="n">omegas</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="k">for</span> <span class="n">omega</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">omegas</span><span class="p">):</span>
    <span class="n">SetGoniometer</span><span class="p">(</span>
        <span class="n">Workspace</span><span class="o">=</span><span class="s2">&quot;cws&quot;</span><span class="p">,</span>
        <span class="n">Axis0</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">omega</span><span class="si">}</span><span class="s2">,0,1,0,1&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">PredictPeaks</span><span class="p">(</span>
        <span class="n">InputWorkspace</span><span class="o">=</span><span class="s1">&#39;cws&#39;</span><span class="p">,</span>
        <span class="n">WavelengthMin</span><span class="o">=</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
        <span class="n">wavelengthMax</span><span class="o">=</span><span class="n">wavelengths</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
        <span class="n">MinDSpacing</span><span class="o">=</span><span class="n">dspacings</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
        <span class="n">MaxDSpacing</span><span class="o">=</span><span class="n">dspacings</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
        <span class="n">ReflectionCondition</span><span class="o">=</span><span class="s1">&#39;All-face centred&#39;</span><span class="p">,</span>
        <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;_pws&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">CombinePeaksWorkspaces</span><span class="p">(</span>
        <span class="n">LHSWorkspace</span><span class="o">=</span><span class="s2">&quot;_pws&quot;</span><span class="p">,</span>
        <span class="n">RHSWorkspace</span><span class="o">=</span><span class="s2">&quot;pws&quot;</span><span class="p">,</span>
        <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s2">&quot;pws&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="n">pws</span> <span class="o">=</span> <span class="n">mtd</span><span class="p">[</span><span class="s1">&#39;pws&#39;</span><span class="p">]</span>

<span class="c1"># move the source back to make PWS forget the answer</span>
<span class="n">MoveInstrumentComponent</span><span class="p">(</span>
    <span class="n">Workspace</span><span class="o">=</span><span class="s1">&#39;pws&#39;</span><span class="p">,</span>
    <span class="n">ComponentName</span><span class="o">=</span><span class="s1">&#39;moderator&#39;</span><span class="p">,</span>
    <span class="s1">&#39;X&#39;</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="o">=-</span><span class="n">dL1</span><span class="p">,</span>
    <span class="n">RelativePosition</span><span class="o">=</span><span class="n">true</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># run the calibration on pws</span>
<span class="c1"># similar to actual calibration, where</span>
<span class="c1">#   1. the peaks in side pws knows the correct L1, but info is embeded in Qsamples</span>
<span class="c1">#   2. the recored L1 in instrument Info is the default engineering value</span>
<span class="n">SCDCalibratePanels</span><span class="p">(</span>
    <span class="n">PeakWorkspace</span><span class="o">=</span><span class="s2">&quot;pws&quot;</span><span class="p">,</span>
    <span class="n">a</span><span class="o">=</span><span class="n">silicon</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
    <span class="n">b</span><span class="o">=</span><span class="n">silicon</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="n">silicon</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="n">silicon</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
    <span class="n">beta</span><span class="o">=</span><span class="n">silicon</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
    <span class="n">gamma</span><span class="o">=</span><span class="n">silicon</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
    <span class="n">CalibrateL1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">CalibrateBanks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">CalibrateT0</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">TuneSamplePosition</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s2">&quot;testCaliTable&quot;</span><span class="p">,</span>
    <span class="n">XmlFilename</span><span class="o">=</span><span class="s2">&quot;test.xml&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This calibration should be able to correct the <cite>L1</cite> recorded in the instrument info using
the information embeded in all peaks.</p>
</section>
<section id="future-development">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Future Development</a><a class="headerlink" href="#future-development" title="Permalink to this heading">¶</a></h2>
<p>This algorithm is a work-in-progress as the development team as well as the instrument
scientists are working on the following targets:</p>
<ol class="arabic simple">
<li><p>The current data structure (detector representation) is not suitable for calibrating
instrument with tube-type detectors (such as CORELLI).
Additional work on an improved internal detector and scattering vector representation
are needed in order to make this toolkit useful for CORELLI like instrument.</p></li>
<li><p>In the current implementation, the calibration results are recorded as the absolute
position and orientation of each component, which does not provide an intuitive
representation of the calibration outcome.
Per instrument scientists’ request, a debug-type output where additional information
should be provided in a CSV file, including but not limited to</p>
<ol class="loweralpha simple">
<li><p>Relative translation and rotation with respect to the engineering position of each
component.</p></li>
<li><p>The optimization benchmark and ChiSquare for each component.</p></li>
<li><p>The original ISAW app also provide some plots that assist the visualization of calibration
results, which could be useful as part of the debug output.</p></li>
</ol>
</li>
</ol>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Crystal/Corrections.html">Crystal\Corrections</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Crystal/inc/MantidCrystal/SCDCalibratePanels2.h">SCDCalibratePanels2.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Crystal/src/SCDCalibratePanels2.cpp">SCDCalibratePanels2.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="SCDCalibratePanels-v1.html" title="Previous Chapter: SCDCalibratePanels v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; SCDCalibratePanels v1</span>
    </a>
  </li>
  <li>
    <a href="SNAPReduce-v1.html" title="Next Chapter: SNAPReduce v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">SNAPReduce v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>