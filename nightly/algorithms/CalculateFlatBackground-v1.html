<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>CalculateFlatBackground v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="CalculateFlux v1" href="CalculateFlux-v1.html" />
    <link rel="prev" title="CalculateEfficiencyCorrection v1" href="CalculateEfficiencyCorrection-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">CalculateFlatBackground v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="calculateflatbackground-v1">
<span id="algm-calculateflatbackground"></span><span id="algm-calculateflatbackground-v1"></span><h1>CalculateFlatBackground v1<a class="headerlink" href="#calculateflatbackground-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/CalculateFlatBackground-v1_dlg.png"><img alt="../_images/CalculateFlatBackground-v1_dlg.png" class="screenshot" src="../_images/CalculateFlatBackground-v1_dlg.png" style="width: 349px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>CalculateFlatBackground</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p></li>
<li><p><a class="reference internal" href="#properties" id="id3">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id4">Description</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id5">Usage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id6">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Finds a constant background value of each desired histogram.</p>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>InputWorkspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The input workspace must either have constant width bins or is a distribution workspace. It is also assumed that all spectra have the same X bin boundaries</p></td>
</tr>
<tr class="row-odd"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Name to use for the output workspace.</p></td>
</tr>
<tr class="row-even"><td><p>StartX</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>The X value at which to start the background fit. Mandatory for the Linear Fit and Mean modes, ignored by Moving Average.</p></td>
</tr>
<tr class="row-odd"><td><p>EndX</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>The X value at which to end the background fit. Mandatory for the Linear Fit and Mean modes, ignored by Moving Average.</p></td>
</tr>
<tr class="row-even"><td><p>WorkspaceIndexList</p></td>
<td><p>Input</p></td>
<td><p>int list</p></td>
<td></td>
<td><p>Indices of the spectra that will have their background removed default: modify all spectra</p></td>
</tr>
<tr class="row-odd"><td><p>Mode</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Linear Fit</p></td>
<td><p>The background count rate is estimated either by taking a mean, doing a linear fit, or taking the minimum of a moving average (default: Linear Fit). Allowed values: [‘Linear Fit’, ‘Mean’, ‘Moving Average’]</p></td>
</tr>
<tr class="row-even"><td><p>OutputMode</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Subtract Background</p></td>
<td><p>Once the background has been determined it can either be subtracted from  the InputWorkspace and returned or just returned (default: Subtract Background). Allowed values: [‘Subtract Background’, ‘Return Background’]</p></td>
</tr>
<tr class="row-odd"><td><p>SkipMonitors</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>By default, the algorithm calculates and removes background from monitors in the same way as from normal detectors If this property is set to true, background is not calculated/removed from monitors.</p></td>
</tr>
<tr class="row-even"><td><p>NullifyNegativeValues</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>When background is subtracted, signals in some time channels may become negative. If this option is true, signal in such bins is nullified and the module of the removed signalis added to the error. If false, the signal and errors are left unchanged</p></td>
</tr>
<tr class="row-odd"><td><p>AveragingWindowWidth</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>The width of the moving average window in bins. Mandatory for the Moving Average mode.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>This algorithm calculates the backgrounds for the histograms in a workspace. The backgrounds can be returned as-is, or directly subtracted from the input workspace depending on <em>OutputMode</em>.</p>
<p>There are three modes of operation: <strong>Linear Fit</strong> fits a line to the range specified by <em>StartX</em> and <em>EndX</em> and uses the mid-point as the background. <strong>Mean</strong> calculates the mean in same range. Finally, <strong>Moving Average</strong> calculates a rolling average with cyclic boundary conditions over the histograms of the input workspace. Width of the averaging window can be specified by <em>AveragingWindowWidth</em>.</p>
<p>The error of the background is only calculated when <strong>Mean</strong> or <strong>Moving Average</strong> is used. It is the errors in all the bins in the background region or averaging window, summed in quadrature and divided by the number of bins. This background error value is added in quadrature to the errors in each bin of the input workspace if <strong>Subtract Background</strong> is specified, otherwise returned in the background workspace.</p>
<p>If <em>NullifyNegativeValues</em> is true, the background is set to the corresponding y value for the bins/points which would become negative when the background is subtracted. In these cases, the errors are set to either the background value or to the original error, whichever is greater.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Generally, using <strong>Subtract Background</strong> directly or subtracting the returned background manually later produces the same end result. This is not true, however, for the errors if <em>NullifyNegativeValues</em> is set. In this case <strong>Subtract Background</strong> will set the errors for the otherwise negative y values either to the background value or to the original error, whereas manual subtraction will add the background errors to the original ones in quadrature.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Care should be taken when subtracting the returned background from other workspaces than the input workspace if <em>NullifyNegativeValues</em> is set. For backgrounds corresponding to the y value which would be zeroed, this algorithm returns the original y values instead of the actual background.</p>
</div>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p><strong>Example - Subtracting background using Linear Fit (using a distribution):</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">]</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">CreateWorkspace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">Distribution</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">CalculateFlatBackground</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span>
                                 <span class="n">StartX</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">EndX</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                 <span class="n">Mode</span><span class="o">=</span><span class="s1">&#39;Linear Fit&#39;</span><span class="p">,</span>
                                 <span class="n">OutputMode</span><span class="o">=</span><span class="s1">&#39;Subtract Background&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Values with subtracted background: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">readY</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Values with subtracted background: [ 2.  0.  0.  0.  6.  0.]
</pre></div>
</div>
<p><strong>Example - Returning background using Mean (using a histogram):</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">]</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">CreateWorkspace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">CalculateFlatBackground</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span>
                                 <span class="n">StartX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">EndX</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">Mode</span><span class="o">=</span><span class="s1">&#39;Mean&#39;</span><span class="p">,</span>
                                 <span class="n">OutputMode</span><span class="o">=</span><span class="s1">&#39;Return Background&#39;</span><span class="p">)</span>

<span class="c1"># Note how some bins in the output workspace will be different from</span>
<span class="c1"># 3 (even negative!). By default, NullifyNegativeValues will be set</span>
<span class="c1"># to true, and subtracting the output from the input workspace will</span>
<span class="c1"># set these bins to zero.</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculated Mean background: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">readY</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
<span class="n">subtracted</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">-</span> <span class="n">output</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background subtracted: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">subtracted</span><span class="o">.</span><span class="n">readY</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Calculated Mean background: [ 3.  3.  2.  3. -3.]
Background subtracted: [ 0.  1.  0.  0.  0.]
</pre></div>
</div>
<p><strong>Example - Returning background using Moving Average (using a histogram):</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">def</span> <span class="nf">spectrum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># A fancy triple-peak-shaped spectrum</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">5.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">z</span> <span class="o">/</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.0</span>

<span class="c1"># Equidistant x grid. Represents bin boundaries</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">9.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="c1"># y is a bin shorter than x and has to be evaluated at bin centres.</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">CreateWorkspace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">CalculateFlatBackground</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span>
                                 <span class="n">AveragingWindowWidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">Mode</span><span class="o">=</span><span class="s1">&#39;Moving Average&#39;</span><span class="p">,</span>
                                 <span class="n">OutputMode</span><span class="o">=</span><span class="s1">&#39;Return Background&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Background using moving window average: </span><span class="si">{0:.4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">readY</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;True minimum: </span><span class="si">{0:.4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">readY</span><span class="p">(</span><span class="mi">0</span><span class="p">))))</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Background using moving window average: 0.09483
True minimum: 0.04894
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/SANS.html">SANS</a> | <a class="reference external" href="categories/CorrectionFunctions/BackgroundCorrections.html">CorrectionFunctions\BackgroundCorrections</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/ec01dd0095c93d22fbc1c7a502ff628a4fee9a76/Framework/Algorithms/inc/MantidAlgorithms/CalculateFlatBackground.h">CalculateFlatBackground.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/ec01dd0095c93d22fbc1c7a502ff628a4fee9a76/Framework/Algorithms/src/CalculateFlatBackground.cpp">CalculateFlatBackground.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="CalculateEfficiencyCorrection-v1.html" title="Previous Chapter: CalculateEfficiencyCorrection v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; CalculateEffi...</span>
    </a>
  </li>
  <li>
    <a href="CalculateFlux-v1.html" title="Next Chapter: CalculateFlux v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">CalculateFlux v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>