<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>MonteCarloAbsorption v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MostLikelyMean v1" href="MostLikelyMean-v1.html" />
    <link rel="prev" title="MonitorLiveData v1" href="MonitorLiveData-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">MonteCarloAbsorption v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="montecarloabsorption-v1">
<span id="algm-montecarloabsorption"></span><span id="algm-montecarloabsorption-v1"></span><h1>MonteCarloAbsorption v1<a class="headerlink" href="#montecarloabsorption-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id7">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/MonteCarloAbsorption-v1_dlg.png"><img alt="../_images/MonteCarloAbsorption-v1_dlg.png" class="screenshot" src="../_images/MonteCarloAbsorption-v1_dlg.png" style="width: 349px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>MonteCarloAbsorption</strong> dialog.</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id9">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id10">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id11">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id12">Description</a></p>
<ul>
<li><p><a class="reference internal" href="#input-workspace-requirements" id="id13">Input Workspace Requirements</a></p></li>
<li><p><a class="reference internal" href="#method" id="id14">Method</a></p></li>
<li><p><a class="reference internal" href="#interpolation" id="id15">Interpolation</a></p></li>
<li><p><a class="reference internal" href="#sparse-instrument" id="id16">Sparse instrument</a></p>
<ul>
<li><p><a class="reference internal" href="#spatial-interpolation" id="id17">Spatial interpolation</a></p></li>
<li><p><a class="reference internal" href="#wavelength-interpolation-for-sparse-instruments" id="id18">Wavelength interpolation for sparse instruments</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#usage" id="id19">Usage</a></p></li>
<li><p><a class="reference internal" href="#references" id="id20">References</a></p></li>
<li><p><a class="reference internal" href="#source" id="id21">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Calculates attenuation due to absorption and scattering in a sample &amp; its environment using a Monte Carlo.</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="MayersSampleCorrection-v1.html#algm-mayerssamplecorrection"><span class="std std-ref">MayersSampleCorrection</span></a>, <a class="reference internal" href="CarpenterSampleCorrection-v1.html#algm-carpentersamplecorrection"><span class="std std-ref">CarpenterSampleCorrection</span></a>, <a class="reference internal" href="PearlMCAbsorption-v1.html#algm-pearlmcabsorption"><span class="std std-ref">PearlMCAbsorption</span></a>, <a class="reference internal" href="VesuvioCalculateMS-v1.html#algm-vesuviocalculatems"><span class="std std-ref">VesuvioCalculateMS</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>InputWorkspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The name of the input workspace.  The input workspace must have X units of wavelength.</p></td>
</tr>
<tr class="row-odd"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The name to use for the output workspace.</p></td>
</tr>
<tr class="row-even"><td><p>NumberOfWavelengthPoints</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p><em>Optional</em></p></td>
<td><p>The number of wavelength points for which a simulation is attempted if ResimulateTracksForDifferentWavelengths=true</p></td>
</tr>
<tr class="row-odd"><td><p>EventsPerPoint</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1000</p></td>
<td><p>The number of “neutron” events to generate per simulated point</p></td>
</tr>
<tr class="row-even"><td><p>SeedValue</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>123456789</p></td>
<td><p>Seed the random number generator with this value</p></td>
</tr>
<tr class="row-odd"><td><p>Interpolation</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Linear</p></td>
<td><p>Method of interpolation used to compute unsimulated values. Allowed values: [‘Linear’, ‘CSpline’]</p></td>
</tr>
<tr class="row-even"><td><p>SparseInstrument</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Enable simulation on special instrument with a sparse grid of detectors interpolating the results to the real instrument.</p></td>
</tr>
<tr class="row-odd"><td><p>NumberOfDetectorRows</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>5</p></td>
<td><p>Number of detector rows in the detector grid of the sparse instrument.</p></td>
</tr>
<tr class="row-even"><td><p>NumberOfDetectorColumns</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>10</p></td>
<td><p>Number of detector columns in the detector grid of the sparse instrument.</p></td>
</tr>
<tr class="row-odd"><td><p>MaxScatterPtAttempts</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>5000</p></td>
<td><p>Maximum number of tries made to generate a scattering point within the sample (+ optional container etc). Objects with holes in them, e.g. a thin annulus can cause problems if this number is too low. If a scattering point cannot be generated by increasing this value then there is most likely a problem with the sample geometry.</p></td>
</tr>
<tr class="row-even"><td><p>ResimulateTracksForDifferentWavelengths</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>Resimulate tracks for each wavelength point.</p></td>
</tr>
<tr class="row-odd"><td><p>SimulateScatteringPointIn</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>SampleAndEnvironment</p></td>
<td><p>Simulate the scattering point in the vicinity of the sample or its environment or both (default). Allowed values: [‘SampleAndEnvironment’, ‘SampleOnly’, ‘EnvironmentOnly’]</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>This algorithm performs a Monte Carlo simulation to calculate the correction factors due
to attenuation &amp; single scattering within a sample plus optionally its sample environment.</p>
<section id="input-workspace-requirements">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Input Workspace Requirements</a><a class="headerlink" href="#input-workspace-requirements" title="Permalink to this heading">¶</a></h3>
<p>The algorithm will compute the correction factors on a bin-by-bin basis for each spectrum within
the input workspace. The following assumptions on the input workspace will are made:</p>
<ul class="simple">
<li><p>X units are in wavelength</p></li>
<li><p>the instrument is fully defined</p></li>
<li><p>properties of the sample and optionally its environment have been set with
<a class="reference internal" href="SetSample-v1.html#algm-setsample"><span class="std std-ref">SetSample</span></a></p></li>
</ul>
<p>By default the beam is assumed to be the a slit with width and height matching
the width and height of the sample. This can be overridden using <a class="reference internal" href="SetBeam-v1.html#algm-setbeam"><span class="std std-ref">SetBeam</span></a>.</p>
</section>
<section id="method">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Method</a><a class="headerlink" href="#method" title="Permalink to this heading">¶</a></h3>
<p>By default, the material for the sample &amp; containers will define the values of the cross section used to compute the absorption factor and will
include contributions from both the total scattering cross section &amp; absorption cross section.
This follows the Hamilton-Darwin <a class="footnote-reference brackets" href="#dar" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, <a class="footnote-reference brackets" href="#ham" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> approach as described by T. M. Sabine in the International Tables of Crystallography Vol. C <a class="footnote-reference brackets" href="#sab" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>.</p>
<p>The algorithm proceeds as follows. For each spectrum:</p>
<ol class="arabic">
<li><p>find the associated detector position</p></li>
<li><p>find the associated efixed value (if applicable) &amp; convert to wavelength (<span class="math notranslate nohighlight">\(\lambda_{fixed}\)</span>)</p></li>
<li><p>for each event in <cite>NEvents</cite></p>
<ul>
<li><p>loop over the bins.</p>
<ul>
<li><p>If <cite>ResimulateTracksForDifferentWavelengths</cite> = True then generate tracks using the following procedure for each wavelength step,
where the size of each wavelength step is defined by <cite>NumberOfWavelengthPoints</cite>. If <cite>ResimulateTracksForDifferentWavelengths</cite> = false
generate one set of tracks and define a step size of 1 ie all bins are visited. At the moment there are no wavelength dependent effects in the simulation that affect the simulation of the track geometry so the default value for <cite>ResimulateTracksForDifferentWavelengths</cite> is false.
For each step (<span class="math notranslate nohighlight">\(\lambda_{step}\)</span>)</p></li>
<li><p>generate a random point on the beam face defined by the input height &amp; width. If the point is outside of the
area defined by the face of the sample then it is pulled to the boundary of this area</p></li>
<li><p>generate a random point within the sample or container objects as the scatter point and create a <cite>Track</cite>
from the selected position on the beam face to the scatter point</p></li>
<li><p>test for intersections of the track &amp; sample/container objects, giving the number of subsections
and corresponding distances within the object for each section, call them <span class="math notranslate nohighlight">\(l_{1i}\)</span></p></li>
<li><p>form a second <cite>Track</cite> with the scatter position as the starting point and the direction defined by
<cite>detPos - scatterPos</cite></p></li>
<li><p>test for intersections of the track &amp; sample/container objects, giving the number of subsections
and corresponding distances within the object for each section, call them <span class="math notranslate nohighlight">\(l_{2i}\)</span></p></li>
<li><p>define <span class="math notranslate nohighlight">\(\lambda_1\)</span> as the wavelength before scattering &amp; <span class="math notranslate nohighlight">\(\lambda_2\)</span> as wavelength after scattering:</p>
<blockquote>
<div><ul class="simple">
<li><p>Direct: <span class="math notranslate nohighlight">\(\lambda_1 = \lambda_1\)</span>, <span class="math notranslate nohighlight">\(\lambda_2 = \lambda_{step}\)</span></p></li>
<li><p>Indirect: <span class="math notranslate nohighlight">\(\lambda_1 = \lambda_{step}\)</span>, <span class="math notranslate nohighlight">\(\lambda_2 = \lambda_{fixed}\)</span></p></li>
<li><p>Elastic: <span class="math notranslate nohighlight">\(\lambda_1 = \lambda_2 = \lambda_{step}\)</span></p></li>
</ul>
</div></blockquote>
</li>
<li><p>compute the self-attenuation factor for all intersections as
<span class="math notranslate nohighlight">\(\prod\limits_{i} \exp(-(\rho_{1i}\sigma_{1i}(\lambda_{1i})l_{1i} + \rho_{2i}\sigma_{2i}(\lambda_{2i})l_{2i}))\)</span>
where <span class="math notranslate nohighlight">\(\rho\)</span> is the mass density of the material &amp;
<span class="math notranslate nohighlight">\(\sigma\)</span> the absorption cross-section at a given wavelength</p></li>
<li><p>accumulate this wavelength-specific factor across all <cite>NEvents</cite></p></li>
</ul>
</li>
</ul>
</li>
<li><p>average the accumulated attentuation factors over <cite>NEvents</cite> and assign this as the correction factor for
this <span class="math notranslate nohighlight">\(\lambda_{step}\)</span>. Calculate the error as the standard deviation of the accumulated attenuation factors divided by <span class="math notranslate nohighlight">\(\sqrt{NEvents}\)</span></p></li>
<li><p>finally, if <cite>ResimulateTracksForDifferentWavelengths</cite> = True, interpolate through the unsimulated wavelength points using the selected method</p></li>
</ol>
<p>The algorithm generates some statistics on the number of scatter points generated in the sample and each environment component if the logging level is set to debug.</p>
</section>
<section id="interpolation">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Interpolation</a><a class="headerlink" href="#interpolation" title="Permalink to this heading">¶</a></h3>
<p>The default linear interpolation method will produce an absorption curve that is not smooth. CSpline interpolation
will produce a smoother result by using a 3rd-order polynomial to approximate the original points - although if the data includes sudden changes it may introduce oscillations including negative values at the interpolated points.</p>
<p>The errors that the Monte Carlo simulation calculates for different wavelength points in a single spectrum may or may not be independent. If the same set of tracks have been used for different wavelengths (ResimulateTracksForDifferentWavelengths=False) then the errors will be correlated. A worst case positive correlation has been assumed giving an error on the interpolated point that is approximately the same as the surrounding simulated points.</p>
<p>If ResimulateTracksForDifferentWavelengths=True then the errors on the simulated points will be independent and the errors can be combined using standard formulae for combining errors on independent variables.</p>
<p>The error propagation through the spline interpolation is complex because each cubic polynomial is usually expressed as a function of the known y values and a derivative of those y values at the same points (some texts use the first derivative others the second). The error in y and the derivative of y are correlated at a particular x value and the derivatives at different x values are also correlated. So some extra covariances are required in addition to the error (variance) of each y value. The method followed <a class="footnote-reference brackets" href="#gar" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> involves inverting a symmetric tridiagonal matrix and an analytic calculation for the inversion has been implemented to minimize the run time <a class="footnote-reference brackets" href="#huo" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p>
</section>
<section id="sparse-instrument">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Sparse instrument</a><a class="headerlink" href="#sparse-instrument" title="Permalink to this heading">¶</a></h3>
<p>The simulation may take long to complete on instruments with a large number of detectors. To speed up the simulation, the instrument can be approximated by a sparse grid of detectors. The behavior can be enabled by setting the <em>SparseInstrument</em> property to true.</p>
<p>The sparse instrument consists of a grid of detectors covering the full instrument entirely. The figure below shows an example of a such an instrument approximating the IN5 spectrometer at ILL.</p>
<figure class="align-default" id="id8">
<a class="reference internal image-reference" href="../_images/MonteCarloAbsorption_Sparse_Instrument.png"><img alt="IN5 spectrometer and its sparse approximation." src="../_images/MonteCarloAbsorption_Sparse_Instrument.png" style="width: 1054.2px; height: 298.2px;" /></a>
<figcaption>
<p><span class="caption-text">Absorption corrections for IN5 spectrometer interpolated from the sparse instrument shown on the right. The sparse instrument has 6 detector rows and 22 columns, a total of 132 detectors. IN5, on the other hand, has approximately 100000 detectors.</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is recommended to remove monitor spectra from the input workspace since these are included in the area covered by the sparse instrument and may make the detector grid unnecessarily large.</p>
</div>
<p>When the sparse instrument option is enabled, a sparse instrument corresponding to the instrument attached to the input workspace is created. The simulation is then run using the created instrument. Finally, the simulated absorption corrections are interpolated to the output workspace.</p>
<p>The interpolation is a two step process: first a spatial interpolation is done from the detector grid of the sparse instrument to the actual detector positions of the full instrument. Then, if <cite>ResimulateTracksForDifferentWavelengths</cite> = True the correction factors are interpolated over the missing wavelengths.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, the sparse instrument mode does not support instruments with varying <em>EFixed</em>.</p>
</div>
<section id="spatial-interpolation">
<h4><a class="toc-backref" href="#id17" role="doc-backlink">Spatial interpolation</a><a class="headerlink" href="#spatial-interpolation" title="Permalink to this heading">¶</a></h4>
<p>The sample to detector distance does not matter for absorption, so it suffices to consider directions only. The detector grid of the sparse instrument consists of detectors at constant latitude and longitude intervals. For a detector <span class="math notranslate nohighlight">\(D\)</span> of the full input instrument at latitude <span class="math notranslate nohighlight">\(\phi\)</span> and longitude <span class="math notranslate nohighlight">\(\lambda\)</span>, we pick the four detectors <span class="math notranslate nohighlight">\(D_{ij}\)</span> (<span class="math notranslate nohighlight">\(i = 1, 2\)</span> <span class="math notranslate nohighlight">\(j = 1, 2\)</span>) at the corners of the grid cell which includes (<span class="math notranslate nohighlight">\(\phi\)</span>, <span class="math notranslate nohighlight">\(\lambda\)</span>).</p>
<p>If <span class="math notranslate nohighlight">\(D\)</span> coincides with any <span class="math notranslate nohighlight">\(D_{ij}\)</span>, the <span class="math notranslate nohighlight">\(y\)</span> values of the histogram linked to <span class="math notranslate nohighlight">\(D\)</span> are directly taken from <span class="math notranslate nohighlight">\(D_{ij}\)</span>. Otherwise, <span class="math notranslate nohighlight">\(y\)</span> is interpolated using a bilinear interpolation method. The data is interpolated in the longitude direction first:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}y_1 = \frac{(\lambda_2 - \lambda) * y_{11} + (\lambda - \lambda_1) * y_{21}}{\lambda_2 - \lambda_1}\\y_2 = \frac{(\lambda_2 - \lambda) * y_{12} + (\lambda - \lambda_1) * y_{22}}{\lambda_2 - \lambda_1},\end{aligned}\end{align} \]</div>
<p>and then finally in the latitude direction:</p>
<div class="math notranslate nohighlight">
\[y = \frac{(\phi_2 - \phi) * y_1 + (\phi - \phi_1) * y_2}{\phi_2 - \phi_1}\]</div>
<p>The errors present in the 4 simulated histograms are assumed to be independent and they are propagated through the bilinear formulae given above to give one contribution to the error on the interpolated histogram. The second contribution is the interpolation error (how well the bilinear interpolation matches the actual attenuation factor variation). This is calculated based on the second derivative of the attenuation factor in the <span class="math notranslate nohighlight">\(\phi\)</span> and <span class="math notranslate nohighlight">\(\lambda\)</span> directions (<a class="footnote-reference brackets" href="#sev" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>)</p>
</section>
<section id="wavelength-interpolation-for-sparse-instruments">
<h4><a class="toc-backref" href="#id18" role="doc-backlink">Wavelength interpolation for sparse instruments</a><a class="headerlink" href="#wavelength-interpolation-for-sparse-instruments" title="Permalink to this heading">¶</a></h4>
<p>The wavelength points for simulation with the sparse instrument are chosen as follows:</p>
<ol class="arabic simple">
<li><p>Find the global minimum and maximum wavelengths of the input workspace.</p></li>
<li><p>Divide the wavelength interval to as many points as defined by the input parameters.</p></li>
</ol>
<p>After the simulation has been run and the spatial interpolation done, the interpolated histograms will be further interpolated to the wavelength points of the input workspace. This is done similarly to the full instrument case. If only a single wavelength point is specified, then the output histograms will be filled with the single simulated value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the input workspace contains varying bin widths then the output is always interpolated.</p>
</div>
</section>
</section>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p><strong>Example: A cylindrical sample with no container</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">WorkspaceType</span><span class="o">=</span><span class="s1">&#39;Histogram&#39;</span><span class="p">,</span> <span class="n">NumBanks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Target</span><span class="o">=</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">)</span>
<span class="c1"># Default up axis is Y</span>
<span class="n">SetSample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;Cylinder&#39;</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;Radius&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;Center&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]},</span>
                <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;(Li7)2-C-H4-N-Cl6&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">})</span>
<span class="c1"># Simulating every data point can be slow. Use a smaller set and interpolate</span>
<span class="n">abscor</span> <span class="o">=</span> <span class="n">MonteCarloAbsorption</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span><span class="o">/</span><span class="n">abscor</span>
</pre></div>
</div>
<p><strong>Example: A cylindrical sample with no container, resimulating tracks for different wavelengths, interpolating with a CSpline</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">WorkspaceType</span><span class="o">=</span><span class="s1">&#39;Histogram&#39;</span><span class="p">,</span> <span class="n">NumBanks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Target</span><span class="o">=</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">)</span>
<span class="c1"># Default up axis is Y</span>
<span class="n">SetSample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;Cylinder&#39;</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;Radius&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;Center&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]},</span>
                <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;(Li7)2-C-H4-N-Cl6&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">})</span>
<span class="c1"># Simulating every data point can be slow. Use a smaller set and interpolate</span>
<span class="n">abscor</span> <span class="o">=</span> <span class="n">MonteCarloAbsorption</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ResimulateTracksForDifferentWavelengths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NumberOfWavelengthPoints</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                              <span class="n">Interpolation</span><span class="o">=</span><span class="s1">&#39;CSpline&#39;</span><span class="p">)</span>
<span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span><span class="o">/</span><span class="n">abscor</span>
</pre></div>
</div>
<p><strong>Example: A cylindrical sample setting a beam size</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">WorkspaceType</span><span class="o">=</span><span class="s1">&#39;Histogram&#39;</span><span class="p">,</span> <span class="n">NumBanks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Target</span><span class="o">=</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">)</span>
<span class="c1"># Default up axis is Y</span>
<span class="n">SetSample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;Cylinder&#39;</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;Radius&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;Center&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]},</span>
                  <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;(Li7)2-C-H4-N-Cl6&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">})</span>
<span class="n">SetBeam</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;Slit&#39;</span><span class="p">,</span> <span class="s1">&#39;Width&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">})</span>
<span class="c1"># Simulating every data point can be slow. Use a smaller set and interpolate</span>
<span class="n">abscor</span> <span class="o">=</span> <span class="n">MonteCarloAbsorption</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">NumberOfWavelengthPoints</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span><span class="o">/</span><span class="n">abscor</span>
</pre></div>
</div>
<p><strong>Example: A cylindrical sample with predefined container</strong></p>
<p>The following example uses a test sample environment defined for the <code class="docutils literal notranslate"><span class="pre">TEST_LIVE</span></code>
facility and <code class="docutils literal notranslate"><span class="pre">ISIS_Histogram</span></code> instrument and assumes that these are set as the
default facility and instrument respectively. The definition can be found at
<code class="docutils literal notranslate"><span class="pre">[INSTALLDIR]/instrument/sampleenvironments/TEST_LIVE/ISIS_Histogram/CRYO-01.xml</span></code>.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">WorkspaceType</span><span class="o">=</span><span class="s1">&#39;Histogram&#39;</span><span class="p">,</span> <span class="n">NumBanks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Target</span><span class="o">=</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">)</span>
<span class="c1"># Sample geometry is defined by container but not completely filled so</span>
<span class="c1"># we just define the height</span>
<span class="n">SetSample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Environment</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;CRYO-01&#39;</span><span class="p">,</span> <span class="s1">&#39;Container&#39;</span><span class="p">:</span> <span class="s1">&#39;8mm&#39;</span><span class="p">},</span>
          <span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">},</span>
          <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;(Li7)2-C-H4-N-Cl6&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">})</span>
<span class="c1"># Simulating every data point can be slow. Use a smaller set and interpolate</span>
<span class="n">abscor</span> <span class="o">=</span> <span class="n">MonteCarloAbsorption</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span><span class="o">/</span><span class="n">abscor</span>
</pre></div>
</div>
<p><strong>Example: A cylindrical sample using a sparse instrument description, interpolating with a CSpline</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">CreateSampleWorkspace</span><span class="p">(</span><span class="n">WorkspaceType</span><span class="o">=</span><span class="s1">&#39;Histogram&#39;</span><span class="p">,</span> <span class="n">NumBanks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ConvertUnits</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Target</span><span class="o">=</span><span class="s1">&#39;Wavelength&#39;</span><span class="p">)</span>
<span class="n">SetSample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;Cylinder&#39;</span><span class="p">,</span> <span class="s1">&#39;Height&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;Radius&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;Center&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]},</span>
                <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;(Li7)2-C-H4-N-Cl6&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">},</span>
         <span class="p">)</span>

<span class="n">abscor</span> <span class="o">=</span> <span class="n">MonteCarloAbsorption</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">SparseInstrument</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">NumberOfDetectorRows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">NumberOfDetectorColumns</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                              <span class="n">Interpolation</span><span class="o">=</span><span class="s1">&#39;CSpline&#39;</span><span class="p">)</span>
<span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span><span class="o">/</span><span class="n">abscor</span>
</pre></div>
</div>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Permalink to this heading">¶</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="dar" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Darwin, C. G., <em>Philos. Mag.</em>, <strong>43</strong> 800 (1922)
<a class="reference external" href="http://dx.doi.org/10.1080/10448639208218770">doi: 10.1080/10448639208218770</a></p>
</aside>
<aside class="footnote brackets" id="ham" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>Hamilton, W.C., <em>Acta Cryst</em>, <strong>10</strong>, 629 (1957)
<a class="reference external" href="http://dx.doi.org/10.1107/S0365110X57002212">doi: 10.1107/S0365110X57002212</a></p>
</aside>
<aside class="footnote brackets" id="sab" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>Sabine, T. M., <em>International Tables for Crystallography</em>, Vol. C, Page 609, Ed. Wilson, A. J. C and Prince, E. Kluwer Publishers (2004)
<a class="reference external" href="http://dx.doi.org/10.1107/97809553602060000103">doi: 10.1107/97809553602060000103</a></p>
</aside>
<aside class="footnote brackets" id="gar" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p>Gardner, James L., <em>Journal of Research of the National Institute of Standards and Technology</em>, section 4 (2003),
<a class="reference external" href="https://nvlpubs.nist.gov/nistpubs/jres/108/1/j80gar.pdf">https://nvlpubs.nist.gov/nistpubs/jres/108/1/j80gar.pdf</a></p>
</aside>
<aside class="footnote brackets" id="sev" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">5</a><span class="fn-bracket">]</span></span>
<p>Severens, Ivo, technische universiteit eindhoven, (2003),
<a class="reference external" href="https://www.win.tue.nl/casa/meetings/seminar/previous/_abstract030122_files/4.pdf">https://www.win.tue.nl/casa/meetings/seminar/previous/_abstract030122_files/4.pdf</a></p>
</aside>
<aside class="footnote brackets" id="huo" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">6</a><span class="fn-bracket">]</span></span>
<p>Hu, G. Y., O’Connell, R.F. , <em>Journal of Physics A</em>, <strong>29</strong> 1511 (1996),
<a class="reference external" href="http://dx.doi.org/10.1088/0305-4470/29/7/020">doi: 10.1088/0305-4470/29/7/020</a>
Note: the following edits have been applied to the formulae in the paper for the case -2 &lt; D &lt; 2:
a) D = -2 cos <span class="math notranslate nohighlight">\(\lambda\)</span> has been implemented instead of D = 2 cos <span class="math notranslate nohighlight">\(\lambda\)</span>
b) equation (10) has been modified for the -2 &lt; D &lt; 2 case so that the leading minus sign on the right hand side is removed</p>
</aside>
</aside>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/CorrectionFunctions/AbsorptionCorrections.html">CorrectionFunctions\AbsorptionCorrections</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id21" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Algorithms/inc/MantidAlgorithms/MonteCarloAbsorption.h">MonteCarloAbsorption.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Algorithms/src/MonteCarloAbsorption.cpp">MonteCarloAbsorption.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="MonitorLiveData-v1.html" title="Previous Chapter: MonitorLiveData v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; MonitorLiveData v1</span>
    </a>
  </li>
  <li>
    <a href="MostLikelyMean-v1.html" title="Next Chapter: MostLikelyMean v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">MostLikelyMean v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>