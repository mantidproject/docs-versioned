<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>SofQWNormalisedPolygon v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SofQWPolygon v1" href="SofQWPolygon-v1.html" />
    <link rel="prev" title="SofQWMomentsScan v1" href="SofQWMomentsScan-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org"><img src="../_static/Mantid_Logo_Transparent.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.5</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">SofQWNormalisedPolygon v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="sofqwnormalisedpolygon-v1">
<span id="algm-sofqwnormalisedpolygon"></span><span id="algm-sofqwnormalisedpolygon-v1"></span><h1>SofQWNormalisedPolygon v1<a class="headerlink" href="#sofqwnormalisedpolygon-v1" title="Permalink to this heading">¶</a></h1>
<figure class="align-right" id="id1">
<span id="index-0"></span><a class="screenshot reference internal image-reference" href="../_images/SofQWNormalisedPolygon-v1_dlg.png"><img alt="../_images/SofQWNormalisedPolygon-v1_dlg.png" class="screenshot" src="../_images/SofQWNormalisedPolygon-v1_dlg.png" style="width: 302px;" /></a>
<figcaption>
<p><span class="caption-text"><strong>SofQWNormalisedPolygon</strong> dialog.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id2">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id3">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id4">Properties</a></p></li>
<li><p><a class="reference internal" href="#description" id="id5">Description</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id6">Usage</a></p></li>
<li><p><a class="reference internal" href="#source" id="id7">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Permalink to this heading">¶</a></h2>
<p>Calculate the intensity as a function of momentum transfer and energy.</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h3>
<p><a class="reference internal" href="SofQW-v1.html#algm-sofqw"><span class="std std-ref">SofQW</span></a>, <a class="reference internal" href="SofQWPolygon-v1.html#algm-sofqwpolygon"><span class="std std-ref">SofQWPolygon</span></a>, <a class="reference internal" href="Rebin2D-v1.html#algm-rebin2d"><span class="std std-ref">Rebin2D</span></a></p>
<p>This algorithm is also known as: <strong>SofQW3</strong></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Permalink to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>InputWorkspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>Reduced data in units of energy transfer DeltaE. The workspace must contain histogram data and have common bins across all spectra.</p></td>
</tr>
<tr class="row-odd"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The name to use for the q-omega workspace.</p></td>
</tr>
<tr class="row-even"><td><p>QAxisBinning</p></td>
<td><p>Input</p></td>
<td><p>dbl list</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The bin parameters to use for the q axis (in the format used by the <a class="reference internal" href="Rebin-v1.html#algm-rebin"><span class="std std-ref">Rebin v1</span></a> algorithm).</p></td>
</tr>
<tr class="row-odd"><td><p>EMode</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The energy transfer analysis mode (Direct/Indirect). Allowed values: [‘Direct’, ‘Indirect’]</p></td>
</tr>
<tr class="row-even"><td><p>EFixed</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0</p></td>
<td><p>The value of fixed energy: <span class="math notranslate nohighlight">\(E_i\)</span> (EMode=Direct) or <span class="math notranslate nohighlight">\(E_f\)</span> (EMode=Indirect) (meV). Must be set here if not available in the instrument definition.</p></td>
</tr>
<tr class="row-odd"><td><p>ReplaceNaNs</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>If true, all NaN values in the output workspace are replaced using the ReplaceSpecialValues algorithm.</p></td>
</tr>
<tr class="row-even"><td><p>EAxisBinning</p></td>
<td><p>Input</p></td>
<td><p>dbl list</p></td>
<td></td>
<td><p>The bin parameters to use for the E axis (optional, in the format used by the <a class="reference internal" href="Rebin-v1.html#algm-rebin"><span class="std std-ref">Rebin v1</span></a> algorithm).</p></td>
</tr>
<tr class="row-odd"><td><p>DetectorTwoThetaRanges</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/TableWorkspaces.html#table-workspaces"><span class="std std-ref">TableWorkspace</span></a></p></td>
<td></td>
<td><p>A table workspace use by SofQWNormalisedPolygon containing a ‘Detector ID’ column as well as ‘Min two theta’ and ‘Max two theta’ columns listing the detector’s min and max scattering angles in radians.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Permalink to this heading">¶</a></h2>
<p>Converts a 2D workspace from <a class="reference internal" href="../concepts/UnitFactory.html#unit-factory"><span class="std std-ref">units</span></a>
of spectrum number/<strong>energy transfer</strong>
to the intensity as a function of <strong>momentum transfer</strong> <span class="math notranslate nohighlight">\(Q\)</span>
and <strong>energy transfer</strong> <span class="math notranslate nohighlight">\(\Delta E\)</span>.</p>
<figure class="align-center">
<img alt="../_images/RebinnedOutputStep1.png" src="../_images/RebinnedOutputStep1.png" />
</figure>
<p>As shown in the figure, the input grid (pink-shaded parallelopiped,
aligned in scattering angle and energy transfer) is not parallel to the
output grid (square grid, aligned in <span class="math notranslate nohighlight">\(Q\)</span> and energy). This means
that the output bins will only ever partially overlap the input data. To
account for this, the signal <span class="math notranslate nohighlight">\(Y\)</span> and errors <span class="math notranslate nohighlight">\(E\)</span> in the new
bins are calculated as:</p>
<div class="math notranslate nohighlight">
\[Y^{\mathrm{new}} = \sum_i Y^{\mathrm{old}}_i F_i\]</div>
<div class="math notranslate nohighlight">
\[E^{\mathrm{new}} = \sqrt{\sum_i (E^{\mathrm{old}}_i)^2 F_i}\]</div>
<p>In addition to weighting the signal and error values, the total
fractional weights:</p>
<div class="math notranslate nohighlight">
\[F^{\mathrm{new}} = \sum_i F_i\]</div>
<p>are also stored in the output of this algorithm which is a new workspace
type: <strong>RebinnedOutput</strong>. To see why this is needed, consider rebinning
the output on a larger grid:</p>
<figure class="align-center">
<img alt="../_images/RebinnedOutputStep2.png" src="../_images/RebinnedOutputStep2.png" />
</figure>
<p>If the fractional weights are not chained as shown, then the area
shaded in a lighter blue under <span class="math notranslate nohighlight">\(A_1\)</span> (where originally there was
no data) would be included in the weights, which would be an
overestimate of the actual weights, leading to an overestimate of the
signal and error.</p>
<p>Finally, if there is a bin in the output grid which only has a very
small overlap with the input grid (for example at the edges of the
detector coverage), the fractional weight <span class="math notranslate nohighlight">\(F\)</span> of this bin, and
hence its signal <span class="math notranslate nohighlight">\(Y\)</span> and error <span class="math notranslate nohighlight">\(E\)</span> would be very small
compared to its neighbours. Thus, for display purposes, the actual
signal and errors stored in a RebinnedOutput are renomalised by the
weights:</p>
<div class="math notranslate nohighlight">
\[Y^{\mathrm{display}} = Y^{\mathrm{new}} / F^{\mathrm{new}}\]</div>
<div class="math notranslate nohighlight">
\[E^{\mathrm{display}} = E^{\mathrm{new}} / F^{\mathrm{new}}\]</div>
<p>at the end of the algorithm. The biggest consequence of this method is
that in places where there are no counts (<span class="math notranslate nohighlight">\(Y=0\)</span>) and no acceptance
(no fractional areas, <span class="math notranslate nohighlight">\(F=0\)</span>), <span class="math notranslate nohighlight">\(Y/F=\)</span><strong>nan</strong>-s will
result.</p>
<p>The algorithm operates in <em>non-PSD mode</em> by default. This means that the
scattering angle <span class="math notranslate nohighlight">\(2\theta\)</span> range covered by a detector is calculated for
each detector individually. For grouped detectors, it is the minimum and
maximum <span class="math notranslate nohighlight">\(2\theta\)</span> of all detectors in the group. The computation is
accurate for simple detector shapes (cylinder, cuboid); for other shapes a
more rough method is used. It is possible to provide precalculated
per-detector <span class="math notranslate nohighlight">\(2\theta\)</span> values using the <code class="docutils literal notranslate"><span class="pre">DetectorTwoThetaRanges</span></code> input
property.</p>
<p><em>PSD mode</em> will determine the detector <span class="math notranslate nohighlight">\(2\theta\)</span> ranges from the
instrument geometry. This mode is activated by placing the following named
parameter in the instrument definition file: <em>detector-neighbour-offset</em>. The
integer value of this parameter should be the number of pixels that separates
two pixels at the same vertical position in adjacent tubes.</p>
<p>See <a class="reference internal" href="SofQWCentre-v1.html#algm-sofqwcentre"><span class="std std-ref">SofQWCentre v1</span></a> for centre-point binning or <a class="reference internal" href="SofQWPolygon-v1.html#algm-sofqwpolygon"><span class="std std-ref">SofQWPolygon v1</span></a>
for simpler and less precise but faster binning strategies. The speed-up
is from ignoring the azimuthal positions of the detectors (as for the non-PSD
mode in this algorithm) but in addition, <a class="reference internal" href="SofQWPolygon-v1.html#algm-sofqwpolygon"><span class="std std-ref">SofQWPolygon v1</span></a> treats
all detectors as being the same, and characterised by a single width in
scattering angle. Thereafter, it weights the signal and error by the fractional
overlap, similarly to that shown in the first figure above, but then discards
the summed weights, producing a <strong>Workspace2D</strong> rather than a
<strong>RebinnedOutput</strong> workspace.</p>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Permalink to this heading">¶</a></h2>
<p><strong>Example - simple transformation of inelastic workspace:</strong></p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create sample inelastic workspace for MARI instrument containing 1 at all spectra</span>
<span class="n">ws</span><span class="o">=</span><span class="n">CreateSimulationWorkspace</span><span class="p">(</span><span class="n">Instrument</span><span class="o">=</span><span class="s1">&#39;MAR&#39;</span><span class="p">,</span><span class="n">BinParams</span><span class="o">=</span><span class="s1">&#39;-10,1,10&#39;</span><span class="p">)</span>
<span class="c1"># convert workspace into Matrix workspace with Q-dE coordinates</span>
<span class="n">ws</span><span class="o">=</span><span class="n">SofQWNormalisedPolygon</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span><span class="n">QAxisBinning</span><span class="o">=</span><span class="s1">&#39;-3,0.1,3&#39;</span><span class="p">,</span><span class="n">Emode</span><span class="o">=</span><span class="s1">&#39;Direct&#39;</span><span class="p">,</span><span class="n">EFixed</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The converted X-Y values are:&quot;</span><span class="p">)</span>
<span class="n">Xrow</span><span class="o">=</span><span class="n">ws</span><span class="o">.</span><span class="n">readX</span><span class="p">(</span><span class="mi">59</span><span class="p">);</span>
<span class="n">Yrow</span><span class="o">=</span><span class="n">ws</span><span class="o">.</span><span class="n">readY</span><span class="p">(</span><span class="mi">59</span><span class="p">);</span>
<span class="n">line1</span><span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;! </span><span class="si">{0:&gt;6.2f}</span><span class="s1"> </span><span class="si">{1:&gt;6.2f}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Xrow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Yrow</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line1</span> <span class="o">+</span> <span class="s2">&quot; !&quot;</span><span class="p">)</span>
<span class="n">line2</span><span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;! </span><span class="si">{0:&gt;6.2f}</span><span class="s1"> </span><span class="si">{1:&gt;6.2f}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Xrow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Yrow</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">line2</span> <span class="o">+</span> <span class="s2">&quot; !&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;! </span><span class="si">{0:&gt;6.2f}</span><span class="s1"> ------- !&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Xrow</span><span class="p">[</span><span class="mi">20</span><span class="p">]))</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>The converted X-Y values are:
! -10.00   1.00  !  -9.00   1.00  !  -8.00   1.00  !  -7.00   1.00  !  -6.00   1.00  !  -5.00   1.00  !  -4.00   1.00  !  -3.00   1.00  !  -2.00   1.00  !  -1.00   1.00  !
!   0.00   1.00  !   1.00   1.00  !   2.00   1.00  !   3.00   1.00  !   4.00   1.00  !   5.00   1.00  !   6.00   1.00  !   7.00   1.00  !   8.00   1.00  !   9.00   1.00  !
!  10.00 ------- !
</pre></div>
</div>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Inelastic/SofQW.html">Inelastic\SofQW</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Permalink to this heading">¶</a></h2>
<p>C++ header: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Algorithms/inc/MantidAlgorithms/SofQWNormalisedPolygon.h">SofQWNormalisedPolygon.h</a></p>
<p>C++ source: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/aa570da6f199141cd8ad987bf9b9b9281a1b5e33/Framework/Algorithms/src/SofQWNormalisedPolygon.cpp">SofQWNormalisedPolygon.cpp</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="SofQWMomentsScan-v1.html" title="Previous Chapter: SofQWMomentsScan v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; SofQWMomentsScan v1</span>
    </a>
  </li>
  <li>
    <a href="SofQWPolygon-v1.html" title="Next Chapter: SofQWPolygon v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">SofQWPolygon v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>