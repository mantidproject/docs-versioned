<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IntegratePeaksShoeboxTOF v1</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css?v=fadd4351" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=77160d70" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script src="../_static/documentation_options.js?v=94a1c62f"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="IntegratePeaksSkew v1" href="IntegratePeaksSkew-v1.html" />
    <link rel="prev" title="IntegratePeaksProfileFitting v1" href="IntegratePeaksProfileFitting-v1.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.12</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Algorithms</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">IntegratePeaksShoeboxTOF v1</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="integratepeaksshoeboxtof-v1">
<span id="algm-integratepeaksshoeboxtof"></span><span id="algm-integratepeaksshoeboxtof-v1"></span><h1>IntegratePeaksShoeboxTOF v1<a class="headerlink" href="#integratepeaksshoeboxtof-v1" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<span id="index-0"></span><p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#summary" id="id6">Summary</a></p>
<ul>
<li><p><a class="reference internal" href="#see-also" id="id7">See Also</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#properties" id="id8">Properties</a></p></li>
<li><p><a class="reference internal" href="#background" id="id9">Background</a></p></li>
<li><p><a class="reference internal" href="#description" id="id10">Description</a></p></li>
<li><p><a class="reference internal" href="#usage" id="id11">Usage</a></p></li>
<li><p><a class="reference internal" href="#references" id="id12">References</a></p></li>
<li><p><a class="reference internal" href="#source" id="id13">Source</a></p></li>
</ul>
</nav>
<section id="summary">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Summary</a><a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>Integrate single-crystal Bragg peaks in MatrixWorkspaces with x-unit of TOF using a shoebox.</p>
<section id="see-also">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="IntegratePeaksSkew-v1.html#algm-integratepeaksskew"><span class="std std-ref">IntegratePeaksSkew</span></a>, <a class="reference internal" href="FindSXPeaksConvolve-v1.html#algm-findsxpeaksconvolve"><span class="std std-ref">FindSXPeaksConvolve</span></a></p>
</section>
</section>
<section id="properties">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Properties</a><a class="headerlink" href="#properties" title="Link to this heading">¶</a></h2>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Direction</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>InputWorkspace</p></td>
<td><p>Input</p></td>
<td><p><a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a></p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>A MatrixWorkspace to integrate (x-axis must be TOF).</p></td>
</tr>
<tr class="row-odd"><td><p>PeaksWorkspace</p></td>
<td><p>Input</p></td>
<td><p>IPeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>A PeaksWorkspace containing the peaks to integrate.</p></td>
</tr>
<tr class="row-even"><td><p>OutputWorkspace</p></td>
<td><p>Output</p></td>
<td><p>IPeaksWorkspace</p></td>
<td><p><em>Mandatory</em></p></td>
<td><p>The output PeaksWorkspace will be a copy of the input PeaksWorkspace with the integrated intensities.</p></td>
</tr>
<tr class="row-odd"><td><p>NRows</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>5</p></td>
<td><p>Number of row components in the detector to use in the convolution kernel. For WISH row components correspond to pixels along a single tube.</p></td>
</tr>
<tr class="row-even"><td><p>NCols</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>5</p></td>
<td><p>Number of column components in the detector to use in the convolution kernel. For WISH column components correspond to tubes.</p></td>
</tr>
<tr class="row-odd"><td><p>NBins</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>11</p></td>
<td><p>Number of TOF bins to use in the convolution kernel.</p></td>
</tr>
<tr class="row-even"><td><p>GetNBinsFromBackToBackParams</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>If true the number of TOF bins used in the convolution kernel will be calculated from the FWHM of the BackToBackExponential peak using parameters defined in the instrument parameters.xml file.</p></td>
</tr>
<tr class="row-odd"><td><p>NFWHM</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>4</p></td>
<td><p>If GetNBinsFromBackToBackParams=True then the number of TOF bins will be NFWHM x FWHM of the BackToBackExponential at the peak detector and TOF.</p></td>
</tr>
<tr class="row-even"><td><p>NShoeboxInWindow</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>3</p></td>
<td><p>Extent of window in TOF and detector row and column as a multiple of the shoebox length along each dimension.</p></td>
</tr>
<tr class="row-odd"><td><p>OptimiseShoebox</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>If OptimiseShoebox=True then shoebox size will be optimised to maximise Intensity/Sigma of the peak.</p></td>
</tr>
<tr class="row-even"><td><p>WeakPeakStrategy</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td><p>Fix</p></td>
<td><p>If WeakPeakStrategy=Fix then fix the shoebox dimensions. If WeakPeakStrategy=NearestStrongPeak thenthe shoebox dimensions will be taken from the nearest strong peak (determined by StrongPeakThreshold).The TOF extent of the shoebox will be scaled by the FWHM of the BackToBackExponential peaks ifGetNBinsFromBackToBackParams=True. Allowed values: [‘Fix’, ‘NearestStrongPeak’]</p></td>
</tr>
<tr class="row-odd"><td><p>WeakPeakThreshold</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>0</p></td>
<td><p>Intenisty/Sigma threshold below which a peak is considered weak.</p></td>
</tr>
<tr class="row-even"><td><p>IntegrateIfOnEdge</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>False</p></td>
<td><p>If IntegrateIfOnEdge=False then peaks with shoebox that includes detector IDs at the edge of the bank  will not be integrated.</p></td>
</tr>
<tr class="row-odd"><td><p>NRowsEdge</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>Shoeboxes containing detectors NRowsEdge from the detector edge are defined as on the edge.</p></td>
</tr>
<tr class="row-even"><td><p>NColsEdge</p></td>
<td><p>Input</p></td>
<td><p>number</p></td>
<td><p>1</p></td>
<td><p>Shoeboxes containing detectors NColsEdge from the detector edge are defined as on the edge.</p></td>
</tr>
<tr class="row-odd"><td><p>LorentzCorrection</p></td>
<td><p>Input</p></td>
<td><p>boolean</p></td>
<td><p>True</p></td>
<td><p>Correct the integrated intensity by multiplying by the Lorentz factor sin(theta)^2 / lambda^4 - do not do this if the data have already been corrected.</p></td>
</tr>
<tr class="row-even"><td><p>OutputFile</p></td>
<td><p>Input</p></td>
<td><p>string</p></td>
<td></td>
<td><p>Optional file path in which to write diagnostic plots (note this will slow the execution of algorithm). Allowed extensions: [‘.pdf’]</p></td>
</tr>
</tbody>
</table>
</section>
<section id="background">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Background</a><a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<p>Fixed mask/shoebox integration methods have previously been developed for Time-of-flight (TOF) neutron diffraction <a class="footnote-reference brackets" href="#id4" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.
For monochromatic neutron diffractometers, a dynamic shoebox method that optimised the shoebox dimensions on a 2D
detector by maximising the Intensity/sigma ratio of each peak has been shown to improve the R-factors obtained <a class="footnote-reference brackets" href="#id5" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p>This algorithm generalises the 2D dynamic shoebox integration of <a class="footnote-reference brackets" href="#id5" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> to 3D peaks in TOF Laue,
and several improvements have been made to suit TOF Laue data</p>
<ol class="arabic simple">
<li><p>Avoids nearby peaks that are closer to another peak position when optimising shoebox position</p></li>
</ol>
<p>2. The shoebox dimensions of weak peaks can be obtained from nearby stronger peaks with scaling of the TOF dimension
to account for the instrument resolution.</p>
</section>
<section id="description">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Description</a><a class="headerlink" href="#description" title="Link to this heading">¶</a></h2>
<p>This is an algorithm to integrate single-crystal Bragg peaks in a <a class="reference internal" href="../concepts/MatrixWorkspace.html#matrixworkspace"><span class="std std-ref">MatrixWorkspace</span></a>.
An initial integration is performed by summing up the counts in a fixed shoebox of user specified size <code class="docutils literal notranslate"><span class="pre">NRows</span></code> and
<code class="docutils literal notranslate"><span class="pre">NCols</span></code> on the detector and <code class="docutils literal notranslate"><span class="pre">NBins</span></code> along the TOF direction. The dimensions of the shoebox are then optionally
optimised to maximise I/sigma.</p>
<p>The default <code class="docutils literal notranslate"><span class="pre">Nbins</span></code> can be specified in one of two ways:</p>
<ol class="arabic simple">
<li><p>Provide <code class="docutils literal notranslate"><span class="pre">NBins</span></code> directly - number of TOF bins in the kernel</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">GetNBinsFromBackToBackParams=True</span></code> and providing <code class="docutils literal notranslate"><span class="pre">NFWHM</span></code> - in which case <code class="docutils literal notranslate"><span class="pre">NBins</span></code> will be NFWHM x FWHM
of a <a class="reference internal" href="../fitting/fitfunctions/BackToBackExponential.html#func-backtobackexponential"><span class="std std-ref">BackToBackExponential</span></a> peak at the center of each detector panel/bank at the
middle of the spectrum.</p></li>
</ol>
<p>Note to use method 2, back-to-back exponential coefficients must be defined in the Parameters.xml file for the
instrument.</p>
<p>The integration requires a background shell with negative weights, there are approximately the same number of bins in
the background shell as in the peak region.</p>
<p>The algorithm proceeds as follows:</p>
<ol class="arabic simple">
<li><p>Take a window of the data, <code class="docutils literal notranslate"><span class="pre">NShoeboxInWindow</span></code> the size of the initial user specified shoebox (<code class="docutils literal notranslate"><span class="pre">NRows</span></code> x <code class="docutils literal notranslate"><span class="pre">NCols</span></code> x <code class="docutils literal notranslate"><span class="pre">NBins</span></code>)</p></li>
<li><p>Convolve the shoebox kernel with the data in the window to find the position with largest Intensity/sigma
(closest to the predicted peak position than to any other peaks in the table).</p></li>
<li><p>Integrate using the shoebox at the optimal position</p></li>
<li><p>If the peak is strong (Intensity/sigma &gt; <code class="docutils literal notranslate"><span class="pre">WeakPeakThreshold</span></code>) and <code class="docutils literal notranslate"><span class="pre">OptimiseShoebox=True</span></code> then optimise the shoebox
dimensions to maximise Intensity/sigma</p></li>
<li><p>If the peak is weak, it can be integrated using the initial shoebox (<code class="docutils literal notranslate"><span class="pre">WeakPeakStrategy=&quot;Fix&quot;</span></code>) or using the
shoebox dimensions from the nearest strong peak (<code class="docutils literal notranslate"><span class="pre">WeakPeakStrategy=&quot;NearestStrongPeak&quot;</span></code>)</p></li>
</ol>
<p>When looking for the nearest strong peaks for <code class="docutils literal notranslate"><span class="pre">WeakPeakStrategy=&quot;NearestStrongPeak&quot;</span></code>, the algorithm first checks for
peaks in detector IDs in the data window around the peak, before looking at the whole peak table.
The closest peak is defined as the one with the smallest angle between the QLab vectors of the two peaks. The TOF extent
of the shoebox is scaled by the ratio of the FWHM of the weak and strong peak if <code class="docutils literal notranslate"><span class="pre">GetNBinsFromBackToBackParams=True</span></code>,
otherwise it is scaled by the ratio of TOF (i.e. assumes dTOF/TOF resolution is the same for both peaks).</p>
<p>Optionally if <code class="docutils literal notranslate"><span class="pre">OutputFile</span></code> is provided a pdf can be output that shows the shoebox kernel and the data integrated along
each dimension like so</p>
<figure class="align-center">
<a class="reference internal image-reference" href="../_images/IntegratePeaksShoeboxTOF_OutputFile.png"><img alt="(Left) Found fractional TOF window and estimated curves at 4 different wavelengths from linear fit shown on (Right)" src="../_images/IntegratePeaksShoeboxTOF_OutputFile.png" style="width: 50%;" />
</a>
</figure>
</section>
<section id="usage">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p><strong>Example - IntegratePeaksShoeboxTOF</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mantid.simpleapi</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="n">Load</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="s2">&quot;SXD23767.raw&quot;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s2">&quot;SXD23767&quot;</span><span class="p">)</span>
<span class="n">CreatePeaksWorkspace</span><span class="p">(</span><span class="n">InstrumentWorkspace</span><span class="o">=</span><span class="s2">&quot;SXD23767&quot;</span><span class="p">,</span> <span class="n">NumberOfPeaks</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s2">&quot;peaks&quot;</span><span class="p">)</span>
<span class="n">AddPeak</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s2">&quot;peaks&quot;</span><span class="p">,</span> <span class="n">RunWorkspace</span><span class="o">=</span><span class="s2">&quot;SXD23767&quot;</span><span class="p">,</span> <span class="n">TOF</span><span class="o">=</span><span class="mf">8303.3735339704781</span><span class="p">,</span> <span class="n">DetectorID</span><span class="o">=</span><span class="mi">7646</span><span class="p">)</span>

<span class="n">peaks_out</span> <span class="o">=</span> <span class="n">IntegratePeaksShoeboxTOF</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="s2">&quot;SXD23767&quot;</span><span class="p">,</span> <span class="n">PeaksWorkspace</span><span class="o">=</span><span class="s2">&quot;peaks&quot;</span><span class="p">,</span>
                                     <span class="n">GetNBinsFromBackToBackParams</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">WeakPeakThreshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">LorentzCorrection</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;I/sigma = </span><span class="si">{</span><span class="n">peaks_out</span><span class="o">.</span><span class="n">getPeak</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">getIntensityOverSigma</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Output:</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>I/sigma = 100.80
</pre></div>
</div>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Wilkinson, C., and A. J. Schultz. (1989) J. Appl. Cryst. 22.2, 110-114.</p>
</aside>
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id2">1</a>,<a role="doc-backlink" href="#id3">2</a>)</span>
<p>Wilkinson, C., Khamis, H. W., Stansfield, R. F. D. &amp; McIntyre, G. J. (1988). J. Appl. Cryst. 21, 471-478.</p>
</aside>
</aside>
<p><strong>Categories</strong>: <a class="reference external" href="categories/AlgorithmIndex.html">AlgorithmIndex</a> | <a class="reference external" href="categories/Diffraction/Reduction.html">Diffraction\Reduction</a></p>
</section>
<section id="source">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Source</a><a class="headerlink" href="#source" title="Link to this heading">¶</a></h2>
<p>Python: <a class="reference external" href="https://github.com/mantidproject/mantid/blob/a8f64cccc781eac9892433e956bab7104ebf1213/Framework/PythonInterface/plugins/algorithms/IntegratePeaksShoeboxTOF.py">IntegratePeaksShoeboxTOF.py</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="IntegratePeaksProfileFitting-v1.html" title="Previous Chapter: IntegratePeaksProfileFitting v1"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; IntegratePeak...</span>
    </a>
  </li>
  <li>
    <a href="IntegratePeaksSkew-v1.html" title="Next Chapter: IntegratePeaksSkew v1"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">IntegratePeaksSkew v1 &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>