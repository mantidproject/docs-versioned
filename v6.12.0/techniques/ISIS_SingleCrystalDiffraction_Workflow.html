<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>ISIS Single Crystal Diffraction Reduction Scripts</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/bootstrap-sphinx.css?v=fadd4351" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=77160d70" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script src="../_static/documentation_options.js?v=94a1c62f"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data reduction for D7 instrument at the ILL" href="PolarisedDiffractionILL.html" />
    <link rel="prev" title="ISIS Reflectometry" href="ISIS_Reflectometry.html" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59110517-1', 'auto');
  ga('send', 'pageview');

</script>


  </head><body>





  <div id="navbar" class="navbar navbar-default ">
    <div class="container">
      <div class="navbar-header">
        
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://www.mantidproject.org">
           </a>
        <span class="navbar-text navbar-version pull-left"><b>6.12</b></span>
      </div>

      
        <div class="collapse navbar-collapse nav-collapse">
      
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="https://www.mantidproject.org">Home</a></li>
                <li><a href="https://download.mantidproject.org">Download</a></li>
                <li><a href="https://docs.mantidproject.org">Documentation</a></li>
                <li><a href="https://www.mantidproject.org/contact">Contact Us</a></li>
            
            
              
              
            
            
            
            
          </ul>
              
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
            </div>
    </div>
    <p>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../index.html">Documentation</a> &#187;</li>
        
            <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Techniques</a> &#187;</li>
          
        
        
          
            <li class="nav-item nav-item-this"><a href="">ISIS Single Crystal Diffraction Reduction Scripts</a></li>
          
        
      </ul>
    </div> </p>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <p><span class="math notranslate nohighlight">\(\renewcommand\AA{\unicode{x212B}}\)</span></p>
<section id="isis-single-crystal-diffraction-reduction-scripts">
<span id="isis-single-crystal-diffraction-ref"></span><h1>ISIS Single Crystal Diffraction Reduction Scripts<a class="headerlink" href="#isis-single-crystal-diffraction-reduction-scripts" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id2">Introduction</a></p></li>
<li><p><a class="reference internal" href="#basic-usage" id="id3">Basic Usage</a></p></li>
<li><p><a class="reference internal" href="#sxd-workflow" id="id4">SXD Workflow</a></p>
<ul>
<li><p><a class="reference internal" href="#detector-calibration" id="id5">1. Detector Calibration</a></p></li>
<li><p><a class="reference internal" href="#reduce-a-sequence-of-runs" id="id6">2. Reduce a sequence of runs</a></p>
<ul>
<li><p><a class="reference internal" href="#a-setting-up-the-sxd-object" id="id7">a. Setting up the SXD object</a></p></li>
<li><p><a class="reference internal" href="#b-running-the-reduction" id="id8">b. Running the reduction</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#wish-workflow" id="id9">WISH Workflow</a></p>
<ul>
<li><p><a class="reference internal" href="#preliminary-integration" id="id10">1. Preliminary integration</a></p></li>
<li><p><a class="reference internal" href="#finding-the-ubs-for-a-sequence-of-runs" id="id11">2. Finding the UBs for a sequence of runs</a></p></li>
<li><p><a class="reference internal" href="#id1" id="id12">3. Reduce a sequence of runs</a></p>
<ul>
<li><p><a class="reference internal" href="#a-skew-integration-no-satellites" id="id13">a. Skew Integration (no satellites)</a></p></li>
<li><p><a class="reference internal" href="#b-q-integration-with-satellites" id="id14">b. Q Integration (with satellites)</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>The reduction of single-crystal diffraction data from the SXD and WISH instruments at ISIS is
achieved with the use of instrument specific classes (<code class="docutils literal notranslate"><span class="pre">SXD</span></code> and <code class="docutils literal notranslate"><span class="pre">WishSX</span></code> respectively).</p>
<p>The instrument specific classes inherit from a base class <code class="docutils literal notranslate"><span class="pre">BaseSX</span></code> that contains code common to the
workflow of all single-crystal diffraction reduction instruments - the user shouldn’t interact directly with this class.</p>
</section>
<section id="basic-usage">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Basic Usage</a><a class="headerlink" href="#basic-usage" title="Link to this heading">¶</a></h2>
<p>During beamtime, users may want to load data, find peaks and optimise UB matrices etc. without performing the
time-consuming normalisation and correction procedures necessary when reducing the data for refinement.</p>
<p>These simple operations have been made concise with the use of <cite>static</cite> methods in the reduction classes - i.e.
the user can call these methods without a creating an instance of the class. These static methods can be
combined in a script with mantid algorithms in the usual way.</p>
<p>Here is an example using the <code class="docutils literal notranslate"><span class="pre">SXD</span></code> class that finds peaks and then removes duplicates</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mantid.simpleapi</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.single_crystal.sxd</span><span class="w"> </span><span class="kn">import</span> <span class="n">SXD</span>

<span class="n">ws</span> <span class="o">=</span> <span class="n">Load</span><span class="p">(</span><span class="n">Filename</span><span class="o">=</span><span class="s1">&#39;SXD33335.nxs&#39;</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="s1">&#39;SXD33335&#39;</span><span class="p">)</span>

<span class="c1"># find peaks using SXD static method - determines peak threshold from</span>
<span class="c1"># the ratio of local variance over mean</span>
<span class="n">peaks_ws</span> <span class="o">=</span> <span class="n">SXD</span><span class="o">.</span><span class="n">find_sx_peaks</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">ThresholdVarianceOverMean</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">SXD</span><span class="o">.</span><span class="n">remove_duplicate_peaks_by_qlab</span><span class="p">(</span><span class="n">peaks_ws</span><span class="p">,</span> <span class="n">q_tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

<span class="c1"># find a UB</span>
<span class="n">FindUBUsingFFT</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">peaks_ws</span><span class="p">,</span> <span class="n">MinD</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">MaxD</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># use another static method to remove duplicates by hkl index</span>
<span class="n">SXD</span><span class="o">.</span><span class="n">remove_duplicate_peaks_by_hkl</span><span class="p">(</span><span class="n">peaks_ws</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sxd-workflow">
<span id="isis-single-crystal-diffraction-sxd-ref"></span><h2><a class="toc-backref" href="#id4" role="doc-backlink">SXD Workflow</a><a class="headerlink" href="#sxd-workflow" title="Link to this heading">¶</a></h2>
<section id="detector-calibration">
<span id="sxd-detector-calibration-ref"></span><h3><a class="toc-backref" href="#id5" role="doc-backlink">1. Detector Calibration</a><a class="headerlink" href="#detector-calibration" title="Link to this heading">¶</a></h3>
<p>The positions of the SXD detector panels require calibration - typically using an NaCl crystal (standard sample).
The updated positions are stored in an .xml file, the path to the file is returned by <cite>calibrate_sxd_panels</cite>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sxd</span> <span class="o">=</span> <span class="n">SXD</span><span class="p">()</span>
<span class="n">wsname</span> <span class="o">=</span> <span class="n">sxd</span><span class="o">.</span><span class="n">load_run</span><span class="p">(</span><span class="mi">32863</span><span class="p">)</span>
<span class="n">peaks_ws</span> <span class="o">=</span> <span class="n">sxd</span><span class="o">.</span><span class="n">find_sx_peaks</span><span class="p">(</span><span class="n">wsname</span><span class="p">)</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">remove_peaks_on_detector_edge</span><span class="p">(</span><span class="n">peaks_ws</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># initial UB</span>
<span class="n">FindUBUsingFFT</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">peaks_ws</span> <span class="p">,</span> <span class="n">MinD</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">MaxD</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># force lattice parameters to be correct</span>
<span class="n">SelectCellWithForm</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">peaks_ws</span><span class="p">,</span> <span class="n">FormNumber</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Apply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Tolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">OptimizeLatticeForCellType</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">peaks_ws</span><span class="p">,</span> <span class="n">Apply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Tolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="n">IndexPeaks</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">peaks_ws</span><span class="p">,</span> <span class="n">Tolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">CommonUBForAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">CalculateUMatrix</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">peaks_ws</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="mf">5.6402</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">5.6402</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">5.6402</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

<span class="n">save_dir</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&lt;put-correct-save-path&gt;&quot;</span>
<span class="n">detcal_path</span> <span class="o">=</span> <span class="n">sxd</span><span class="o">.</span><span class="n">calibrate_sxd_panels</span><span class="p">(</span><span class="n">wsname</span><span class="p">,</span> <span class="n">peaks_ws</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="reduce-a-sequence-of-runs">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">2. Reduce a sequence of runs</a><a class="headerlink" href="#reduce-a-sequence-of-runs" title="Link to this heading">¶</a></h3>
<p>Once the detectors have been calibrated a sequence of runs can be reduced.</p>
<section id="a-setting-up-the-sxd-object">
<h4><a class="toc-backref" href="#id7" role="doc-backlink">a. Setting up the SXD object</a><a class="headerlink" href="#a-setting-up-the-sxd-object" title="Link to this heading">¶</a></h4>
<p>In order to reduce a sequence of runs, an instance of the <code class="docutils literal notranslate"><span class="pre">SXD</span></code> class needs to be initiated with a vanadium and empty
run number and optionally the detector calibration file from <a class="reference internal" href="#sxd-detector-calibration-ref"><span class="std std-ref">1. Detector Calibration</span></a>.</p>
<p>If sample absorption is to be corrected for, the sample shape/geometry and material can be set using <code class="docutils literal notranslate"><span class="pre">set_sample</span></code>
as in <a class="reference internal" href="../algorithms/SetSample-v1.html#algm-setsample"><span class="std std-ref">SetSample v1</span></a> - note the default units for the number density are <cite>formula units per cubic Angstrom</cite>.</p>
<p>Typically each run in a sequence corresponds to a different sample orientation, in which case it is necessary to set the
goniometer axes using <code class="docutils literal notranslate"><span class="pre">set_goniometer</span></code> as defined in <a class="reference internal" href="../algorithms/SetGoniometer-v1.html#algm-setgoniometer"><span class="std std-ref">SetGoniometer v1</span></a>.
The goniometer angles are provided later.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sxd</span> <span class="o">=</span> <span class="n">SXD</span><span class="p">(</span><span class="n">vanadium_runno</span><span class="o">=</span><span class="mi">32857</span><span class="p">,</span> <span class="n">empty_runno</span><span class="o">=</span><span class="mi">32856</span><span class="p">,</span> <span class="n">detcal_path</span><span class="o">=</span><span class="n">detcal_path</span><span class="p">)</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">set_sample</span><span class="p">(</span><span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;CSG&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">sxd</span><span class="o">.</span><span class="n">sphere_shape</span><span class="p">},</span>
               <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;Na Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.0223</span><span class="p">})</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">set_goniometer_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># ccw rotation around vertical</span>
</pre></div>
</div>
</section>
<section id="b-running-the-reduction">
<h4><a class="toc-backref" href="#id8" role="doc-backlink">b. Running the reduction</a><a class="headerlink" href="#b-running-the-reduction" title="Link to this heading">¶</a></h4>
<p>The reduction proceeds as follows:</p>
<ul class="simple">
<li><p>Process vanadium</p></li>
<li><p>Load and normalise data</p></li>
<li><p>Find peaks</p></li>
<li><p>Optimise a UB</p></li>
<li><p>Integrate peaks</p></li>
<li><p>Export peaks for refinement</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mantid.simpleapi</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.single_crystal.base_sx</span><span class="w"> </span><span class="kn">import</span> <span class="n">PEAK_TYPE</span><span class="p">,</span> <span class="n">INTEGRATION_TYPE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.single_crystal.sxd</span><span class="w"> </span><span class="kn">import</span> <span class="n">SXD</span>

<span class="c1"># Setup SXD</span>
<span class="c1">###########</span>

<span class="n">sxd</span> <span class="o">=</span> <span class="n">SXD</span><span class="p">(</span><span class="n">vanadium_runno</span><span class="o">=</span><span class="mi">32857</span><span class="p">,</span> <span class="n">empty_runno</span><span class="o">=</span><span class="mi">32856</span><span class="p">,</span> <span class="n">detcal_path</span><span class="o">=</span><span class="n">detcal_path</span><span class="p">)</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">set_sample</span><span class="p">(</span><span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;CSG&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">sxd</span><span class="o">.</span><span class="n">sphere_shape</span><span class="p">},</span>
               <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;Na Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.0223</span><span class="p">})</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">set_goniometer_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># ccw rotation around vertical</span>

<span class="c1"># load and normalise data</span>
<span class="c1">#########################</span>

<span class="n">runs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32863</span><span class="p">,</span><span class="mi">32865</span><span class="p">)</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">process_vanadium</span><span class="p">()</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">runs</span><span class="p">,</span> <span class="s2">&quot;wccr&quot;</span><span class="p">)</span> <span class="c1"># wccr is the goniometer motor log name - one arg for each axis added</span>
<span class="c1"># if there was no log value then the angles have to be set with a sequence e.g.</span>
<span class="c1"># sxd.process_data(runs, [0,45])</span>

<span class="c1"># Find peaks and optimise UBs</span>
<span class="c1">##############################</span>

<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">sxd</span><span class="o">.</span><span class="n">get_ws</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">sxd</span><span class="o">.</span><span class="n">find_sx_peaks</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
    <span class="n">sxd</span><span class="o">.</span><span class="n">remove_peaks_on_detector_edge</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sxd</span><span class="o">.</span><span class="n">set_peaks</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">peaks</span><span class="p">)</span>
<span class="c1"># find UB with consistent indexing across runs</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">find_ub_using_lattice_params</span><span class="p">(</span><span class="n">global_B</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                                 <span class="n">a</span><span class="o">=</span><span class="mf">5.6402</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mf">5.6402</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">5.6402</span><span class="p">,</span>
                                 <span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">calibrate_sample_pos</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>  <span class="c1"># calibrates each run independently</span>

<span class="c1"># Integrate and save</span>
<span class="c1">####################</span>

<span class="c1"># input arguments for skew integration</span>
<span class="n">save_dir</span> <span class="o">=</span> <span class="s2">&quot;/babylon/Public/UserName&quot;</span>
<span class="n">skew_args</span><span class="o">=</span> <span class="p">{</span><span class="s1">&#39;UseNearestPeak&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;IntegrateIfOnEdge&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;LorentzCorrection&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;NVacanciesMax&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;NPixPerVacancyMin&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;NTOFBinsMin&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;UpdatePeakPosition&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;OptimiseMask&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;GetTOFWindowFromBackToBackParams&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;BackScatteringTOFResolution&#39;</span><span class="p">:</span> <span class="mf">0.06</span><span class="p">,</span> <span class="s1">&#39;ThetaWidth&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="s1">&#39;ScaleThetaWidthByWavelength&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;OptimiseXWindowSize&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ThresholdIoverSigma&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}</span>

<span class="c1"># integrate and save each run</span>
<span class="n">peak_type</span> <span class="o">=</span> <span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">FOUND</span>
<span class="n">integration_type</span> <span class="o">=</span> <span class="n">INTEGRATION_TYPE</span><span class="o">.</span><span class="n">SKEW</span>
<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
    <span class="n">skew_args</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">skew_args</span><span class="p">,</span> <span class="s1">&#39;OutputFile&#39;</span><span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">peak_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">_int.pdf&quot;</span><span class="p">)}</span>
    <span class="n">sxd</span><span class="o">.</span><span class="n">integrate_data</span><span class="p">(</span><span class="n">integration_type</span><span class="p">,</span> <span class="n">peak_type</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="o">**</span><span class="n">skew_args</span><span class="p">)</span>
    <span class="n">sxd</span><span class="o">.</span><span class="n">remove_non_integrated_peaks</span><span class="p">(</span><span class="n">sxd</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">peak_type</span><span class="p">,</span> <span class="n">integration_type</span><span class="p">))</span>
    <span class="n">sxd</span><span class="o">.</span><span class="n">calc_absorption_weighted_path_lengths</span><span class="p">(</span><span class="n">peak_type</span><span class="p">,</span> <span class="n">integration_type</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">ApplyCorrection</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sxd</span><span class="o">.</span><span class="n">save_peak_table</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">peak_type</span><span class="p">,</span> <span class="n">integration_type</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s1">&#39;SHELX&#39;</span><span class="p">)</span>

<span class="c1"># save combined table</span>
<span class="n">sxd</span><span class="o">.</span><span class="n">save_all_peaks</span><span class="p">(</span><span class="n">peak_type</span><span class="p">,</span> <span class="n">integration_type</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s1">&#39;SHELX&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="wish-workflow">
<span id="isis-single-crystal-diffraction-wish-ref"></span><h2><a class="toc-backref" href="#id9" role="doc-backlink">WISH Workflow</a><a class="headerlink" href="#wish-workflow" title="Link to this heading">¶</a></h2>
<section id="preliminary-integration">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">1. Preliminary integration</a><a class="headerlink" href="#preliminary-integration" title="Link to this heading">¶</a></h3>
<p>During beamtime users may want to check that a run has been counted sufficiently. This
involves saving the data with a different file extension e.g. <code class="docutils literal notranslate"><span class="pre">.s01</span></code>.</p>
<p>This example shows how to load data with specific file extension and perform an integration in Q-space.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mantid.simpleapi</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.wish.wishSX</span><span class="w"> </span><span class="kn">import</span> <span class="n">WishSX</span>

<span class="c1"># integration parameters</span>
<span class="n">intPeaksMDArgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ellipsoid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;fixQAxis&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;fixMajorAxisLength&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;useCentroid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;MaskEdgeTubes&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<span class="n">ws</span> <span class="o">=</span> <span class="n">WishSX</span><span class="o">.</span><span class="n">load_run</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">file_ext</span><span class="o">=</span><span class="s2">&quot;.s01&quot;</span><span class="p">)</span>
<span class="c1"># convert data to Q for integration</span>
<span class="n">WishSX</span><span class="o">.</span><span class="n">mask_detector_edges</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">nedge</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ntubes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">wsMD</span> <span class="o">=</span> <span class="n">WishSX</span><span class="o">.</span><span class="n">convert_ws_to_MD</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;Q (lab frame)&quot;</span><span class="p">)</span>
<span class="c1"># find peaks and integrate</span>
<span class="n">peaks</span> <span class="o">=</span> <span class="n">WishSX</span><span class="o">.</span><span class="n">find_sx_peaks</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
<span class="n">peaks_int</span> <span class="o">=</span> <span class="n">WishSX</span><span class="p">()</span><span class="o">.</span><span class="n">integrate_peaks_MD_optimal_radius</span><span class="p">(</span><span class="n">wsMD</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">peaks</span><span class="o">+</span><span class="s2">&quot;_int&quot;</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="o">**</span><span class="n">intPeaksMDArgs</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the method <code class="docutils literal notranslate"><span class="pre">integrate_peaks_MD_optimal_radius</span></code> requires an instance of the class <code class="docutils literal notranslate"><span class="pre">WishSX()</span></code> - this is
because the optimal radius for the integration depends on the instrument, but the method is defined in the base class as
it is common to both SXD and WISH.</p>
<p>The default file extension (used in <code class="docutils literal notranslate"><span class="pre">process_vanadium</span></code> and <code class="docutils literal notranslate"><span class="pre">process_data</span></code>) is stored as an attribute on the class
which can be set at instantiation as follows</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wish</span> <span class="o">=</span> <span class="n">WishSX</span><span class="p">(</span><span class="n">file_ext</span><span class="o">=</span><span class="s2">&quot;.s01&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>It can also set at any point directly (e.g. after the vanadium run has been processed and to reduce a single run for
preliminary refinement).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">wish</span><span class="o">.</span><span class="n">file_ext</span> <span class="o">=</span> <span class="s2">&quot;.s01&quot;</span>
</pre></div>
</div>
</section>
<section id="finding-the-ubs-for-a-sequence-of-runs">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">2. Finding the UBs for a sequence of runs</a><a class="headerlink" href="#finding-the-ubs-for-a-sequence-of-runs" title="Link to this heading">¶</a></h3>
<p>The WISH workflow finds UBs before the reduction and exports the UB matrix for every run post rotation by the goniometer
matrix. The UBs are then loaded in the subsequent reduction, which then doesn’t require the goniometer information, and
the predicted peak positions are integrated (in contrast to SXD where the found peaks are integrated)..</p>
<p>Here is an example that finds peaks, integrates them in Q-space and filters by I/sigma to only use the strongest peaks
in the UB optimisation. The data were collected using the WISH goniometer with 2 axes of rotation (phi and omega), in
this case a positive angle (omega) correposnds to a counter-clockwise rotation around the vertical axis as viewed from
the top - i.e. the goniometer axis is <code class="docutils literal notranslate"><span class="pre">Axis0=str(omegas[irun])+',0,1,0,1'</span></code>.
For data collected in the Newport with only a vertical axis of rotation a positive angle corresponds to a clockwise
rotation and the correct goniometer axis is <code class="docutils literal notranslate"><span class="pre">Axis0=str(omegas[irun])+',0,1,0,-1'</span></code> (note the sign of the last number
has changed).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mantid.simpleapi</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.wish.wishSX</span><span class="w"> </span><span class="kn">import</span> <span class="n">WishSX</span>

<span class="c1"># lattice parameters</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="mf">12.2738</span><span class="p">,</span> <span class="mf">12.2738</span><span class="p">,</span> <span class="mf">12.2738</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">,</span> <span class="mf">90.0</span>

<span class="c1"># integration parameters</span>
<span class="n">intPeaksMDArgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ellipsoid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;fixQAxis&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;fixMajorAxisLength&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;useCentroid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;MaskEdgeTubes&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<span class="c1"># goniometer angles (one for each run)</span>
<span class="n">omegas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">153.0</span><span class="p">]</span>
<span class="n">phis</span> <span class="o">=</span> <span class="p">[</span><span class="mf">181.0</span><span class="p">,</span> <span class="mf">247.0</span><span class="p">,</span> <span class="mf">93.0</span><span class="p">]</span>
<span class="n">runs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">42730</span><span class="p">,</span> <span class="mi">42733</span><span class="p">)</span>

<span class="n">pk_ws_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">irun</span><span class="p">,</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">WishSX</span><span class="o">.</span><span class="n">load_run</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
    <span class="n">SetGoniometer</span><span class="p">(</span><span class="n">Workspace</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="n">Axis0</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">omegas</span><span class="p">[</span><span class="n">irun</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;,0,1,0,1&#39;</span><span class="p">,</span>
                  <span class="n">Axis1</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">phis</span><span class="p">[</span><span class="n">irun</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,1,1,0,1&#39;</span><span class="p">)</span>
    <span class="c1"># SetGoniometer(Workspace=ws, Axis0=str(omegas[irun])+&#39;,0,1,0,-1&#39;) # if using newport</span>
    <span class="c1"># convert data to Q for integration</span>
    <span class="n">WishSX</span><span class="o">.</span><span class="n">mask_detector_edges</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">nedge</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ntubes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">wsMD</span> <span class="o">=</span> <span class="n">WishSX</span><span class="o">.</span><span class="n">convert_ws_to_MD</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;Q (lab frame)&quot;</span><span class="p">)</span>
    <span class="c1"># find peaks and integrate</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">WishSX</span><span class="o">.</span><span class="n">find_sx_peaks</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
    <span class="n">peaks_int</span> <span class="o">=</span> <span class="n">WishSX</span><span class="p">()</span><span class="o">.</span><span class="n">integrate_peaks_MD_optimal_radius</span><span class="p">(</span><span class="n">wsMD</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">peaks</span><span class="o">+</span><span class="s2">&quot;_int&quot;</span><span class="p">,</span> <span class="n">ws</span><span class="o">=</span><span class="n">ws</span><span class="p">,</span> <span class="o">**</span><span class="n">intPeaksMDArgs</span><span class="p">)</span>
    <span class="n">peaks_int</span> <span class="o">=</span> <span class="n">peaks_int</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="c1"># filter to get strong peaks only</span>
    <span class="n">FilterPeaks</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">peaks_int</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="n">peaks_int</span><span class="p">,</span> <span class="n">FilterVariable</span><span class="o">=</span><span class="s2">&quot;Signal/Noise&quot;</span><span class="p">,</span>
                <span class="n">FilterValue</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">Operator</span><span class="o">=</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="c1"># get a rough UB and keep indexed</span>
    <span class="n">FindUBUsingFFT</span><span class="p">(</span><span class="n">peaks_int</span><span class="p">,</span> <span class="n">MinD</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">MaxD</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">SelectCellOfType</span><span class="p">(</span><span class="n">PeaksWorkspace</span><span class="o">=</span><span class="n">peaks_int</span><span class="p">,</span> <span class="n">Centering</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">Apply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">IndexPeaks</span><span class="p">(</span><span class="n">peaks_int</span><span class="p">,</span> <span class="n">RoundHKLs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">CommonUBForAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">CalculateUMatrix</span><span class="p">(</span><span class="n">peaks_int</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
    <span class="n">WishSX</span><span class="o">.</span><span class="n">remove_unindexed_peaks</span><span class="p">(</span><span class="n">peaks_int</span><span class="p">)</span>
    <span class="n">pk_ws_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peaks_int</span><span class="p">)</span>

<span class="c1"># find a UB per run with consistent indexing across the sequence</span>
<span class="n">FindGlobalBMatrix</span><span class="p">(</span><span class="n">PeakWorkspaces</span><span class="o">=</span><span class="n">pk_ws_list</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> <span class="n">Tolerance</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>

<span class="c1"># save the UBs</span>
<span class="n">save_dir</span> <span class="o">=</span> <span class="s2">&quot;/babylon/Public/UserName&quot;</span>
<span class="k">for</span> <span class="n">irun</span><span class="p">,</span> <span class="n">peaks</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pk_ws_list</span><span class="p">):</span>
    <span class="n">SaveIsawUB</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">peaks</span><span class="p">,</span> <span class="n">Filename</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span>  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">runs</span><span class="p">[</span><span class="n">irun</span><span class="p">]</span><span class="si">}</span><span class="s1">.mat&#39;</span><span class="p">),</span>
               <span class="n">RotateByGoniometerMatrix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id1">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">3. Reduce a sequence of runs</a><a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>After a UB matrix has been optimised for each run, the entire sequence of runs can now be reduced.</p>
<p>The method <code class="docutils literal notranslate"><span class="pre">predict_peaks</span></code> predicts peaks based on the <cite>enum</cite> class <code class="docutils literal notranslate"><span class="pre">PEAK_TYPE</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FOUND</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PREDICT</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PREDICT_SAT</span></code></p></li>
</ul>
<p>The method takes the keyword arguments for <a class="reference internal" href="../algorithms/PredictPeaks-v1.html#algm-predictpeaks"><span class="std std-ref">PredictPeaks v1</span></a>
and <a class="reference internal" href="../algorithms/PredictFractionalPeaks-v1.html#algm-predictfractionalpeaks"><span class="std std-ref">PredictFractionalPeaks v1</span></a> for <code class="docutils literal notranslate"><span class="pre">PEAK_TYPE.PREDICT</span></code> and <code class="docutils literal notranslate"><span class="pre">PEAK_TYPE.PREDICT_SAT</span></code> respectively.</p>
<p>The integration algorithm called by <code class="docutils literal notranslate"><span class="pre">integrate_data</span></code> will integrate the peak table based on the <code class="docutils literal notranslate"><span class="pre">PEAK_TYPE</span></code> supplied
using an agorithm determined by the <cite>enum</cite> class <code class="docutils literal notranslate"><span class="pre">INTEGRATION_TYPE</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MD</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MD_OPTIMAL_RADIUS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SKEW</span></code></p></li>
</ul>
<p>The Q-space integration methods are <code class="docutils literal notranslate"><span class="pre">MD</span></code> a <code class="docutils literal notranslate"><span class="pre">MD_OPTIMAL_RADIUS</span></code> - the latter estimates an appropriate peak radius for
each peak, the former method requires the user to supply the peak radius to <code class="docutils literal notranslate"><span class="pre">integrate_data</span></code> using keyword arguments
as in <a class="reference internal" href="../algorithms/IntegratePeaksMD-v2.html#algm-integratepeaksmd-v2"><span class="std std-ref">IntegratePeaksMD v2</span></a>.</p>
<section id="a-skew-integration-no-satellites">
<h4><a class="toc-backref" href="#id13" role="doc-backlink">a. Skew Integration (no satellites)</a><a class="headerlink" href="#a-skew-integration-no-satellites" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mantid.simpleapi</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.single_crystal.base_sx</span><span class="w"> </span><span class="kn">import</span> <span class="n">PEAK_TYPE</span><span class="p">,</span> <span class="n">INTEGRATION_TYPE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.wish.wishSX</span><span class="w"> </span><span class="kn">import</span> <span class="n">WishSX</span>

<span class="c1"># Setup WishSX</span>
<span class="c1">##############</span>

<span class="n">wish</span> <span class="o">=</span> <span class="n">WishSX</span><span class="p">(</span><span class="n">vanadium_runno</span><span class="o">=</span><span class="mi">43526</span><span class="p">)</span>
<span class="c1"># set sample material</span>
<span class="n">sphere</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;sphere id=&quot;sphere&quot;&gt;</span>
<span class="s1">            &lt;centre x=&quot;0.0&quot;  y=&quot;0.0&quot; z=&quot;0.0&quot; /&gt;</span>
<span class="s1">            &lt;radius val=&quot;0.0009&quot;/&gt;</span>
<span class="s1">            &lt;/sphere&gt;&#39;&#39;&#39;</span>  <span class="c1"># sphere radius 0.9mm</span>
<span class="n">wish</span><span class="o">.</span><span class="n">set_sample</span><span class="p">(</span><span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;CSG&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">sphere_GGG</span><span class="p">},</span>
                <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;Ca3-Ga2-Ge3-O12&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.001086</span><span class="p">})</span>

<span class="c1"># load vanadium</span>
<span class="c1">###############</span>

<span class="n">wish</span><span class="o">.</span><span class="n">process_vanadium</span><span class="p">()</span>

<span class="c1"># Integrate and save</span>
<span class="c1">####################</span>

<span class="n">save_dir</span> <span class="o">=</span> <span class="s2">&quot;/babylon/Public/UserName&quot;</span>
<span class="c1"># integration parameters</span>
<span class="n">intPeaksSkewArgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;UseNearestPeak&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;IntegrateIfOnEdge&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;NRowsEdge&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;NColsEdge&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;NVacanciesMax&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;NPixPerVacancyMin&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;NTOFBinsMin&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;UpdatePeakPosition&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;OptimiseMask&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;GetTOFWindowFromBackToBackParams&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;NFWHM&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="s1">&#39;LorentzCorrection&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ScaleThetaWidthByWavelength&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;OptimiseXWindowSize&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ThresholdIoverSigma&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">}</span>

<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">42730</span><span class="p">,</span> <span class="mi">42733</span><span class="p">):</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">process_data</span><span class="p">([</span><span class="n">run</span><span class="p">])</span>
    <span class="c1"># load UB</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">load_isaw_ub</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s1">.mat&#39;</span><span class="p">),</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
    <span class="c1"># predict peaks</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">predict_peaks</span><span class="p">(</span><span class="n">MinDSpacing</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">WavelengthMin</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
                       <span class="n">ReflectionCondition</span><span class="o">=</span><span class="s1">&#39;Body centred&#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
    <span class="c1"># Integrate</span>
    <span class="n">skew_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;OutputFile&#39;</span><span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s1">_integrated.pdf&#39;</span><span class="p">),</span>
                   <span class="o">**</span><span class="n">intPeaksSkewArgs</span><span class="p">}</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">integrate_data</span><span class="p">(</span><span class="n">INTEGRATION_TYPE</span><span class="o">.</span><span class="n">SKEW</span><span class="p">,</span> <span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">PREDICT</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="o">**</span><span class="n">skew_kwargs</span><span class="p">)</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">save_peak_table</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">PREDICT</span><span class="p">,</span> <span class="n">INTEGRATION_TYPE</span><span class="o">.</span><span class="n">SKEW</span><span class="p">,</span>
                         <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;Jana&quot;</span><span class="p">)</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">delete_run_data</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>  <span class="c1"># delete raw workspace to save memory</span>

<span class="n">wish</span><span class="o">.</span><span class="n">save_all_peaks</span><span class="p">(</span><span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">FOUND</span><span class="p">,</span> <span class="n">INTEGRATION_TYPE</span><span class="o">.</span><span class="n">SKEW</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;jana&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="b-q-integration-with-satellites">
<h4><a class="toc-backref" href="#id14" role="doc-backlink">b. Q Integration (with satellites)</a><a class="headerlink" href="#b-q-integration-with-satellites" title="Link to this heading">¶</a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mantid.simpleapi</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.single_crystal.base_sx</span><span class="w"> </span><span class="kn">import</span> <span class="n">PEAK_TYPE</span><span class="p">,</span> <span class="n">INTEGRATION_TYPE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Diffraction.wish.wishSX</span><span class="w"> </span><span class="kn">import</span> <span class="n">WishSX</span>

<span class="c1"># Setup WishSX</span>
<span class="c1">##############</span>
<span class="n">wish</span> <span class="o">=</span> <span class="n">WishSX</span><span class="p">(</span><span class="n">vanadium_runno</span><span class="o">=</span><span class="mi">43526</span><span class="p">)</span>
<span class="c1"># set sample material</span>
<span class="n">sphere</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;sphere id=&quot;sphere&quot;&gt;</span>
<span class="s1">            &lt;centre x=&quot;0.0&quot;  y=&quot;0.0&quot; z=&quot;0.0&quot; /&gt;</span>
<span class="s1">            &lt;radius val=&quot;0.0009&quot;/&gt;</span>
<span class="s1">            &lt;/sphere&gt;&#39;&#39;&#39;</span>  <span class="c1"># sphere radius 0.9mm</span>
<span class="n">wish</span><span class="o">.</span><span class="n">set_sample</span><span class="p">(</span><span class="n">Geometry</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Shape&#39;</span><span class="p">:</span> <span class="s1">&#39;CSG&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">sphere</span><span class="p">},</span>
                <span class="n">Material</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ChemicalFormula&#39;</span><span class="p">:</span> <span class="s1">&#39;Ca3-Ga2-Ge3-O12&#39;</span><span class="p">,</span> <span class="s1">&#39;SampleNumberDensity&#39;</span><span class="p">:</span> <span class="mf">0.001086</span><span class="p">})</span>

<span class="c1"># load vanadium</span>
<span class="c1">###############</span>

<span class="n">wish</span><span class="o">.</span><span class="n">process_vanadium</span><span class="p">()</span>

<span class="c1"># Load runs one at a time and integrate</span>
<span class="c1">#######################################</span>

<span class="n">save_dir</span> <span class="o">=</span> <span class="s2">&quot;/babylon/Public/UserName&quot;</span>
<span class="c1"># integration parameters</span>
<span class="n">intPeaksMDArgs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ellipsoid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;fixQAxis&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;fixMajorAxisLength&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;useCentroid&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;MaskEdgeTubes&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

<span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">42730</span><span class="p">,</span> <span class="mi">42733</span><span class="p">):</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">process_data</span><span class="p">([</span><span class="n">run</span><span class="p">])</span>
    <span class="c1"># load UB</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">load_isaw_ub</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">run</span><span class="si">}</span><span class="s1">.mat&#39;</span><span class="p">),</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
    <span class="c1"># predict peaks</span>
    <span class="c1"># main</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">predict_peaks</span><span class="p">(</span><span class="n">MinDSpacing</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">WavelengthMin</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
                       <span class="n">ReflectionCondition</span><span class="o">=</span><span class="s1">&#39;Body centred&#39;</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>
    <span class="c1"># satellite</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">predict_peaks</span><span class="p">(</span><span class="n">peak_type</span><span class="o">=</span><span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">SATELLITE</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
                       <span class="n">ModVector1</span><span class="o">=</span><span class="s2">&quot;0.5,0,0&quot;</span><span class="p">,</span> <span class="n">ModVector2</span><span class="o">=</span><span class="s2">&quot;0,0.5,0&quot;</span><span class="p">,</span> <span class="n">ModVector3</span><span class="o">=</span><span class="s2">&quot;0,0,0.5&quot;</span><span class="p">,</span>
                       <span class="n">MaxOrder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CrossTerms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">RequirePeaksOnDetector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">ReflectionCondition</span><span class="o">=</span><span class="s1">&#39;Body centred&#39;</span><span class="p">)</span>
    <span class="c1"># filter satellite peaks by wavelength and d-spacing</span>
    <span class="n">sat_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">PREDICT_SAT</span><span class="p">)</span>
    <span class="n">FilterPeaks</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">sat_peaks</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="n">sat_peaks</span><span class="p">,</span> <span class="n">FilterVariable</span><span class="o">=</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">,</span>
                <span class="n">FilterValue</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">Operator</span><span class="o">=</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="n">FilterPeaks</span><span class="p">(</span><span class="n">InputWorkspace</span><span class="o">=</span><span class="n">sat_peaks</span><span class="p">,</span> <span class="n">OutputWorkspace</span><span class="o">=</span><span class="n">sat_peaks</span><span class="p">,</span> <span class="n">FilterVariable</span><span class="o">=</span><span class="s2">&quot;DSpacing&quot;</span><span class="p">,</span>
                <span class="n">FilterValue</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">Operator</span><span class="o">=</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="c1"># Integrate and save</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">convert_to_MD</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">)</span>  <span class="c1"># convert to QLab (default)</span>
    <span class="k">for</span> <span class="n">peak_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">PREDICT</span><span class="p">,</span> <span class="n">PREDICT_SAT</span><span class="p">]:</span>
        <span class="n">wish</span><span class="o">.</span><span class="n">integrate_data</span><span class="p">(</span><span class="n">INTEGRATION_TYPE</span><span class="o">.</span><span class="n">MD_OPTIMAL_RADIUS</span><span class="p">,</span> <span class="n">peak_type</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="o">**</span><span class="n">intPeaksMDArgs</span><span class="p">)</span>
        <span class="n">wish</span><span class="o">.</span><span class="n">save_peak_table</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">peak_type</span><span class="p">,</span> <span class="n">INTEGRATION_TYPE</span><span class="o">.</span><span class="n">MD_OPTIMAL_RADIUS</span><span class="p">,</span>
                             <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;Jana&quot;</span><span class="p">)</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">delete_run_data</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">del_MD</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># delete raw workspace to save memory</span>

<span class="k">for</span> <span class="n">peak_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">PEAK_TYPE</span><span class="o">.</span><span class="n">PREDICT</span><span class="p">,</span> <span class="n">PREDICT_SAT</span><span class="p">]:</span>
    <span class="n">wish</span><span class="o">.</span><span class="n">save_all_peaks</span><span class="p">(</span><span class="n">peak_type</span><span class="p">,</span> <span class="n">INTEGRATION_TYPE</span><span class="o">.</span><span class="n">MD_OPTIMAL_RADIUS</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">save_format</span><span class="o">=</span><span class="s2">&quot;jana&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Category</strong>: <a class="reference external" href="categories/Techniques.html">Techniques</a></p>
</section>
</section>
</section>
</section>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
      <ul class="nav navbar-nav" style=" float: right;">
      
      
          
            
  <li>
    <a href="ISIS_Reflectometry.html" title="Previous Chapter: ISIS Reflectometry"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; ISIS Reflectometry</span>
    </a>
  </li>
  <li>
    <a href="PolarisedDiffractionILL.html" title="Next Chapter: Data reduction for D7 instrument at the ILL"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Data reductio... &raquo;</span>
    </a>
  </li>
          
       
          <li><a href="#">Back to top</a></li>
       </ul>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>